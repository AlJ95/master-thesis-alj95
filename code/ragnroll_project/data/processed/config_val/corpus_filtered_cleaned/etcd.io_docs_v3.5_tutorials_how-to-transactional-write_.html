<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>How to make multiple writes in a transaction | etcd</title>
<meta name=description content="Guide to making transactional writes"><meta property="og:url" content="https://etcd.io/docs/v3.5/tutorials/how-to-transactional-write/"><meta property="og:site_name" content="etcd"><meta property="og:title" content="How to make multiple writes in a transaction"><meta property="og:description" content="Guide to making transactional writes"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2024-11-24T08:44:43+01:00"><meta itemprop=name content="How to make multiple writes in a transaction"><meta itemprop=description content="Guide to making transactional writes"><meta itemprop=dateModified content="2024-11-24T08:44:43+01:00"><meta itemprop=wordCount content="262"><meta name=twitter:card content="summary"><meta name=twitter:title content="How to make multiple writes in a transaction"><meta name=twitter:description content="Guide to making transactional writes"></head><body class=td-page><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><h1>How to make multiple writes in a transaction</h1><div class=lead>Guide to making transactional writes</div><h2 id=prerequisites>Prerequisites</h2><ul><li>Install <a href=https://etcd.io/docs/v3.5/install/ target=_blank rel=noopener><code>etcd</code> and <code>etcdctl</code></a></li></ul><h2 id=transactions>Transactions</h2><p><code>txn</code> to process all the requests in one transaction:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>etcdctl txn --help
</span></span></code></pre></div><p>Transactions in etcd allow you to execute multiple operations atomically, ensuring that either all operations are applied or none are. This is crucial for maintaining data consistency when performing related updates.</p><h3 id=example>Example</h3><p>Let&rsquo;s consider a scenario where you want to update a user&rsquo;s email and phone number in a single transaction. This ensures that both updates are applied together.</p><p></p><ol><li><p><strong>Set up initial data</strong>: First, create a user with some initial data.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>etcdctl put /users/12345/email <span style=color:#4e9a06>&#34;old.address@johndoe.com&#34;</span>
</span></span><span style=display:flex><span>etcdctl put /users/12345/phone <span style=color:#4e9a06>&#34;123-456-7890&#34;</span>
</span></span></code></pre></div></li><li><p><strong>Perform a transaction</strong>: Update the user&rsquo;s email and phone number in a single transaction.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell><span style=display:flex><span>etcdctl txn --interactive
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>compares:
</span></span><span style=display:flex><span>value<span style=color:#ce5c00;font-weight:700>(</span><span style=color:#4e9a06>&#34;/users/12345/email&#34;</span><span style=color:#ce5c00;font-weight:700>)</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;old.address@johndoe.com&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>success requests <span style=color:#ce5c00;font-weight:700>(</span>get, put, delete<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span>put /users/12345/email <span style=color:#4e9a06>&#34;new.address@johndoe.com&#34;</span>
</span></span><span style=display:flex><span>put /users/12345/phone <span style=color:#4e9a06>&#34;098-765-4321&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>failure requests <span style=color:#ce5c00;font-weight:700>(</span>get, put, delete<span style=color:#ce5c00;font-weight:700>)</span>:
</span></span><span style=display:flex><span>get /users/12345/email
</span></span></code></pre></div><ul><li><strong>Compare</strong>: Check if the current email is &ldquo;<a href=mailto:old.address@johndoe.com>old.address@johndoe.com</a>&rdquo;. This ensures the transaction only proceeds if the data is as expected.</li><li><strong>Success</strong>: If the comparison is true, update both the email and phone number.</li><li><strong>Failure</strong>: If the comparison fails, retrieve the current email to understand why the transaction didn&rsquo;t proceed.</li></ul></li></ol><h3 id=important-considerations>Important considerations</h3><ul><li><strong>Atomicity</strong>: The transaction ensures that both the email and phone number are updated together. If the initial condition (comparison) is not met, neither update is applied.</li><li><strong>Consistency</strong>: Using transactions maintains data consistency, especially when dealing with multiple related updates.</li><li><strong>Avoid multiple puts on the same key</strong>: Do not put multiple values for the same key within a single transaction, as this can lead to unexpected results. Each key should be updated only once per transaction.</li></ul><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p></div><br><div class=td-page-meta__lastmod>Last modified November 24, 2024: <a href=https://github.com/etcd-io/website/commit/fc178bbdd4d8cd6e89b65721e4e7a8c09673d473>docs(tutorial): update example of multiple writes (#908) (fc178bb)</a></div></div></main></div></div></div></body></html>