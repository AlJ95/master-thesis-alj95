<!doctype html>
<html lang="en">
 <head>
  <title>PostgreSQL: Documentation: 13: Chapter 55. Writing a Procedural Language Handler</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="Content-Type" content="text/xhtml; charset=utf-8" />
   
  <meta name="theme-color" content="#336791"/>
  <meta name="copyright" content="The PostgreSQL Global Development Group" />
  <meta property="og:url" content="https://www.postgresql.org/docs/13/plhandler.html" />
  <meta property="og:type" content="article" />
  <meta property="article:published_time" content="2025-02-20T14:13:26" />
  <meta property="og:image" content="https://www.postgresql.org/media/img/about/press/elephant.png" />
  <meta property="og:title" content="Chapter 55. Writing a Procedural Language Handler" />
  <meta property="og:description" content="Chapter&amp;nbsp;55.&amp;nbsp;Writing a Procedural Language Handler All calls to functions that are written in a language other than the current “version …" />
  <meta property="og:site_name" content="PostgreSQL Documentation" />


  

  
  
  
  
  

  

  
  </head>
  <body>
    <div class="container-fluid">
      <div class="row justify-content-md-center">
        <div class="col">
          
          
        </div>
      </div>
      <div class="row justify-content-center pg-shout-box">
        <div class="col text-white text-center">February 20, 2025: <a href="/about/news/postgresql-174-168-1512-1417-and-1320-released-3018/">
  PostgreSQL 17.4, 16.8, 15.12, 14.17, and 13.20 Released!
</a>

</div>
      </div>
    </div>
    <div class="container-fluid margin">
      <div class="row">
        <div id="pgContentWrap" class="col-11">
          <div class="row">
            <div class="col-md-6 mb-2">
              <div class="row">
                <div class="col">
                  <div>
                    <a href="/docs/" title="Documentation">Documentation</a> &rarr; <a href="/docs/13/index.html">PostgreSQL 13</a>
                  </div>
                </div>
              </div>
              
                <div class="row">
                  <div class="col">
                    Supported Versions:
                      
                        
                        
                          <a href="/docs/current/plhandler.html" title="PostgreSQL 17 - Chapter 55. Writing a Procedural Language Handler" >Current</a>
                          (<a href="/docs/17/plhandler.html" title="PostgreSQL 17 - Chapter 55. Writing a Procedural Language Handler" >17</a>)
                        
                      
                         / 
                        
                          <a href="/docs/16/plhandler.html" title="PostgreSQL 16 - Chapter 55. Writing a Procedural Language Handler" >16</a>
                        
                      
                         / 
                        
                          <a href="/docs/15/plhandler.html" title="PostgreSQL 15 - Chapter 55. Writing a Procedural Language Handler" >15</a>
                        
                      
                         / 
                        
                          <a href="/docs/14/plhandler.html" title="PostgreSQL 14 - Chapter 55. Writing a Procedural Language Handler" >14</a>
                        
                      
                         / 
                        
                          <a href="/docs/13/plhandler.html" title="PostgreSQL 13 - Chapter 55. Writing a Procedural Language Handler" class="docs-version-selected">13</a>
                        
                      
                  </div>
                </div>
              
              
                <div class="row">
                  <div class="col">
                    Development Versions:
                    
                      
                      <a href="/docs/devel/plhandler.html" title="PostgreSQL devel - Chapter 55. Writing a Procedural Language Handler"  rel="nofollow">devel</a>
                    
                  </div>
                </div>
              
              
                <div class="row">
                  <div class="col-12">
                    Unsupported versions:
                    
                      
                      <a href="/docs/12/plhandler.html" title="PostgreSQL 12 - Chapter 55. Writing a Procedural Language Handler"  rel="nofollow">12</a>
                    
                       / 
                      <a href="/docs/11/plhandler.html" title="PostgreSQL 11 - Chapter 55. Writing a Procedural Language Handler"  rel="nofollow">11</a>
                    
                       / 
                      <a href="/docs/10/plhandler.html" title="PostgreSQL 10 - Chapter 55. Writing a Procedural Language Handler"  rel="nofollow">10</a>
                    
                       / 
                      <a href="/docs/9.6/plhandler.html" title="PostgreSQL 9.6 - Chapter 55. Writing a Procedural Language Handler"  rel="nofollow">9.6</a>
                    
                       / 
                      <a href="/docs/9.5/plhandler.html" title="PostgreSQL 9.5 - Chapter 55. Writing a Procedural Language Handler"  rel="nofollow">9.5</a>
                    
                       / 
                      <a href="/docs/9.4/plhandler.html" title="PostgreSQL 9.4 - Chapter 55. Writing a Procedural Language Handler"  rel="nofollow">9.4</a>
                    
                       / 
                      <a href="/docs/9.3/plhandler.html" title="PostgreSQL 9.3 - Chapter 55. Writing a Procedural Language Handler"  rel="nofollow">9.3</a>
                    
                       / 
                      <a href="/docs/9.2/plhandler.html" title="PostgreSQL 9.2 - Chapter 55. Writing a Procedural Language Handler"  rel="nofollow">9.2</a>
                    
                       / 
                      <a href="/docs/9.1/plhandler.html" title="PostgreSQL 9.1 - Chapter 55. Writing a Procedural Language Handler"  rel="nofollow">9.1</a>
                    
                       / 
                      <a href="/docs/9.0/plhandler.html" title="PostgreSQL 9.0 - Chapter 55. Writing a Procedural Language Handler"  rel="nofollow">9.0</a>
                    
                       / 
                      <a href="/docs/8.4/plhandler.html" title="PostgreSQL 8.4 - Chapter 55. Writing a Procedural Language Handler"  rel="nofollow">8.4</a>
                    
                       / 
                      <a href="/docs/8.3/plhandler.html" title="PostgreSQL 8.3 - Chapter 55. Writing a Procedural Language Handler"  rel="nofollow">8.3</a>
                    
                       / 
                      <a href="/docs/8.2/plhandler.html" title="PostgreSQL 8.2 - Chapter 55. Writing a Procedural Language Handler"  rel="nofollow">8.2</a>
                    
                       / 
                      <a href="/docs/8.1/plhandler.html" title="PostgreSQL 8.1 - Chapter 55. Writing a Procedural Language Handler"  rel="nofollow">8.1</a>
                    
                       / 
                      <a href="/docs/8.0/plhandler.html" title="PostgreSQL 8.0 - Chapter 55. Writing a Procedural Language Handler"  rel="nofollow">8.0</a>
                    
                       / 
                      <a href="/docs/7.4/plhandler.html" title="PostgreSQL 7.4 - Chapter 55. Writing a Procedural Language Handler"  rel="nofollow">7.4</a>
                    
                  </div>
                </div>
              
            </div>
            <div class="col-md-6 col-lg-5 offset-lg-1">
              <form id="docSearchForm" role="search" method="get" action="/search/">
                <input type="hidden" name="u" value="/docs/13/" />
                <div class="input-group">
                  <input type="text" id="q" name="q" class="form-control" placeholder="Search the documentation for..."/>
                  <span class="input-group-btn">
                    <button class="btn btn-default" type="submit"><i class="fas fa-search"></i></button>
                  </span>
                </div>
              </form>
            </div>
          </div>

          <div id="docContent">
            <div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader">
  <table width="100%" summary="Navigation header">
    <tr>
      <th colspan="5" align="center">Chapter&nbsp;55.&nbsp;Writing a Procedural Language Handler</th>
    </tr>
    <tr>
      <td width="10%" align="left"><a accesskey="p" href="nls-programmer.html" title="54.2.&nbsp;For the Programmer">Prev</a>&nbsp;</td>
      <td width="10%" align="left"><a accesskey="u" href="internals.html" title="Part&nbsp;VII.&nbsp;Internals">Up</a></td>
      <th width="60%" align="center">Part&nbsp;VII.&nbsp;Internals</th>
      <td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 13.20 Documentation">Home</a></td>
      <td width="10%" align="right">&nbsp;<a accesskey="n" href="fdwhandler.html" title="Chapter&nbsp;56.&nbsp;Writing a Foreign Data Wrapper">Next</a></td>
    </tr>
  </table>
  <hr />
</div>
<div class="chapter" id="PLHANDLER">
  <div class="titlepage">
    <div>
      <div>
        <h2 class="title">Chapter&nbsp;55.&nbsp;Writing a Procedural Language Handler</h2>
      </div>
    </div>
  </div><a id="id-1.10.8.2" class="indexterm" name="id-1.10.8.2"></a>
  <p>All calls to functions that are written in a language other than the current <span class="quote">“<span class="quote">version 1</span>”</span> interface for compiled languages (this includes functions in user-defined procedural languages and functions written in SQL) go through a <em class="firstterm">call handler</em> function for the specific language. It is the responsibility of the call handler to execute the function in a meaningful way, such as by interpreting the supplied source text. This chapter outlines how a new procedural language's call handler can be written.</p>
  <p>The call handler for a procedural language is a <span class="quote">“<span class="quote">normal</span>”</span> function that must be written in a compiled language such as C, using the version-1 interface, and registered with <span class="productname">PostgreSQL</span> as taking no arguments and returning the type <code class="type">language_handler</code>. This special pseudo-type identifies the function as a call handler and prevents it from being called directly in SQL commands. For more details on C language calling conventions and dynamic loading, see <a class="xref" href="xfunc-c.html" title="37.10.&nbsp;C-Language Functions">Section&nbsp;37.10</a>.</p>
  <p>The call handler is called in the same way as any other function: It receives a pointer to a <code class="structname">FunctionCallInfoBaseData</code> <code class="type">struct</code> containing argument values and information about the called function, and it is expected to return a <code class="type">Datum</code> result (and possibly set the <code class="structfield">isnull</code> field of the <code class="structname">FunctionCallInfoBaseData</code> structure, if it wishes to return an SQL null result). The difference between a call handler and an ordinary callee function is that the <code class="structfield">flinfo-&gt;fn_oid</code> field of the <code class="structname">FunctionCallInfoBaseData</code> structure will contain the OID of the actual function to be called, not of the call handler itself. The call handler must use this field to determine which function to execute. Also, the passed argument list has been set up according to the declaration of the target function, not of the call handler.</p>
  <p>It's up to the call handler to fetch the entry of the function from the <code class="classname">pg_proc</code> system catalog and to analyze the argument and return types of the called function. The <code class="literal">AS</code> clause from the <code class="command">CREATE FUNCTION</code> command for the function will be found in the <code class="literal">prosrc</code> column of the <code class="classname">pg_proc</code> row. This is commonly source text in the procedural language, but in theory it could be something else, such as a path name to a file, or anything else that tells the call handler what to do in detail.</p>
  <p>Often, the same function is called many times per SQL statement. A call handler can avoid repeated lookups of information about the called function by using the <code class="structfield">flinfo-&gt;fn_extra</code> field. This will initially be <code class="symbol">NULL</code>, but can be set by the call handler to point at information about the called function. On subsequent calls, if <code class="structfield">flinfo-&gt;fn_extra</code> is already non-<code class="symbol">NULL</code> then it can be used and the information lookup step skipped. The call handler must make sure that <code class="structfield">flinfo-&gt;fn_extra</code> is made to point at memory that will live at least until the end of the current query, since an <code class="structname">FmgrInfo</code> data structure could be kept that long. One way to do this is to allocate the extra data in the memory context specified by <code class="structfield">flinfo-&gt;fn_mcxt</code>; such data will normally have the same lifespan as the <code class="structname">FmgrInfo</code> itself. But the handler could also choose to use a longer-lived memory context so that it can cache function definition information across queries.</p>
  <p>When a procedural-language function is invoked as a trigger, no arguments are passed in the usual way, but the <code class="structname">FunctionCallInfoBaseData</code>'s <code class="structfield">context</code> field points at a <code class="structname">TriggerData</code> structure, rather than being <code class="symbol">NULL</code> as it is in a plain function call. A language handler should provide mechanisms for procedural-language functions to get at the trigger information.</p>
  <p>This is a template for a procedural-language handler written in C:</p>
  <pre class="programlisting">
#include "postgres.h"
#include "executor/spi.h"
#include "commands/trigger.h"
#include "fmgr.h"
#include "access/heapam.h"
#include "utils/syscache.h"
#include "catalog/pg_proc.h"
#include "catalog/pg_type.h"

PG_MODULE_MAGIC;

PG_FUNCTION_INFO_V1(plsample_call_handler);

Datum
plsample_call_handler(PG_FUNCTION_ARGS)
{
    Datum          retval;

    if (CALLED_AS_TRIGGER(fcinfo))
    {
        /*
         * Called as a trigger function
         */
        TriggerData    *trigdata = (TriggerData *) fcinfo-&gt;context;

        retval = ...
    }
    else
    {
        /*
         * Called as a function
         */

        retval = ...
    }

    return retval;
}
</pre>
  <p>Only a few thousand lines of code have to be added instead of the dots to complete the call handler.</p>
  <p>After having compiled the handler function into a loadable module (see <a class="xref" href="xfunc-c.html#DFUNC" title="37.10.5.&nbsp;Compiling and Linking Dynamically-Loaded Functions">Section&nbsp;37.10.5</a>), the following commands then register the sample procedural language:</p>
  <pre class="programlisting">
CREATE FUNCTION plsample_call_handler() RETURNS language_handler
    AS '<em class="replaceable"><code>filename</code></em>'
    LANGUAGE C;
CREATE LANGUAGE plsample
    HANDLER plsample_call_handler;
</pre>
  <p>Although providing a call handler is sufficient to create a minimal procedural language, there are two other functions that can optionally be provided to make the language more convenient to use. These are a <em class="firstterm">validator</em> and an <em class="firstterm">inline handler</em>. A validator can be provided to allow language-specific checking to be done during <a class="xref" href="sql-createfunction.html" title="CREATE FUNCTION"><span class="refentrytitle">CREATE FUNCTION</span></a>. An inline handler can be provided to allow the language to support anonymous code blocks executed via the <a class="xref" href="sql-do.html" title="DO"><span class="refentrytitle">DO</span></a> command.</p>
  <p>If a validator is provided by a procedural language, it must be declared as a function taking a single parameter of type <code class="type">oid</code>. The validator's result is ignored, so it is customarily declared to return <code class="type">void</code>. The validator will be called at the end of a <code class="command">CREATE FUNCTION</code> command that has created or updated a function written in the procedural language. The passed-in OID is the OID of the function's <code class="classname">pg_proc</code> row. The validator must fetch this row in the usual way, and do whatever checking is appropriate. First, call <code class="function">CheckFunctionValidatorAccess()</code> to diagnose explicit calls to the validator that the user could not achieve through <code class="command">CREATE FUNCTION</code>. Typical checks then include verifying that the function's argument and result types are supported by the language, and that the function's body is syntactically correct in the language. If the validator finds the function to be okay, it should just return. If it finds an error, it should report that via the normal <code class="function">ereport()</code> error reporting mechanism. Throwing an error will force a transaction rollback and thus prevent the incorrect function definition from being committed.</p>
  <p>Validator functions should typically honor the <a class="xref" href="runtime-config-client.html#GUC-CHECK-FUNCTION-BODIES">check_function_bodies</a> parameter: if it is turned off then any expensive or context-sensitive checking should be skipped. If the language provides for code execution at compilation time, the validator must suppress checks that would induce such execution. In particular, this parameter is turned off by <span class="application">pg_dump</span> so that it can load procedural language functions without worrying about side effects or dependencies of the function bodies on other database objects. (Because of this requirement, the call handler should avoid assuming that the validator has fully checked the function. The point of having a validator is not to let the call handler omit checks, but to notify the user immediately if there are obvious errors in a <code class="command">CREATE FUNCTION</code> command.) While the choice of exactly what to check is mostly left to the discretion of the validator function, note that the core <code class="command">CREATE FUNCTION</code> code only executes <code class="literal">SET</code> clauses attached to a function when <code class="varname">check_function_bodies</code> is on. Therefore, checks whose results might be affected by GUC parameters definitely should be skipped when <code class="varname">check_function_bodies</code> is off, to avoid false failures when restoring a dump.</p>
  <p>If an inline handler is provided by a procedural language, it must be declared as a function taking a single parameter of type <code class="type">internal</code>. The inline handler's result is ignored, so it is customarily declared to return <code class="type">void</code>. The inline handler will be called when a <code class="command">DO</code> statement is executed specifying the procedural language. The parameter actually passed is a pointer to an <code class="structname">InlineCodeBlock</code> struct, which contains information about the <code class="command">DO</code> statement's parameters, in particular the text of the anonymous code block to be executed. The inline handler should execute this code and return.</p>
  <p>It's recommended that you wrap all these function declarations, as well as the <code class="command">CREATE LANGUAGE</code> command itself, into an <em class="firstterm">extension</em> so that a simple <code class="command">CREATE EXTENSION</code> command is sufficient to install the language. See <a class="xref" href="extend-extensions.html" title="37.17.&nbsp;Packaging Related Objects into an Extension">Section&nbsp;37.17</a> for information about writing extensions.</p>
  <p>The procedural languages included in the standard distribution are good references when trying to write your own language handler. Look into the <code class="filename">src/pl</code> subdirectory of the source tree. The <a class="xref" href="sql-createlanguage.html" title="CREATE LANGUAGE"><span class="refentrytitle">CREATE LANGUAGE</span></a> reference page also has some useful details.</p>
</div>
<div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navfooter">
  <hr />
  <table width="100%" summary="Navigation footer">
    <tr>
      <td width="40%" align="left"><a accesskey="p" href="nls-programmer.html" title="54.2.&nbsp;For the Programmer">Prev</a>&nbsp;</td>
      <td width="20%" align="center"><a accesskey="u" href="internals.html" title="Part&nbsp;VII.&nbsp;Internals">Up</a></td>
      <td width="40%" align="right">&nbsp;<a accesskey="n" href="fdwhandler.html" title="Chapter&nbsp;56.&nbsp;Writing a Foreign Data Wrapper">Next</a></td>
    </tr>
    <tr>
      <td width="40%" align="left" valign="top">54.2.&nbsp;For the Programmer&nbsp;</td>
      <td width="20%" align="center"><a accesskey="h" href="index.html" title="PostgreSQL 13.20 Documentation">Home</a></td>
      <td width="40%" align="right" valign="top">&nbsp;Chapter&nbsp;56.&nbsp;Writing a Foreign Data Wrapper</td>
    </tr>
  </table>
</div>

          </div>
          
            <div id="docComments">
              <h2>Submit correction</h2>
              <p>
              If you see anything in the documentation that is not correct, does not match
              your experience with the particular feature or requires further clarification,
              please use
              <a href="/account/comments/new/13/plhandler.html/" rel="nofollow">this form</a>
              to report a documentation issue.
              </p>
            </div>
          
        </div> 
      </div>
    </div>
    
    
    
    
    
    
  </body>
</html>
