<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Upgrade etcd from 3.2 to 3.3 | etcd</title>
<meta name=description content="Processes, checklists, and notes on upgrading etcd from 3.2 to 3.3"><meta property="og:url" content="https://etcd.io/docs/v3.5/upgrades/upgrade_3_3/"><meta property="og:site_name" content="etcd"><meta property="og:title" content="Upgrade etcd from 3.2 to 3.3"><meta property="og:description" content="Processes, checklists, and notes on upgrading etcd from 3.2 to 3.3"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2023-08-19T14:08:40+02:00"><meta itemprop=name content="Upgrade etcd from 3.2 to 3.3"><meta itemprop=description content="Processes, checklists, and notes on upgrading etcd from 3.2 to 3.3"><meta itemprop=dateModified content="2023-08-19T14:08:40+02:00"><meta itemprop=wordCount content="2581"><meta name=twitter:card content="summary"><meta name=twitter:title content="Upgrade etcd from 3.2 to 3.3"><meta name=twitter:description content="Processes, checklists, and notes on upgrading etcd from 3.2 to 3.3"></head><body class=td-page><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><h1>Upgrade etcd from 3.2 to 3.3</h1><div class=lead>Processes, checklists, and notes on upgrading etcd from 3.2 to 3.3</div><p>In the general case, upgrading from etcd 3.2 to 3.3 can be a zero-downtime, rolling upgrade:</p><ul><li>one by one, stop the etcd v3.2 processes and replace them with etcd v3.3 processes</li><li>after running all v3.3 processes, new features in v3.3 are available to the cluster</li></ul><p>Before <a href=#upgrade-procedure>starting an upgrade</a>, read through the rest of this guide to prepare.</p><h3 id=upgrade-checklists>Upgrade checklists</h3><p><strong>NOTE:</strong> When <a href=https://github.com/etcd-io/etcd/issues/9480 target=_blank rel=noopener>migrating from v2 with no v3 data</a>, etcd server v3.2+ panics when etcd restores from existing snapshots but no v3 <code>ETCD_DATA_DIR/member/snap/db</code> file. This happens when the server had migrated from v2 with no previous v3 data. This also prevents accidental v3 data loss (e.g. <code>db</code> file might have been moved). etcd requires that post v3 migration can only happen with v3 data. Do not upgrade to newer v3 versions until v3.0 server contains v3 data.</p><p><strong>NOTE:</strong> if you enable auth and use lease(lease ttl is small), it has a high probability to encounter <a href=https://github.com/etcd-io/etcd/issues/11689 target=_blank rel=noopener>issue</a> that will result in data inconsistency. It is strongly recommended upgrading to 3.2.31+ firstly to fix this problem, and then upgrade to 3.3. In addition, if the user without permission sends a <code>LeaseRevoke</code> request to the 3.3 node during the upgrade process, it may still cause data corruption, so it is best to ensure that your environment doesn&rsquo;t exist such abnormal calls before upgrading, see <a href=https://github.com/etcd-io/etcd/pull/11691 target=_blank rel=noopener>#11691</a> for detail.</p><p>Highlighted breaking changes in 3.3.</p><h4 id=changed-value-type-of-etcd---auto-compaction-retention-flag-to-string>Changed value type of <code>etcd --auto-compaction-retention</code> flag to <code>string</code></h4><p>Changed <code>--auto-compaction-retention</code> flag to <a href=https://github.com/etcd-io/etcd/pull/8563 target=_blank rel=noopener>accept string values</a> with <a href=https://github.com/etcd-io/etcd/issues/8503 target=_blank rel=noopener>finer granularity</a>. Now that <code>--auto-compaction-retention</code> accepts string values, etcd configuration YAML file <code>auto-compaction-retention</code> field must be changed to <code>string</code> type. Previously, <code>--config-file etcd.config.yaml</code> can have <code>auto-compaction-retention: 24</code> field, now must be <code>auto-compaction-retention: "24"</code> or <code>auto-compaction-retention: "24h"</code>. If configured as <code>--auto-compaction-mode periodic --auto-compaction-retention "24h"</code>, the time duration value for <code>--auto-compaction-retention</code> flag must be valid for <a href=https://golang.org/pkg/time/#ParseDuration target=_blank rel=noopener><code>time.ParseDuration</code></a> function in Go.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span># etcd.config.yaml
</span></span><span style=display:flex><span><span style=color:#00a000>+auto-compaction-mode: periodic
</span></span></span><span style=display:flex><span><span style=color:#00a000></span><span style=color:#a40000>-auto-compaction-retention: 24
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+auto-compaction-retention: &#34;24&#34;
</span></span></span><span style=display:flex><span><span style=color:#00a000>+# Or
</span></span></span><span style=display:flex><span><span style=color:#00a000>+auto-compaction-retention: &#34;24h&#34;
</span></span></span></code></pre></div><h4 id=changed-etcdserveretcdserverserverconfig-to-etcdserveretcdserverserverconfig>Changed <code>etcdserver.EtcdServer.ServerConfig</code> to <code>*etcdserver.EtcdServer.ServerConfig</code></h4><p><code>etcdserver.EtcdServer</code> has changed the type of its member field <code>*etcdserver.ServerConfig</code> to <code>etcdserver.ServerConfig</code>. And <code>etcdserver.NewServer</code> now takes <code>etcdserver.ServerConfig</code>, instead of <code>*etcdserver.ServerConfig</code>.</p><p>Before and after (e.g. <a href=https://github.com/kubernetes/kubernetes/blob/release-1.8/test/e2e_node/services/etcd.go#L50-L55 target=_blank rel=noopener>k8s.io/kubernetes/test/e2e_node/services/etcd.go</a>)</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>import &#34;github.com/coreos/etcd/etcdserver&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>type EtcdServer struct {
</span></span><span style=display:flex><span>	*etcdserver.EtcdServer
</span></span><span style=display:flex><span><span style=color:#a40000>-	config *etcdserver.ServerConfig
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+	config etcdserver.ServerConfig
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>func NewEtcd(dataDir string) *EtcdServer {
</span></span><span style=display:flex><span><span style=color:#a40000>-	config := &amp;etcdserver.ServerConfig{
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+	config := etcdserver.ServerConfig{
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>		DataDir: dataDir,
</span></span><span style=display:flex><span>        ...
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	return &amp;EtcdServer{config: config}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>func (e *EtcdServer) Start() error {
</span></span><span style=display:flex><span>	var err error
</span></span><span style=display:flex><span>	e.EtcdServer, err = etcdserver.NewServer(e.config)
</span></span><span style=display:flex><span>    ...
</span></span></code></pre></div><h4 id=added-embedconfiglogoutput-struct>Added <code>embed.Config.LogOutput</code> struct</h4><p><strong>Note that this field has been renamed to <code>embed.Config.LogOutputs</code> in <code>[]string</code> type in v3.4. Please see <a href=/docs/v3.5/upgrades/upgrade_3_4/>v3.4 upgrade guide</a> for more details.</strong></p><p>Field <code>LogOutput</code> is added to <code>embed.Config</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>package embed
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>type Config struct {
</span></span><span style=display:flex><span> 	Debug bool `json:&#34;debug&#34;`
</span></span><span style=display:flex><span> 	LogPkgLevels string `json:&#34;log-package-levels&#34;`
</span></span><span style=display:flex><span><span style=color:#00a000>+	LogOutput string `json:&#34;log-output&#34;`
</span></span></span><span style=display:flex><span><span style=color:#00a000></span> 	...
</span></span></code></pre></div><p>Before gRPC server warnings were logged in etcdserver.</p><pre tabindex=0><code>WARNING: 2017/11/02 11:35:51 grpc: addrConn.resetTransport failed to create client transport: connection error: desc = &#34;transport: Error while dialing dial tcp: operation was canceled&#34;; Reconnecting to {localhost:2379 &lt;nil&gt;}
WARNING: 2017/11/02 11:35:51 grpc: addrConn.resetTransport failed to create client transport: connection error: desc = &#34;transport: Error while dialing dial tcp: operation was canceled&#34;; Reconnecting to {localhost:2379 &lt;nil&gt;}
</code></pre><p>From v3.3, gRPC server logs are disabled by default.</p><p><strong>Note that <code>embed.Config.SetupLogging</code> method has been deprecated in v3.4. Please see <a href=/docs/v3.5/upgrades/upgrade_3_4/>v3.4 upgrade guide</a> for more details.</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;github.com/coreos/etcd/embed&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>cfg</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#ce5c00;font-weight:700>&amp;</span><span style=color:#000>embed</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Config</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>Debug</span><span style=color:#000;font-weight:700>:</span> <span style=color:#204a87;font-weight:700>false</span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000>cfg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SetupLogging</span><span style=color:#000;font-weight:700>()</span>
</span></span></code></pre></div><p>Set <code>embed.Config.Debug</code> field to <code>true</code> to enable gRPC server logs.</p><h4 id=changed-health-endpoint-response>Changed <code>/health</code> endpoint response</h4><p>Previously, <code>[endpoint]:[client-port]/health</code> returned manually marshaled JSON value. 3.3 now defines <a href=https://pkg.go.dev/github.com/etcd-io/etcd/etcdserver/api/etcdhttp#Health target=_blank rel=noopener><code>etcdhttp.Health</code></a> struct.</p><p>Note that in v3.3.0-rc.0, v3.3.0-rc.1, and v3.3.0-rc.2, <code>etcdhttp.Health</code> has boolean type <code>"health"</code> and <code>"errors"</code> fields. For backward compatibilities, we reverted <code>"health"</code> field to <code>string</code> type and removed <code>"errors"</code> field. Further health information will be provided in separate APIs.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl http://localhost:2379/health
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;health&#34;</span>:<span style=color:#4e9a06>&#34;true&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=changed-grpc-gateway-http-endpoints-replaced-v3alpha-with-v3beta>Changed gRPC gateway HTTP endpoints (replaced <code>/v3alpha</code> with <code>/v3beta</code>)</h4><p>Before</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -L http://localhost:2379/v3alpha/kv/put <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -X POST -d <span style=color:#4e9a06>&#39;{&#34;key&#34;: &#34;Zm9v&#34;, &#34;value&#34;: &#34;YmFy&#34;}&#39;</span>
</span></span></code></pre></div><p>After</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -L http://localhost:2379/v3beta/kv/put <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -X POST -d <span style=color:#4e9a06>&#39;{&#34;key&#34;: &#34;Zm9v&#34;, &#34;value&#34;: &#34;YmFy&#34;}&#39;</span>
</span></span></code></pre></div><p>Requests to <code>/v3alpha</code> endpoints will redirect to <code>/v3beta</code>, and <code>/v3alpha</code> will be removed in 3.4 release.</p><h4 id=changed-maximum-request-size-limits>Changed maximum request size limits</h4><p>3.3 now allows custom request size limits for both server and <strong>client side</strong>. In previous versions(v3.2.10, v3.2.11), client response size was limited to only 4 MiB.</p><p>Server-side request limits can be configured with <code>--max-request-bytes</code> flag:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># limits request size to 1.5 KiB</span>
</span></span><span style=display:flex><span>etcd --max-request-bytes <span style=color:#0000cf;font-weight:700>1536</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># client writes exceeding 1.5 KiB will be rejected</span>
</span></span><span style=display:flex><span>etcdctl put foo <span style=color:#ce5c00;font-weight:700>[</span>LARGE VALUE...<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># etcdserver: request is too large</span>
</span></span></code></pre></div><p>Or configure <code>embed.Config.MaxRequestBytes</code> field:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;github.com/coreos/etcd/embed&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;github.com/coreos/etcd/etcdserver/api/v3rpc/rpctypes&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// limit requests to 5 MiB</span>
</span></span><span style=display:flex><span><span style=color:#000>cfg</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>embed</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewConfig</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000>cfg</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>MaxRequestBytes</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>1024</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>1024</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// client writes exceeding 5 MiB will be rejected</span>
</span></span><span style=display:flex><span><span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>cli</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Put</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000;font-weight:700>[</span><span style=color:#000>LARGE</span> <span style=color:#000>VALUE</span><span style=color:#ce5c00;font-weight:700>...</span><span style=color:#000;font-weight:700>])</span>
</span></span><span style=display:flex><span><span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>rpctypes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ErrRequestTooLarge</span>
</span></span></code></pre></div><p><strong>If not specified, server-side limit defaults to 1.5 MiB</strong>.</p><p>Client-side request limits must be configured based on server-side limits.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#8f5902;font-style:italic># limits request size to 1 MiB</span>
</span></span><span style=display:flex><span>etcd --max-request-bytes <span style=color:#0000cf;font-weight:700>1048576</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;github.com/coreos/etcd/clientv3&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>cli</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>_</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>clientv3</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>New</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>clientv3</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Config</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Endpoints</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;127.0.0.1:2379&#34;</span><span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>    <span style=color:#000>MaxCallSendMsgSize</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>1024</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>1024</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span>    <span style=color:#000>MaxCallRecvMsgSize</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>3</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>1024</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#0000cf;font-weight:700>1024</span><span style=color:#000;font-weight:700>,</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>})</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// client writes exceeding &#34;--max-request-bytes&#34; will be rejected from etcd server</span>
</span></span><span style=display:flex><span><span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>cli</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Put</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>strings</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Repeat</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;a&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#ce5c00;font-weight:700>+</span><span style=color:#0000cf;font-weight:700>5</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span><span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>rpctypes</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ErrRequestTooLarge</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// client writes exceeding &#34;MaxCallSendMsgSize&#34; will be rejected from client-side</span>
</span></span><span style=display:flex><span><span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>cli</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Put</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>strings</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Repeat</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;a&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>5</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span><span style=color:#000>err</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;rpc error: code = ResourceExhausted desc = grpc: trying to send message larger than max (5242890 vs. 2097152)&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// some writes under limits</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>for</span> <span style=color:#000>i</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#204a87;font-weight:700>range</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>int</span><span style=color:#000;font-weight:700>{</span><span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>1</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>2</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>3</span><span style=color:#000;font-weight:700>,</span><span style=color:#0000cf;font-weight:700>4</span><span style=color:#000;font-weight:700>}</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>cli</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Put</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>fmt</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Sprintf</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;foo%d&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>i</span><span style=color:#000;font-weight:700>),</span> <span style=color:#000>strings</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Repeat</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;a&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>1</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#ce5c00;font-weight:700>*</span><span style=color:#0000cf;font-weight:700>1024</span><span style=color:#ce5c00;font-weight:700>-</span><span style=color:#0000cf;font-weight:700>500</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>    <span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>        <span style=color:#204a87>panic</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>    <span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// client reads exceeding &#34;MaxCallRecvMsgSize&#34; will be rejected from client-side</span>
</span></span><span style=display:flex><span><span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>cli</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Get</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;foo&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>clientv3</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithPrefix</span><span style=color:#000;font-weight:700>())</span>
</span></span><span style=display:flex><span><span style=color:#000>err</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;rpc error: code = ResourceExhausted desc = grpc: received message larger than max (5240509 vs. 3145728)&#34;</span>
</span></span></code></pre></div><p><strong>If not specified, client-side send limit defaults to 2 MiB (1.5 MiB + gRPC overhead bytes) and receive limit to <code>math.MaxInt32</code></strong>. Please see <a href=https://pkg.go.dev/github.com/etcd-io/etcd/clientv3#Config target=_blank rel=noopener>clientv3 godoc</a> for more detail.</p><h4 id=changed-raw-grpc-client-wrapper-function-signatures>Changed raw gRPC client wrapper function signatures</h4><p>3.3 changes the function signatures of <code>clientv3</code> gRPC client wrapper. This change was needed to support <a href=https://github.com/etcd-io/etcd/pull/9047 target=_blank rel=noopener>custom <code>grpc.CallOption</code> on message size limits</a>.</p><p>Before and after</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a40000>-func NewKVFromKVClient(remote pb.KVClient) KV {
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+func NewKVFromKVClient(remote pb.KVClient, c *Client) KV {
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>
</span></span><span style=display:flex><span><span style=color:#a40000>-func NewClusterFromClusterClient(remote pb.ClusterClient) Cluster {
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+func NewClusterFromClusterClient(remote pb.ClusterClient, c *Client) Cluster {
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>
</span></span><span style=display:flex><span><span style=color:#a40000>-func NewLeaseFromLeaseClient(remote pb.LeaseClient, keepAliveTimeout time.Duration) Lease {
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+func NewLeaseFromLeaseClient(remote pb.LeaseClient, c *Client, keepAliveTimeout time.Duration) Lease {
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>
</span></span><span style=display:flex><span><span style=color:#a40000>-func NewMaintenanceFromMaintenanceClient(remote pb.MaintenanceClient) Maintenance {
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+func NewMaintenanceFromMaintenanceClient(remote pb.MaintenanceClient, c *Client) Maintenance {
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>
</span></span><span style=display:flex><span><span style=color:#a40000>-func NewWatchFromWatchClient(wc pb.WatchClient) Watcher {
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+func NewWatchFromWatchClient(wc pb.WatchClient, c *Client) Watcher {
</span></span></span></code></pre></div><h4 id=changed-clientv3-snapshot-api-error-type>Changed clientv3 <code>Snapshot</code> API error type</h4><p>Previously, clientv3 <code>Snapshot</code> API returned raw [<code>grpc/*status.statusError</code>] type error. v3.3 now translates those errors to corresponding public error types, to be consistent with other APIs.</p><p>Before</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;context&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// reading snapshot with canceled context should error out</span>
</span></span><span style=display:flex><span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cancel</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithCancel</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Background</span><span style=color:#000;font-weight:700>())</span>
</span></span><span style=display:flex><span><span style=color:#000>rc</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>_</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>cli</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Snapshot</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>cancel</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>io</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Copy</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>rc</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>err</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;rpc error: code = Canceled desc = context canceled&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// reading snapshot with deadline exceeded should error out</span>
</span></span><span style=display:flex><span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cancel</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithTimeout</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Background</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Second</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>cancel</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000>rc</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>_</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>cli</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Snapshot</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Sleep</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Second</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>io</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Copy</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>rc</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>err</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Error</span><span style=color:#000;font-weight:700>()</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#4e9a06>&#34;rpc error: code = DeadlineExceeded desc = context deadline exceeded&#34;</span>
</span></span></code></pre></div><p>After</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;context&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// reading snapshot with canceled context should error out</span>
</span></span><span style=display:flex><span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cancel</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithCancel</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Background</span><span style=color:#000;font-weight:700>())</span>
</span></span><span style=display:flex><span><span style=color:#000>rc</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>_</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>cli</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Snapshot</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>cancel</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>io</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Copy</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>rc</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Canceled</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// reading snapshot with deadline exceeded should error out</span>
</span></span><span style=display:flex><span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>cancel</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithTimeout</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Background</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Second</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>cancel</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span><span style=color:#000>rc</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>_</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>cli</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Snapshot</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>ctx</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Sleep</span><span style=color:#000;font-weight:700>(</span><span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Second</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#000;font-weight:700>=</span> <span style=color:#000>io</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Copy</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>f</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>rc</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>DeadlineExceeded</span>
</span></span></code></pre></div><h4 id=changed-etcdctl-lease-timetolive-command-output>Changed <code>etcdctl lease timetolive</code> command output</h4><p>Previously, <code>lease timetolive LEASE_ID</code> command on expired lease prints <code>-1s</code> for remaining seconds. 3.3 now outputs clearer messages.</p><p>Before</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lease 2d8257079fa1bc0c granted with TTL<span style=color:#ce5c00;font-weight:700>(</span>0s<span style=color:#ce5c00;font-weight:700>)</span>, remaining<span style=color:#ce5c00;font-weight:700>(</span>-1s<span style=color:#ce5c00;font-weight:700>)</span>
</span></span></code></pre></div><p>After</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>lease 2d8257079fa1bc0c already expired
</span></span></code></pre></div><h4 id=changed-golangorgxnetcontext-imports>Changed <code>golang.org/x/net/context</code> imports</h4><p><code>clientv3</code> has deprecated <code>golang.org/x/net/context</code>. If a project vendors <code>golang.org/x/net/context</code> in other code (e.g. etcd generated protocol buffer code) and imports <code>github.com/coreos/etcd/clientv3</code>, it requires Go 1.9+ to compile.</p><p>Before</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;golang.org/x/net/context&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>cli</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Put</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Background</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#4e9a06>&#34;f&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;v&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><p>After</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;context&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>cli</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Put</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Background</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#4e9a06>&#34;f&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;v&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><h4 id=changed-grpc-dependency>Changed gRPC dependency</h4><p>3.3 now requires <a href=https://github.com/grpc/grpc-go/releases target=_blank rel=noopener>grpc/grpc-go</a> <code>v1.7.5</code>.</p><h5 id=deprecated-grpcloglogger>Deprecated <code>grpclog.Logger</code></h5><p><code>grpclog.Logger</code> has been deprecated in favor of <a href=https://github.com/grpc/grpc-go/blob/master/grpclog/loggerv2.go target=_blank rel=noopener><code>grpclog.LoggerV2</code></a>. <code>clientv3.Logger</code> is now <code>grpclog.LoggerV2</code>.</p><p>Before</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;github.com/coreos/etcd/clientv3&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>clientv3</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SetLogger</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>New</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>os</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Stderr</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;grpc: &#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#0000cf;font-weight:700>0</span><span style=color:#000;font-weight:700>))</span>
</span></span></code></pre></div><p>After</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;github.com/coreos/etcd/clientv3&#34;</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#4e9a06>&#34;google.golang.org/grpc/grpclog&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>clientv3</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>SetLogger</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>grpclog</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewLoggerV2</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>os</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Stderr</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>os</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Stderr</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>os</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Stderr</span><span style=color:#000;font-weight:700>))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// log.New above cannot be used (not implement grpclog.LoggerV2 interface)</span>
</span></span></code></pre></div><h5 id=deprecated-grpcerrclientconntimeout>Deprecated <code>grpc.ErrClientConnTimeout</code></h5><p>Previously, <code>grpc.ErrClientConnTimeout</code> error is returned on client dial time-outs. 3.3 instead returns <code>context.DeadlineExceeded</code> (see <a href=https://github.com/etcd-io/etcd/issues/8504 target=_blank rel=noopener>#8504</a>).</p><p>Before</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// expect dial time-out on ipv4 blackhole</span>
</span></span><span style=display:flex><span><span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>clientv3</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>New</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>clientv3</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Config</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Endpoints</span><span style=color:#000;font-weight:700>:</span>   <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;http://254.0.0.1:12345&#34;</span><span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>    <span style=color:#000>DialTimeout</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Second</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>})</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>grpc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ErrClientConnTimeout</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// handle errors</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>After</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000>_</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>clientv3</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>New</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>clientv3</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Config</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Endpoints</span><span style=color:#000;font-weight:700>:</span>   <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;http://254.0.0.1:12345&#34;</span><span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span>    <span style=color:#000>DialTimeout</span><span style=color:#000;font-weight:700>:</span> <span style=color:#0000cf;font-weight:700>2</span> <span style=color:#ce5c00;font-weight:700>*</span> <span style=color:#000>time</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Second</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>})</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>==</span> <span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>DeadlineExceeded</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>	<span style=color:#8f5902;font-style:italic>// handle errors</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=changed-official-container-registry>Changed official container registry</h4><p>etcd now uses <a href=https://gcr.io/etcd-development/etcd target=_blank rel=noopener><code>gcr.io/etcd-development/etcd</code></a> as a primary container registry, and <a href=https://quay.io/coreos/etcd target=_blank rel=noopener><code>quay.io/coreos/etcd</code></a> as secondary.</p><p>Before</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker pull quay.io/coreos/etcd:v3.2.5
</span></span></code></pre></div><p>After</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>docker pull gcr.io/etcd-development/etcd:v3.3.0
</span></span></code></pre></div><h3 id=upgrades-to--v3314>Upgrades to >= v3.3.14</h3><p><a href=https://github.com/etcd-io/etcd/releases/tag/v3.3.14 target=_blank rel=noopener>v3.3.14</a> had to include some features from 3.4, while trying to minimize the difference between client balancer implementation. This release fixes <a href=https://github.com/kubernetes/kubernetes/issues/72102 target=_blank rel=noopener>&ldquo;kube-apiserver 1.13.x refuses to work when first etcd-server is not available&rdquo; (kubernetes#72102)</a>.</p><p><code>grpc.ErrClientConnClosing</code> has been <a href=https://github.com/grpc/grpc-go/pull/1854 target=_blank rel=noopener>deprecated in gRPC >= 1.10</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>import (
</span></span><span style=display:flex><span><span style=color:#00a000>+	&#34;go.etcd.io/etcd/clientv3&#34;
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>
</span></span><span style=display:flex><span>	&#34;google.golang.org/grpc&#34;
</span></span><span style=display:flex><span><span style=color:#00a000>+	&#34;google.golang.org/grpc/codes&#34;
</span></span></span><span style=display:flex><span><span style=color:#00a000>+	&#34;google.golang.org/grpc/status&#34;
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>_, err := kvc.Get(ctx, &#34;a&#34;)
</span></span><span style=display:flex><span><span style=color:#a40000>-if err == grpc.ErrClientConnClosing {
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+if clientv3.IsConnCanceled(err) {
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>
</span></span><span style=display:flex><span>// or
</span></span><span style=display:flex><span><span style=color:#00a000>+s, ok := status.FromError(err)
</span></span></span><span style=display:flex><span><span style=color:#00a000>+if ok {
</span></span></span><span style=display:flex><span><span style=color:#00a000>+  if s.Code() == codes.Canceled
</span></span></span></code></pre></div><p><a href=/docs/v3.5/learning/design-client/>The new client balancer</a> uses an asynchronous resolver to pass endpoints to the gRPC dial function. As a result, <a href=https://github.com/etcd-io/etcd/releases/tag/v3.3.14 target=_blank rel=noopener>v3.3.14</a> or later requires <code>grpc.WithBlock</code> dial option to wait until the underlying connection is up.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>import (
</span></span><span style=display:flex><span>	&#34;time&#34;
</span></span><span style=display:flex><span>	&#34;go.etcd.io/etcd/clientv3&#34;
</span></span><span style=display:flex><span><span style=color:#00a000>+	&#34;google.golang.org/grpc&#34;
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a000>+// &#34;grpc.WithBlock()&#34; to block until the underlying connection is up
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>ccfg := clientv3.Config{
</span></span><span style=display:flex><span>  Endpoints:            []string{&#34;localhost:2379&#34;},
</span></span><span style=display:flex><span>  DialTimeout:          time.Second,
</span></span><span style=display:flex><span><span style=color:#00a000>+ DialOptions:          []grpc.DialOption{grpc.WithBlock()},
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>  DialKeepAliveTime:    time.Second,
</span></span><span style=display:flex><span>  DialKeepAliveTimeout: 500 * time.Millisecond,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>Please see <a href=https://github.com/etcd-io/etcd/blob/master/CHANGELOG-3.3.md target=_blank rel=noopener>CHANGELOG</a> for a full list of changes.</p><h3 id=server-upgrade-checklists>Server upgrade checklists</h3><h4 id=upgrade-requirements>Upgrade requirements</h4><p>To upgrade an existing etcd deployment to 3.3, the running cluster must be 3.2 or greater. If it&rsquo;s before 3.2, please <a href=../upgrade_3_2/>upgrade to 3.2</a> before upgrading to 3.3.</p><p>Also, to ensure a smooth rolling upgrade, the running cluster must be healthy. Check the health of the cluster by using the <code>etcdctl endpoint health</code> command before proceeding.</p><h4 id=preparation>Preparation</h4><p>Before upgrading etcd, always test the services relying on etcd in a staging environment before deploying the upgrade to the production environment.</p><p>Before beginning, <a href=../../op-guide/maintenance/#snapshot-backup>backup the etcd data</a>. Should something go wrong with the upgrade, it is possible to use this backup to <a href=#downgrade>downgrade</a> back to existing etcd version. Please note that the <code>snapshot</code> command only backs up the v3 data. For v2 data, see <a href=/docs/v2.3/admin_guide/#backing-up-the-datastore>backing up v2 datastore</a>.</p><h4 id=mixed-versions>Mixed versions</h4><p>While upgrading, an etcd cluster supports mixed versions of etcd members, and operates with the protocol of the lowest common version. The cluster is only considered upgraded once all of its members are upgraded to version 3.3. Internally, etcd members negotiate with each other to determine the overall cluster version, which controls the reported version and the supported features.</p><h4 id=limitations>Limitations</h4><p>Note: If the cluster only has v3 data and no v2 data, it is not subject to this limitation.</p><p>If the cluster is serving a v2 data set larger than 50MB, each newly upgraded member may take up to two minutes to catch up with the existing cluster. Check the size of a recent snapshot to estimate the total data size. In other words, it is safest to wait for 2 minutes between upgrading each member.</p><p>For a much larger total data size, 100MB or more , this one-time process might take even more time. Administrators of very large etcd clusters of this magnitude can feel free to contact the <a href=https://groups.google.com/g/etcd-dev target=_blank rel=noopener>etcd team</a> before upgrading, and we&rsquo;ll be happy to provide advice on the procedure.</p><h4 id=downgrade>Downgrade</h4><p>If all members have been upgraded to v3.3, the cluster will be upgraded to v3.3, and downgrade from this completed state is <strong>not possible</strong>. If any single member is still v3.2, however, the cluster and its operations remains &ldquo;v3.2&rdquo;, and it is possible from this mixed cluster state to return to using a v3.2 etcd binary on all members.</p><p>Please <a href=../../op-guide/maintenance/#snapshot-backup>backup the data directory</a> of all etcd members to make downgrading the cluster possible even after it has been completely upgraded.</p><h3 id=upgrade-procedure>Upgrade procedure</h3><p>This example shows how to upgrade a 3-member v3.2 etcd cluster running on a local machine.</p><h4 id=1-check-upgrade-requirements>1. Check upgrade requirements</h4><p>Is the cluster healthy and running v3.2.x?</p><pre tabindex=0><code>$ ETCDCTL_API=3 etcdctl endpoint health --endpoints=localhost:2379,localhost:22379,localhost:32379
localhost:2379 is healthy: successfully committed proposal: took = 6.600684ms
localhost:22379 is healthy: successfully committed proposal: took = 8.540064ms
localhost:32379 is healthy: successfully committed proposal: took = 8.763432ms

$ curl http://localhost:2379/version
{&#34;etcdserver&#34;:&#34;3.2.7&#34;,&#34;etcdcluster&#34;:&#34;3.2.0&#34;}
</code></pre><h4 id=2-stop-the-existing-etcd-process>2. Stop the existing etcd process</h4><p>When each etcd process is stopped, expected errors will be logged by other cluster members. This is normal since a cluster member connection has been (temporarily) broken:</p><pre tabindex=0><code>14:13:31.491746 I | raft: c89feb932daef420 [term 3] received MsgTimeoutNow from 6d4f535bae3ab960 and starts an election to get leadership.
14:13:31.491769 I | raft: c89feb932daef420 became candidate at term 4
14:13:31.491788 I | raft: c89feb932daef420 received MsgVoteResp from c89feb932daef420 at term 4
14:13:31.491797 I | raft: c89feb932daef420 [logterm: 3, index: 9] sent MsgVote request to 6d4f535bae3ab960 at term 4
14:13:31.491805 I | raft: c89feb932daef420 [logterm: 3, index: 9] sent MsgVote request to 9eda174c7df8a033 at term 4
14:13:31.491815 I | raft: raft.node: c89feb932daef420 lost leader 6d4f535bae3ab960 at term 4
14:13:31.524084 I | raft: c89feb932daef420 received MsgVoteResp from 6d4f535bae3ab960 at term 4
14:13:31.524108 I | raft: c89feb932daef420 [quorum:2] has received 2 MsgVoteResp votes and 0 vote rejections
14:13:31.524123 I | raft: c89feb932daef420 became leader at term 4
14:13:31.524136 I | raft: raft.node: c89feb932daef420 elected leader c89feb932daef420 at term 4
14:13:31.592650 W | rafthttp: lost the TCP streaming connection with peer 6d4f535bae3ab960 (stream MsgApp v2 reader)
14:13:31.592825 W | rafthttp: lost the TCP streaming connection with peer 6d4f535bae3ab960 (stream Message reader)
14:13:31.693275 E | rafthttp: failed to dial 6d4f535bae3ab960 on stream Message (dial tcp [::1]:2380: getsockopt: connection refused)
14:13:31.693289 I | rafthttp: peer 6d4f535bae3ab960 became inactive
14:13:31.936678 W | rafthttp: lost the TCP streaming connection with peer 6d4f535bae3ab960 (stream Message writer)
</code></pre><p>It&rsquo;s a good idea at this point to <a href=../../op-guide/maintenance/#snapshot-backup>backup the etcd data</a> to provide a downgrade path should any problems occur:</p><pre tabindex=0><code>$ etcdctl snapshot save backup.db
</code></pre><h4 id=3-drop-in-etcd-v33-binary-and-start-the-new-etcd-process>3. Drop-in etcd v3.3 binary and start the new etcd process</h4><p>The new v3.3 etcd will publish its information to the cluster:</p><pre tabindex=0><code>14:14:25.363225 I | etcdserver: published {Name:s1 ClientURLs:[http://localhost:2379]} to cluster a9ededbffcb1b1f1
</code></pre><p>Verify that each member, and then the entire cluster, becomes healthy with the new v3.3 etcd binary:</p><pre tabindex=0><code>$ ETCDCTL_API=3 /etcdctl endpoint health --endpoints=localhost:2379,localhost:22379,localhost:32379
localhost:22379 is healthy: successfully committed proposal: took = 5.540129ms
localhost:32379 is healthy: successfully committed proposal: took = 7.321771ms
localhost:2379 is healthy: successfully committed proposal: took = 10.629901ms
</code></pre><p>Upgraded members will log warnings like the following until the entire cluster is upgraded. This is expected and will cease after all etcd cluster members are upgraded to v3.3:</p><pre tabindex=0><code>14:15:17.071804 W | etcdserver: member c89feb932daef420 has a higher version 3.3.0
14:15:21.073110 W | etcdserver: the local etcd version 3.2.7 is not up-to-date
14:15:21.073142 W | etcdserver: member 6d4f535bae3ab960 has a higher version 3.3.0
14:15:21.073157 W | etcdserver: the local etcd version 3.2.7 is not up-to-date
14:15:21.073164 W | etcdserver: member c89feb932daef420 has a higher version 3.3.0
</code></pre><h4 id=4-repeat-step-2-to-step-3-for-all-other-members>4. Repeat step 2 to step 3 for all other members</h4><h4 id=5-finish>5. Finish</h4><p>When all members are upgraded, the cluster will report upgrading to 3.3 successfully:</p><pre tabindex=0><code>14:15:54.536901 N | etcdserver/membership: updated the cluster version from 3.2 to 3.3
14:15:54.537035 I | etcdserver/api: enabled capabilities for version 3.3
</code></pre><pre tabindex=0><code>$ ETCDCTL_API=3 /etcdctl endpoint health --endpoints=localhost:2379,localhost:22379,localhost:32379
localhost:2379 is healthy: successfully committed proposal: took = 2.312897ms
localhost:22379 is healthy: successfully committed proposal: took = 2.553476ms
localhost:32379 is healthy: successfully committed proposal: took = 2.517902ms
</code></pre><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p></div><br><div class=td-page-meta__lastmod>Last modified August 19, 2023: <a href=https://github.com/etcd-io/website/commit/cd8b01f2f96d06f92d79e45e8c189606e9b81239>etcd-io/website#479 Use new and better canonical link to Google Groups (cd8b01f)</a></div></div></main></div></div></div></body></html>