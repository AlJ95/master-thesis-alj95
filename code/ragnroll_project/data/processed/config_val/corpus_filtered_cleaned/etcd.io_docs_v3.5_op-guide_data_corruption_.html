<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Data Corruption | etcd</title>
<meta name=description content="etcd data corruption and recovery"><meta property="og:url" content="https://etcd.io/docs/v3.5/op-guide/data_corruption/"><meta property="og:site_name" content="etcd"><meta property="og:title" content="Data Corruption"><meta property="og:description" content="etcd data corruption and recovery"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2023-09-17T19:23:48+02:00"><meta itemprop=name content="Data Corruption"><meta itemprop=description content="etcd data corruption and recovery"><meta itemprop=dateModified content="2023-09-17T19:23:48+02:00"><meta itemprop=wordCount content="438"><meta name=twitter:card content="summary"><meta name=twitter:title content="Data Corruption"><meta name=twitter:description content="etcd data corruption and recovery"></head><body class=td-page><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><h1>Data Corruption</h1><div class=lead>etcd data corruption and recovery</div><p>etcd has built in automated data corruption detection to prevent member state from diverging.</p><h2 id=enabling-data-corruption-detection>Enabling data corruption detection</h2><p>Data corruption detection can be done using:</p><ul><li>Initial check, enabled with <code>--experimental-initial-corrupt-check</code> flag.</li><li>Periodic check of:<ul><li>Compacted revision hash, enabled with <code>--experimental-compact-hash-check-enabled</code> flag.</li><li>Latest revision hash, enabled with <code>--experimental-corrupt-check-time</code> flag.</li></ul></li></ul><p>Initial check will be executed during bootstrap of etcd member.
Member will compare its persistent state vs other members and exit if there is a mismatch.</p><p>Both periodic check will be executed by the cluster leader in a cluster that is already running.
Leader will compare its persistent state vs other members and raise a CORRUPT ALARM if there is a mismatch.
Both checks serve the same purpose, however they are both worth enabling to balance performance and time to detection.</p><ul><li>Compacted revision hash check - requires regular compaction, minimal performance cost, handles slow followers.</li><li>Latest revision hash check - high performance cost, doesn&rsquo;t handle slow followers or frequent compactions.</li></ul><h3 id=compacted-revision-hash-check>Compacted revision hash check</h3><p>When enabled using <code>--experimental-compact-hash-check-enabled</code> flag, check will be executed once every minute.
This can be adjusted using <code>--experimental-compact-hash-check-time</code> flag using format: <code>1m</code> - every minute, <code>1h</code> - evey hour.
This check extends compaction to also calculate checksum that can be compared between cluster members.
Doesn&rsquo;t cause additional database scan making it very cheap, but requiring a regular compaction in cluster.</p><h3 id=latest-revision-hash-check>Latest revision hash check</h3><p>Enabled using <code>--experimental-corrupt-check-time</code> flag, requires providing an execution period in format: <code>1m</code> - every minute, <code>1h</code> - evey hour.
Recommended period is a couple of hours due to a high performance cost.
Running a check requires computing a checksum by scanning entire etcd content at given revision.</p><h2 id=restoring-a-corrupted-member>Restoring a corrupted member</h2><p>There are three ways to restore a corrupted member:</p><ul><li>Purge member persistent state</li><li>Replace member</li><li>Restore whole cluster</li></ul><p>After the corrupted member is restored, CORRUPT ALARM can be removed.</p><h3 id=purge-member-persistent-state>Purge member persistent state</h3><p>Members state can be purged by:</p><ol><li>Stopping the etcd instance.</li><li>Backing up etcd data directory.</li><li>Moving out the <code>snap</code> subdirectory from the etcd data directory.</li><li>Starting <code>etcd</code> with <code>--initial-cluster-state=existing</code> and cluster members listed in <code>--initial-cluster</code>.</li></ol><p>Etcd member is expected to download up-to-date snapshot from the leader.</p><h3 id=replace-member>Replace member</h3><p>Member can be replaced by:</p><ol><li>Stopping the etcd instance.</li><li>Backing up the etcd data directory.</li><li>Removing the data directory.</li><li>Removing the member from cluster by running <code>etcdctl member remove</code>.</li><li>Adding it back by running <code>etcdctl member add</code></li><li>Starting <code>etcd</code> with <code>--initial-cluster-state=existing</code> and cluster members listed in <code>--initial-cluster</code>.</li></ol><h3 id=restore-whole-cluster>Restore whole cluster</h3><p>Cluster can be restored by saving a snapshot from current leader and restoring it to all members.
Run <code>etcdctl snapshot save</code> against the leader and follow <a href=/docs/v3.5/op-guide/recovery>restoring a cluster procedure</a>.</p><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p></div><br><div class=td-page-meta__lastmod>Last modified September 17, 2023: <a href=https://github.com/etcd-io/website/commit/070ed102d4a98c23efe4095f90b8c332d9c0f7a7>Change from it's to its (070ed10)</a></div></div></main></div></div></div></body></html>