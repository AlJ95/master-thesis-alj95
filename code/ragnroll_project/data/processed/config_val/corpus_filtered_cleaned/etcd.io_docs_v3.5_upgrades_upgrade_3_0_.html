<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Upgrade etcd from 2.3 to 3.0 | etcd</title>
<meta name=description content="Processes, checklists, and notes on upgrading etcd from 2.3 to 3.0"><meta property="og:url" content="https://etcd.io/docs/v3.5/upgrades/upgrade_3_0/"><meta property="og:site_name" content="etcd"><meta property="og:title" content="Upgrade etcd from 2.3 to 3.0"><meta property="og:description" content="Processes, checklists, and notes on upgrading etcd from 2.3 to 3.0"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2023-08-19T14:08:40+02:00"><meta itemprop=name content="Upgrade etcd from 2.3 to 3.0"><meta itemprop=description content="Processes, checklists, and notes on upgrading etcd from 2.3 to 3.0"><meta itemprop=dateModified content="2023-08-19T14:08:40+02:00"><meta itemprop=wordCount content="1010"><meta name=twitter:card content="summary"><meta name=twitter:title content="Upgrade etcd from 2.3 to 3.0"><meta name=twitter:description content="Processes, checklists, and notes on upgrading etcd from 2.3 to 3.0"></head><body class=td-page><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><h1>Upgrade etcd from 2.3 to 3.0</h1><div class=lead>Processes, checklists, and notes on upgrading etcd from 2.3 to 3.0</div><p>In the general case, upgrading from etcd 2.3 to 3.0 can be a zero-downtime, rolling upgrade:</p><ul><li>one by one, stop the etcd v2.3 processes and replace them with etcd v3.0 processes</li><li>after running all v3.0 processes, new features in v3.0 are available to the cluster</li></ul><p>Before <a href=#upgrade-procedure>starting an upgrade</a>, read through the rest of this guide to prepare.</p><h3 id=upgrade-checklists>Upgrade checklists</h3><p><strong>NOTE:</strong> When <a href=https://github.com/etcd-io/etcd/issues/9480 target=_blank rel=noopener>migrating from v2 with no v3 data</a>, etcd server v3.2+ panics when etcd restores from existing snapshots but no v3 <code>ETCD_DATA_DIR/member/snap/db</code> file. This happens when the server had migrated from v2 with no previous v3 data. This also prevents accidental v3 data loss (e.g. <code>db</code> file might have been moved). etcd requires that post v3 migration can only happen with v3 data. Do not upgrade to newer v3 versions until v3.0 server contains v3 data.</p><h4 id=upgrade-requirements>Upgrade requirements</h4><p>To upgrade an existing etcd deployment to 3.0, the running cluster must be 2.3 or greater. If it&rsquo;s before 2.3, please upgrade to <a href=https://github.com/etcd-io/etcd/releases/tag/v2.3.8 target=_blank rel=noopener>2.3</a> before upgrading to 3.0.</p><p>Also, to ensure a smooth rolling upgrade, the running cluster must be healthy. Check the health of the cluster by using the <code>etcdctl cluster-health</code> command before proceeding.</p><h4 id=preparation>Preparation</h4><p>Before upgrading etcd, always test the services relying on etcd in a staging environment before deploying the upgrade to the production environment.</p><p>Before beginning, <a href=/docs/v2.3/admin_guide#backing-up-the-datastore>backup the etcd data directory</a>. Should something go wrong with the upgrade, it is possible to use this backup to <a href=#downgrade>downgrade</a> back to existing etcd version.</p><h4 id=mixed-versions>Mixed versions</h4><p>While upgrading, an etcd cluster supports mixed versions of etcd members, and operates with the protocol of the lowest common version. The cluster is only considered upgraded once all of its members are upgraded to version 3.0. Internally, etcd members negotiate with each other to determine the overall cluster version, which controls the reported version and the supported features.</p><h4 id=limitations>Limitations</h4><p>It might take up to 2 minutes for the newly upgraded member to catch up with the existing cluster when the total data size is larger than 50MB. Check the size of a recent snapshot to estimate the total data size. In other words, it is safest to wait for 2 minutes between upgrading each member.</p><p>For a much larger total data size, 100MB or more , this one-time process might take even more time. Administrators of very large etcd clusters of this magnitude can feel free to contact the <a href=https://groups.google.com/g/etcd-dev target=_blank rel=noopener>etcd team</a> before upgrading, and we’ll be happy to provide advice on the procedure.</p><h4 id=downgrade>Downgrade</h4><p>If all members have been upgraded to v3.0, the cluster will be upgraded to v3.0, and downgrade from this completed state is <strong>not possible</strong>. If any single member is still v2.3, however, the cluster and its operations remains “v2.3”, and it is possible from this mixed cluster state to return to using a v2.3 etcd binary on all members.</p><p>Please <a href=/docs/v2.3/admin_guide#backing-up-the-datastore>backup the data directory</a> of all etcd members to make downgrading the cluster possible even after it has been completely upgraded.</p><h3 id=upgrade-procedure>Upgrade procedure</h3><p>This example details the upgrade of a three-member v2.3 etcd cluster running on a local machine.</p><h4 id=1-check-upgrade-requirements>1. Check upgrade requirements.</h4><p>Is the cluster healthy and running v.2.3.x?</p><pre tabindex=0><code>$ etcdctl cluster-health
member 6e3bd23ae5f1eae0 is healthy: got healthy result from http://localhost:22379
member 924e2e83e93f2560 is healthy: got healthy result from http://localhost:32379
member 8211f1d0f64f3269 is healthy: got healthy result from http://localhost:12379
cluster is healthy

$ curl http://localhost:2379/version
{&#34;etcdserver&#34;:&#34;2.3.x&#34;,&#34;etcdcluster&#34;:&#34;2.3.8&#34;}
</code></pre><h4 id=2-stop-the-existing-etcd-process>2. Stop the existing etcd process</h4><p>When each etcd process is stopped, expected errors will be logged by other cluster members. This is normal since a cluster member connection has been (temporarily) broken:</p><pre tabindex=0><code>2016-06-27 15:21:48.624124 E | rafthttp: failed to dial 8211f1d0f64f3269 on stream Message (dial tcp 127.0.0.1:12380: getsockopt: connection refused)
2016-06-27 15:21:48.624175 I | rafthttp: the connection with 8211f1d0f64f3269 became inactive
</code></pre><p>It’s a good idea at this point to <a href=/docs/v2.3/admin_guide#backing-up-the-datastore>backup the etcd data directory</a> to provide a downgrade path should any problems occur:</p><pre tabindex=0><code>$ etcdctl backup \
      --data-dir /var/lib/etcd \
      --backup-dir /tmp/etcd_backup
</code></pre><h4 id=3-drop-in-etcd-v30-binary-and-start-the-new-etcd-process>3. Drop-in etcd v3.0 binary and start the new etcd process</h4><p>The new v3.0 etcd will publish its information to the cluster:</p><pre tabindex=0><code>09:58:25.938673 I | etcdserver: published {Name:infra1 ClientURLs:[http://localhost:12379]} to cluster 524400597fb1d5f6
</code></pre><p>Verify that each member, and then the entire cluster, becomes healthy with the new v3.0 etcd binary:</p><pre tabindex=0><code>$ etcdctl cluster-health
member 6e3bd23ae5f1eae0 is healthy: got healthy result from http://localhost:22379
member 924e2e83e93f2560 is healthy: got healthy result from http://localhost:32379
member 8211f1d0f64f3269 is healthy: got healthy result from http://localhost:12379
cluster is healthy
</code></pre><p>Upgraded members will log warnings like the following until the entire cluster is upgraded. This is expected and will cease after all etcd cluster members are upgraded to v3.0:</p><pre tabindex=0><code>2016-06-27 15:22:05.679644 W | etcdserver: the local etcd version 2.3.7 is not up-to-date
2016-06-27 15:22:05.679660 W | etcdserver: member 8211f1d0f64f3269 has a higher version 3.0.0
</code></pre><h4 id=4-repeat-step-2-to-step-3-for-all-other-members>4. Repeat step 2 to step 3 for all other members</h4><h4 id=5-finish>5. Finish</h4><p>When all members are upgraded, the cluster will report upgrading to 3.0 successfully:</p><pre tabindex=0><code>2016-06-27 15:22:19.873751 N | membership: updated the cluster version from 2.3 to 3.0
2016-06-27 15:22:19.914574 I | api: enabled capabilities for version 3.0.0
</code></pre><pre tabindex=0><code>$ ETCDCTL_API=3 etcdctl endpoint health
127.0.0.1:12379 is healthy: successfully committed proposal: took = 18.440155ms
127.0.0.1:32379 is healthy: successfully committed proposal: took = 13.651368ms
127.0.0.1:22379 is healthy: successfully committed proposal: took = 18.513301ms
</code></pre><h2 id=further-considerations>Further considerations</h2><ul><li>etcdctl environment variables have been updated. If <code>ETCDCTL_API=2 etcdctl cluster-health</code> works properly but <code>ETCDCTL_API=3 etcdctl endpoints health</code> responds with <code>Error: grpc: timed out when dialing</code>, be sure to use the <a href=https://github.com/etcd-io/etcd/tree/master/etcdctl#etcdctl target=_blank rel=noopener>new variable names</a>.</li></ul><h2 id=known-issues>Known Issues</h2><ul><li>etcd &lt; v3.1 does not work properly if built with Go > v1.7. See <a href=https://github.com/etcd-io/etcd/issues/6951 target=_blank rel=noopener>Issue 6951</a> for additional information.</li><li>If an error such as <code>transport: http2Client.notifyError got notified that the client transport was broken unexpected EOF.</code> shows up in the etcd server logs, be sure etcd is a pre-built release or built with (etcd v3.1+ & go v1.7+) or (etcd &lt;v3.1 & go v1.6.x).</li><li>Adding a v3 node to v2.3 cluster during upgrades is not supported and could trigger panics. See <a href=https://github.com/etcd-io/etcd/issues/7429 target=_blank rel=noopener>Issue 7249</a> for additional information. Mixed versions of etcd members are only allowed during v3 migration. Finish upgrades before making any membership changes.</li></ul><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p></div><br><div class=td-page-meta__lastmod>Last modified August 19, 2023: <a href=https://github.com/etcd-io/website/commit/cd8b01f2f96d06f92d79e45e8c189606e9b81239>etcd-io/website#479 Use new and better canonical link to Google Groups (cd8b01f)</a></div></div></main></div></div></div></body></html>