<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Discovery service protocol | etcd</title>
<meta name=description content="Discover other etcd members in a cluster bootstrap phase"><meta property="og:url" content="https://etcd.io/docs/v3.5/dev-guide/discovery_protocol/"><meta property="og:site_name" content="etcd"><meta property="og:title" content="Discovery service protocol"><meta property="og:description" content="Discover other etcd members in a cluster bootstrap phase"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2022-03-16T14:22:42+01:00"><meta itemprop=name content="Discovery service protocol"><meta itemprop=description content="Discover other etcd members in a cluster bootstrap phase"><meta itemprop=dateModified content="2022-03-16T14:22:42+01:00"><meta itemprop=wordCount content="753"><meta name=twitter:card content="summary"><meta name=twitter:title content="Discovery service protocol"><meta name=twitter:description content="Discover other etcd members in a cluster bootstrap phase"></head><body class=td-page><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><h1>Discovery service protocol</h1><div class=lead>Discover other etcd members in a cluster bootstrap phase</div><p>Discovery service protocol helps new etcd member to discover all other members in cluster bootstrap phase using a shared discovery URL.</p><p>Discovery service protocol is <em>only</em> used in cluster bootstrap phase, and cannot be used for runtime reconfiguration or cluster monitoring.</p><p>The protocol uses a new discovery token to bootstrap one <em>unique</em> etcd cluster. Remember that one discovery token can represent only one etcd cluster. As long as discovery protocol on this token starts, even if it fails halfway, it must not be used to bootstrap another etcd cluster.</p><p>The rest of this article will walk through the discovery process with examples that correspond to a self-hosted discovery cluster. The public discovery service, discovery.etcd.io, functions the same way, but with a layer of polish to abstract away ugly URLs, generate UUIDs automatically, and provide some protections against excessive requests. At its core, the public discovery service still uses an etcd cluster as the data store as described in this document.</p><h2 id=protocol-workflow>Protocol workflow</h2><p>The idea of discovery protocol is to use an internal etcd cluster to coordinate bootstrap of a new cluster. First, all new members interact with discovery service and help to generate the expected member list. Then each new member bootstraps its server using this list, which performs the same functionality as -initial-cluster flag.</p><p>In the following example workflow, we will list each step of protocol in curl format for ease of understanding.</p><p>By convention the etcd discovery protocol uses the key prefix <code>_etcd/registry</code>. If <code>http://example.com</code> hosts an etcd cluster for discovery service, a full URL to discovery keyspace will be <code>http://example.com/v2/keys/_etcd/registry</code>. We will use this as the URL prefix in the example.</p><h3 id=creating-a-new-discovery-token>Creating a new discovery token</h3><p>Generate a unique token that will identify the new cluster. This will be used as a unique prefix in discovery keyspace in the following steps. An easy way to do this is to use <code>uuidgen</code>:</p><pre tabindex=0><code>UUID=$(uuidgen)
</code></pre><h3 id=specifying-the-expected-cluster-size>Specifying the expected cluster size</h3><p>The discovery token expects a cluster size that must be specified. The size is used by the discovery service to know when it has found all members that will initially form the cluster.</p><pre tabindex=0><code>curl -X PUT http://example.com/v2/keys/_etcd/registry/${UUID}/_config/size -d value=${cluster_size}
</code></pre><p>Usually the cluster size is 3, 5 or 7. Check <a href=/docs/v2.3/admin_guide#optimal-cluster-size>optimal cluster size</a> for more details.</p><h3 id=bringing-up-etcd-processes>Bringing up etcd processes</h3><p>Given the discovery URL, use it as <code>-discovery</code> flag and bring up etcd processes. Every etcd process will follow this next few steps internally if given a <code>-discovery</code> flag.</p><h3 id=registering-itself>Registering itself</h3><p>The first thing for etcd process is to register itself into the discovery URL as a member. This is done by creating member ID as a key in the discovery URL.</p><pre tabindex=0><code>curl -X PUT http://example.com/v2/keys/_etcd/registry/${UUID}/${member_id}?prevExist=false -d value=&#34;${member_name}=${member_peer_url_1}&amp;${member_name}=${member_peer_url_2}&#34;
</code></pre><h3 id=checking-the-status>Checking the status</h3><p>It checks the expected cluster size and registration status in discovery URL, and decides what the next action is.</p><pre tabindex=0><code>curl -X GET http://example.com/v2/keys/_etcd/registry/${UUID}/_config/size
curl -X GET http://example.com/v2/keys/_etcd/registry/${UUID}
</code></pre><p>If registered members are still not enough, it will wait for left members to appear.</p><p>If the number of registered members is bigger than the expected size N, it treats the first N registered members as the member list for the cluster. If the member itself is in the member list, the discovery procedure succeeds and it fetches all peers through the member list. If it is not in the member list, the discovery procedure finishes with the failure that the cluster has been full.</p><p>In etcd implementation, the member may check the cluster status even before registering itself. So it could fail quickly if the cluster has been full.</p><h3 id=waiting-for-all-members>Waiting for all members</h3><p>The wait process is described in detail in the <a href=/docs/v2.3/api#waiting-for-a-change>etcd API documentation</a>.</p><pre tabindex=0><code>curl -X GET http://example.com/v2/keys/_etcd/registry/${UUID}?wait=true&amp;waitIndex=${current_etcd_index}
</code></pre><p>It keeps waiting until finding all members.</p><h2 id=public-discovery-service>Public discovery service</h2><p>CoreOS Inc. hosts a public discovery service at <a href=https://discovery.etcd.io/ target=_blank rel=noopener>https://discovery.etcd.io/</a> , which provides some nice features for ease of use.</p><h3 id=mask-key-prefix>Mask key prefix</h3><p>Public discovery service will redirect <code>https://discovery.etcd.io/${UUID}</code> to etcd cluster behind for the key at <code>/v2/keys/_etcd/registry</code>. It masks register key prefix for short and readable discovery url.</p><h3 id=get-new-token>Get new token</h3><pre tabindex=0><code>GET /new

Sent query:
	size=${cluster_size}
Possible status codes:
	200 OK
	400 Bad Request
200 Body:
	generated discovery url
</code></pre><p>The generation process in the service follows the steps from <a href=#creating-a-new-discovery-token>Creating a New Discovery Token</a> to <a href=#specifying-the-expected-cluster-size>Specifying the Expected Cluster Size</a>.</p><h3 id=check-discovery-status>Check discovery status</h3><pre tabindex=0><code>GET /${UUID}
</code></pre><p>The status for this discovery token, including the machines that have been registered, can be checked by requesting the value of the UUID.</p><h3 id=open-source-repository>Open-source repository</h3><p>The repository is located at <a href=https://github.com/coreos/discovery.etcd.io target=_blank rel=noopener>https://github.com/coreos/discovery.etcd.io</a>. It could be used to build a custom discovery service.</p><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p></div><br><div class=td-page-meta__lastmod>Last modified March 16, 2022: <a href=https://github.com/etcd-io/website/commit/04f627864044cc5b96c8c54cf882b1b341f7441c>Remove contributor documentation (04f6278)</a></div></div></main></div></div></div></body></html>