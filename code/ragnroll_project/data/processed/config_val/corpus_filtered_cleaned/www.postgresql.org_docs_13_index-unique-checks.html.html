<!doctype html>
<html lang="en">
 <head>
  <title>PostgreSQL: Documentation: 13: 61.5. Index Uniqueness Checks</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="Content-Type" content="text/xhtml; charset=utf-8" />
   
  <meta name="theme-color" content="#336791"/>
  <meta name="copyright" content="The PostgreSQL Global Development Group" />
  <meta property="og:url" content="https://www.postgresql.org/docs/13/index-unique-checks.html" />
  <meta property="og:type" content="article" />
  <meta property="article:published_time" content="2025-02-20T14:13:26" />
  <meta property="og:image" content="https://www.postgresql.org/media/img/about/press/elephant.png" />
  <meta property="og:title" content="61.5. Index Uniqueness Checks" />
  <meta property="og:description" content="61.5.&amp;nbsp;Index Uniqueness Checks PostgreSQL enforces SQL uniqueness constraints using unique indexes, which are indexes that disallow multiple entries with identical …" />
  <meta property="og:site_name" content="PostgreSQL Documentation" />


  

  
  
  
  
  

  

  
  </head>
  <body>
    <div class="container-fluid">
      <div class="row justify-content-md-center">
        <div class="col">
          
          
        </div>
      </div>
      <div class="row justify-content-center pg-shout-box">
        <div class="col text-white text-center">February 20, 2025: <a href="/about/news/postgresql-174-168-1512-1417-and-1320-released-3018/">
  PostgreSQL 17.4, 16.8, 15.12, 14.17, and 13.20 Released!
</a>

</div>
      </div>
    </div>
    <div class="container-fluid margin">
      <div class="row">
        <div id="pgContentWrap" class="col-11">
          <div class="row">
            <div class="col-md-6 mb-2">
              <div class="row">
                <div class="col">
                  <div>
                    <a href="/docs/" title="Documentation">Documentation</a> &rarr; <a href="/docs/13/index.html">PostgreSQL 13</a>
                  </div>
                </div>
              </div>
              
                <div class="row">
                  <div class="col">
                    Supported Versions:
                      
                        
                        
                          <a href="/docs/current/index-unique-checks.html" title="PostgreSQL 17 - 61.5. Index Uniqueness Checks" >Current</a>
                          (<a href="/docs/17/index-unique-checks.html" title="PostgreSQL 17 - 61.5. Index Uniqueness Checks" >17</a>)
                        
                      
                         / 
                        
                          <a href="/docs/16/index-unique-checks.html" title="PostgreSQL 16 - 61.5. Index Uniqueness Checks" >16</a>
                        
                      
                         / 
                        
                          <a href="/docs/15/index-unique-checks.html" title="PostgreSQL 15 - 61.5. Index Uniqueness Checks" >15</a>
                        
                      
                         / 
                        
                          <a href="/docs/14/index-unique-checks.html" title="PostgreSQL 14 - 61.5. Index Uniqueness Checks" >14</a>
                        
                      
                         / 
                        
                          <a href="/docs/13/index-unique-checks.html" title="PostgreSQL 13 - 61.5. Index Uniqueness Checks" class="docs-version-selected">13</a>
                        
                      
                  </div>
                </div>
              
              
                <div class="row">
                  <div class="col">
                    Development Versions:
                    
                      
                      <a href="/docs/devel/index-unique-checks.html" title="PostgreSQL devel - 61.5. Index Uniqueness Checks"  rel="nofollow">devel</a>
                    
                  </div>
                </div>
              
              
                <div class="row">
                  <div class="col-12">
                    Unsupported versions:
                    
                      
                      <a href="/docs/12/index-unique-checks.html" title="PostgreSQL 12 - 61.5. Index Uniqueness Checks"  rel="nofollow">12</a>
                    
                       / 
                      <a href="/docs/11/index-unique-checks.html" title="PostgreSQL 11 - 61.5. Index Uniqueness Checks"  rel="nofollow">11</a>
                    
                       / 
                      <a href="/docs/10/index-unique-checks.html" title="PostgreSQL 10 - 61.5. Index Uniqueness Checks"  rel="nofollow">10</a>
                    
                       / 
                      <a href="/docs/9.6/index-unique-checks.html" title="PostgreSQL 9.6 - 61.5. Index Uniqueness Checks"  rel="nofollow">9.6</a>
                    
                       / 
                      <a href="/docs/9.5/index-unique-checks.html" title="PostgreSQL 9.5 - 61.5. Index Uniqueness Checks"  rel="nofollow">9.5</a>
                    
                       / 
                      <a href="/docs/9.4/index-unique-checks.html" title="PostgreSQL 9.4 - 61.5. Index Uniqueness Checks"  rel="nofollow">9.4</a>
                    
                       / 
                      <a href="/docs/9.3/index-unique-checks.html" title="PostgreSQL 9.3 - 61.5. Index Uniqueness Checks"  rel="nofollow">9.3</a>
                    
                       / 
                      <a href="/docs/9.2/index-unique-checks.html" title="PostgreSQL 9.2 - 61.5. Index Uniqueness Checks"  rel="nofollow">9.2</a>
                    
                       / 
                      <a href="/docs/9.1/index-unique-checks.html" title="PostgreSQL 9.1 - 61.5. Index Uniqueness Checks"  rel="nofollow">9.1</a>
                    
                       / 
                      <a href="/docs/9.0/index-unique-checks.html" title="PostgreSQL 9.0 - 61.5. Index Uniqueness Checks"  rel="nofollow">9.0</a>
                    
                       / 
                      <a href="/docs/8.4/index-unique-checks.html" title="PostgreSQL 8.4 - 61.5. Index Uniqueness Checks"  rel="nofollow">8.4</a>
                    
                       / 
                      <a href="/docs/8.3/index-unique-checks.html" title="PostgreSQL 8.3 - 61.5. Index Uniqueness Checks"  rel="nofollow">8.3</a>
                    
                       / 
                      <a href="/docs/8.2/index-unique-checks.html" title="PostgreSQL 8.2 - 61.5. Index Uniqueness Checks"  rel="nofollow">8.2</a>
                    
                       / 
                      <a href="/docs/8.1/index-unique-checks.html" title="PostgreSQL 8.1 - 61.5. Index Uniqueness Checks"  rel="nofollow">8.1</a>
                    
                  </div>
                </div>
              
            </div>
            <div class="col-md-6 col-lg-5 offset-lg-1">
              <form id="docSearchForm" role="search" method="get" action="/search/">
                <input type="hidden" name="u" value="/docs/13/" />
                <div class="input-group">
                  <input type="text" id="q" name="q" class="form-control" placeholder="Search the documentation for..."/>
                  <span class="input-group-btn">
                    <button class="btn btn-default" type="submit"><i class="fas fa-search"></i></button>
                  </span>
                </div>
              </form>
            </div>
          </div>

          <div id="docContent">
            <div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navheader">
  <table width="100%" summary="Navigation header">
    <tr>
      <th colspan="5" align="center">61.5.&nbsp;Index Uniqueness Checks</th>
    </tr>
    <tr>
      <td width="10%" align="left"><a accesskey="p" href="index-locking.html" title="61.4.&nbsp;Index Locking Considerations">Prev</a>&nbsp;</td>
      <td width="10%" align="left"><a accesskey="u" href="indexam.html" title="Chapter&nbsp;61.&nbsp;Index Access Method Interface Definition">Up</a></td>
      <th width="60%" align="center">Chapter&nbsp;61.&nbsp;Index Access Method Interface Definition</th>
      <td width="10%" align="right"><a accesskey="h" href="index.html" title="PostgreSQL 13.20 Documentation">Home</a></td>
      <td width="10%" align="right">&nbsp;<a accesskey="n" href="index-cost-estimation.html" title="61.6.&nbsp;Index Cost Estimation Functions">Next</a></td>
    </tr>
  </table>
  <hr />
</div>
<div class="sect1" id="INDEX-UNIQUE-CHECKS">
  <div class="titlepage">
    <div>
      <div>
        <h2 class="title" style="clear: both">61.5.&nbsp;Index Uniqueness Checks</h2>
      </div>
    </div>
  </div>
  <p><span class="productname">PostgreSQL</span> enforces SQL uniqueness constraints using <em class="firstterm">unique indexes</em>, which are indexes that disallow multiple entries with identical keys. An access method that supports this feature sets <code class="structfield">amcanunique</code> true. (At present, only b-tree supports it.) Columns listed in the <code class="literal">INCLUDE</code> clause are not considered when enforcing uniqueness.</p>
  <p>Because of MVCC, it is always necessary to allow duplicate entries to exist physically in an index: the entries might refer to successive versions of a single logical row. The behavior we actually want to enforce is that no MVCC snapshot could include two rows with equal index keys. This breaks down into the following cases that must be checked when inserting a new row into a unique index:</p>
  <div class="itemizedlist">
    <ul class="itemizedlist" style="list-style-type: disc;">
      <li class="listitem">
        <p>If a conflicting valid row has been deleted by the current transaction, it's okay. (In particular, since an UPDATE always deletes the old row version before inserting the new version, this will allow an UPDATE on a row without changing the key.)</p>
      </li>
      <li class="listitem">
        <p>If a conflicting row has been inserted by an as-yet-uncommitted transaction, the would-be inserter must wait to see if that transaction commits. If it rolls back then there is no conflict. If it commits without deleting the conflicting row again, there is a uniqueness violation. (In practice we just wait for the other transaction to end and then redo the visibility check in toto.)</p>
      </li>
      <li class="listitem">
        <p>Similarly, if a conflicting valid row has been deleted by an as-yet-uncommitted transaction, the would-be inserter must wait for that transaction to commit or abort, and then repeat the test.</p>
      </li>
    </ul>
  </div>
  <p>Furthermore, immediately before reporting a uniqueness violation according to the above rules, the access method must recheck the liveness of the row being inserted. If it is committed dead then no violation should be reported. (This case cannot occur during the ordinary scenario of inserting a row that's just been created by the current transaction. It can happen during <code class="command">CREATE UNIQUE INDEX CONCURRENTLY</code>, however.)</p>
  <p>We require the index access method to apply these tests itself, which means that it must reach into the heap to check the commit status of any row that is shown to have a duplicate key according to the index contents. This is without a doubt ugly and non-modular, but it saves redundant work: if we did a separate probe then the index lookup for a conflicting row would be essentially repeated while finding the place to insert the new row's index entry. What's more, there is no obvious way to avoid race conditions unless the conflict check is an integral part of insertion of the new index entry.</p>
  <p>If the unique constraint is deferrable, there is additional complexity: we need to be able to insert an index entry for a new row, but defer any uniqueness-violation error until end of statement or even later. To avoid unnecessary repeat searches of the index, the index access method should do a preliminary uniqueness check during the initial insertion. If this shows that there is definitely no conflicting live tuple, we are done. Otherwise, we schedule a recheck to occur when it is time to enforce the constraint. If, at the time of the recheck, both the inserted tuple and some other tuple with the same key are live, then the error must be reported. (Note that for this purpose, <span class="quote">“<span class="quote">live</span>”</span> actually means <span class="quote">“<span class="quote">any tuple in the index entry's HOT chain is live</span>”</span>.) To implement this, the <code class="function">aminsert</code> function is passed a <code class="literal">checkUnique</code> parameter having one of the following values:</p>
  <div class="itemizedlist">
    <ul class="itemizedlist" style="list-style-type: disc;">
      <li class="listitem">
        <p><code class="literal">UNIQUE_CHECK_NO</code> indicates that no uniqueness checking should be done (this is not a unique index).</p>
      </li>
      <li class="listitem">
        <p><code class="literal">UNIQUE_CHECK_YES</code> indicates that this is a non-deferrable unique index, and the uniqueness check must be done immediately, as described above.</p>
      </li>
      <li class="listitem">
        <p><code class="literal">UNIQUE_CHECK_PARTIAL</code> indicates that the unique constraint is deferrable. <span class="productname">PostgreSQL</span> will use this mode to insert each row's index entry. The access method must allow duplicate entries into the index, and report any potential duplicates by returning false from <code class="function">aminsert</code>. For each row for which false is returned, a deferred recheck will be scheduled.</p>
        <p>The access method must identify any rows which might violate the unique constraint, but it is not an error for it to report false positives. This allows the check to be done without waiting for other transactions to finish; conflicts reported here are not treated as errors and will be rechecked later, by which time they may no longer be conflicts.</p>
      </li>
      <li class="listitem">
        <p><code class="literal">UNIQUE_CHECK_EXISTING</code> indicates that this is a deferred recheck of a row that was reported as a potential uniqueness violation. Although this is implemented by calling <code class="function">aminsert</code>, the access method must <span class="emphasis"><em>not</em></span> insert a new index entry in this case. The index entry is already present. Rather, the access method must check to see if there is another live index entry. If so, and if the target row is also still live, report error.</p>
        <p>It is recommended that in a <code class="literal">UNIQUE_CHECK_EXISTING</code> call, the access method further verify that the target row actually does have an existing entry in the index, and report error if not. This is a good idea because the index tuple values passed to <code class="function">aminsert</code> will have been recomputed. If the index definition involves functions that are not really immutable, we might be checking the wrong area of the index. Checking that the target row is found in the recheck verifies that we are scanning for the same tuple values as were used in the original insertion.</p>
      </li>
    </ul>
  </div>
</div>
<div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navfooter">
  <hr />
  <table width="100%" summary="Navigation footer">
    <tr>
      <td width="40%" align="left"><a accesskey="p" href="index-locking.html" title="61.4.&nbsp;Index Locking Considerations">Prev</a>&nbsp;</td>
      <td width="20%" align="center"><a accesskey="u" href="indexam.html" title="Chapter&nbsp;61.&nbsp;Index Access Method Interface Definition">Up</a></td>
      <td width="40%" align="right">&nbsp;<a accesskey="n" href="index-cost-estimation.html" title="61.6.&nbsp;Index Cost Estimation Functions">Next</a></td>
    </tr>
    <tr>
      <td width="40%" align="left" valign="top">61.4.&nbsp;Index Locking Considerations&nbsp;</td>
      <td width="20%" align="center"><a accesskey="h" href="index.html" title="PostgreSQL 13.20 Documentation">Home</a></td>
      <td width="40%" align="right" valign="top">&nbsp;61.6.&nbsp;Index Cost Estimation Functions</td>
    </tr>
  </table>
</div>

          </div>
          
            <div id="docComments">
              <h2>Submit correction</h2>
              <p>
              If you see anything in the documentation that is not correct, does not match
              your experience with the particular feature or requires further clarification,
              please use
              <a href="/account/comments/new/13/index-unique-checks.html/" rel="nofollow">this form</a>
              to report a documentation issue.
              </p>
            </div>
          
        </div> 
      </div>
    </div>
    
    
    
    
    
    
  </body>
</html>
