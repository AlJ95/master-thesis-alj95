<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Watch Memory Usage Benchmark | etcd</title>
<meta name=description content="Performance measures for etcd watchers"><meta property="og:url" content="https://etcd.io/docs/v3.5/benchmarks/etcd-3-watch-memory-benchmark/"><meta property="og:site_name" content="etcd"><meta property="og:title" content="Watch Memory Usage Benchmark"><meta property="og:description" content="Performance measures for etcd watchers"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2021-06-14T17:16:50+00:00"><meta itemprop=name content="Watch Memory Usage Benchmark"><meta itemprop=description content="Performance measures for etcd watchers"><meta itemprop=dateModified content="2021-06-14T17:16:50+00:00"><meta itemprop=wordCount content="478"><meta name=twitter:card content="summary"><meta name=twitter:title content="Watch Memory Usage Benchmark"><meta name=twitter:description content="Performance measures for etcd watchers"></head><body class=td-page><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><h1>Watch Memory Usage Benchmark</h1><div class=lead>Performance measures for etcd watchers</div><p><em>NOTE</em>: The watch features are under active development, and their memory usage may change as that development progresses. We do not expect it to significantly increase beyond the figures stated below.</p><p>A primary goal of etcd is supporting a very large number of watchers doing a massively large amount of watching. etcd aims to support O(10k) clients, O(100K) watch streams (O(10) streams per client) and O(10M) total watchings (O(100) watching per stream). The memory consumed by each individual watching accounts for the largest portion of etcd&rsquo;s overall usage, and is therefore the focus of current and future optimizations.</p><p>Three related components of etcd watch consume physical memory: each <code>grpc.Conn</code>, each watch stream, and each instance of the watching activity. <code>grpc.Conn</code> maintains the actual TCP connection and other gRPC connection state. Each <code>grpc.Conn</code> consumes O(10kb) of memory, and might have multiple watch streams attached.</p><p>Each watch stream is an independent HTTP2 connection which consumes another O(10kb) of memory.
Multiple watchings might share one watch stream.</p><p>Watching is the actual struct that tracks the changes on the key-value store. Each watching should only consume &lt; O(1kb).</p><pre tabindex=0><code>                                          +-------+
                                          | watch |
                              +---------&gt; | foo   |
                              |           +-------+
                       +------+-----+
                       |   stream   |
      +--------------&gt; |            |
      |                +------+-----+     +-------+
      |                       |           | watch |
      |                       +---------&gt; | bar   |
+-----+------+                            +-------+
|            |         +------------+
|   conn     +-------&gt; |   stream   |
|            |         |            |
+-----+------+         +------------+
      |
      |
      |
      |                +------------+
      +--------------&gt; |   stream   |
                       |            |
                       +------------+
</code></pre><p>The theoretical memory consumption of watch can be approximated with the formula:
<code>memory = c1 * number_of_conn + c2 * avg_number_of_stream_per_conn + c3 * avg_number_of_watch_stream</code></p><h2 id=testing-environment>Testing Environment</h2><p>etcd version</p><ul><li>git head <a href=https://github.com/etcd-io/etcd/commit/185097ffaa627b909007e772c175e8fefac17af3 target=_blank rel=noopener>https://github.com/etcd-io/etcd/commit/185097ffaa627b909007e772c175e8fefac17af3</a></li></ul><p>GCE n1-standard-2 machine type</p><ul><li>7.5 GB memory</li><li>2x CPUs</li></ul><h2 id=overall-memory-usage>Overall memory usage</h2><p>The overall memory usage captures how much <a href=https://en.wikipedia.org/wiki/Resident_set_size target=_blank rel=noopener>RSS</a> etcd consumes with the client watchers. While the result may vary by as much as 10%, it is still meaningful, since the goal is to learn about the rough memory usage and the pattern of allocations.</p><p>With the benchmark result, we can calculate roughly that <code>c1 = 17kb</code>, <code>c2 = 18kb</code> and <code>c3 = 350bytes</code>. So each additional client connection consumes 17kb of memory and each additional stream consumes 18kb of memory, and each additional watching only cause 350bytes. A single etcd server can maintain millions of watchings with a few GB of memory in normal case.</p><table><thead><tr><th>clients</th><th>streams per client</th><th>watchings per stream</th><th>total watching</th><th>memory usage</th></tr></thead><tbody><tr><td>1k</td><td>1</td><td>1</td><td>1k</td><td>50MB</td></tr><tr><td>2k</td><td>1</td><td>1</td><td>2k</td><td>90MB</td></tr><tr><td>5k</td><td>1</td><td>1</td><td>5k</td><td>200MB</td></tr><tr><td>1k</td><td>10</td><td>1</td><td>10k</td><td>217MB</td></tr><tr><td>2k</td><td>10</td><td>1</td><td>20k</td><td>417MB</td></tr><tr><td>5k</td><td>10</td><td>1</td><td>50k</td><td>980MB</td></tr><tr><td>1k</td><td>50</td><td>1</td><td>50k</td><td>1001MB</td></tr><tr><td>2k</td><td>50</td><td>1</td><td>100k</td><td>1960MB</td></tr><tr><td>5k</td><td>50</td><td>1</td><td>250k</td><td>4700MB</td></tr><tr><td>1k</td><td>50</td><td>10</td><td>500k</td><td>1171MB</td></tr><tr><td>2k</td><td>50</td><td>10</td><td>1M</td><td>2371MB</td></tr><tr><td>5k</td><td>50</td><td>10</td><td>2.5M</td><td>5710MB</td></tr><tr><td>1k</td><td>50</td><td>100</td><td>5M</td><td>2380MB</td></tr><tr><td>2k</td><td>50</td><td>100</td><td>10M</td><td>4672MB</td></tr><tr><td>5k</td><td>50</td><td>100</td><td>25M</td><td><em>OOM</em></td></tr></tbody></table><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p></div><br><div class=td-page-meta__lastmod>Last modified June 14, 2021: <a href=https://github.com/etcd-io/website/commit/138926b5de44b5116fdbe63830eeaf73596e4c2c>Renaming content/en/next folder to content/en/v3.5. Updating redirects, links, and config as needed. (#363) (138926b)</a></div></div></main></div></div></div></body></html>