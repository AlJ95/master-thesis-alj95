<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Downgrade etcd from 3.5 to 3.4 | etcd</title>
<meta name=description content="Processes, checklists, and notes on downgrading etcd from 3.5 to 3.4"><meta property="og:url" content="https://etcd.io/docs/v3.5/downgrades/downgrade_3_5/"><meta property="og:site_name" content="etcd"><meta property="og:title" content="Downgrade etcd from 3.5 to 3.4"><meta property="og:description" content="Processes, checklists, and notes on downgrading etcd from 3.5 to 3.4"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2025-03-06T13:02:16-08:00"><meta itemprop=name content="Downgrade etcd from 3.5 to 3.4"><meta itemprop=description content="Processes, checklists, and notes on downgrading etcd from 3.5 to 3.4"><meta itemprop=dateModified content="2025-03-06T13:02:16-08:00"><meta itemprop=wordCount content="1395"><meta name=twitter:card content="summary"><meta name=twitter:title content="Downgrade etcd from 3.5 to 3.4"><meta name=twitter:description content="Processes, checklists, and notes on downgrading etcd from 3.5 to 3.4"></head><body class=td-page><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><h1>Downgrade etcd from 3.5 to 3.4</h1><div class=lead>Processes, checklists, and notes on downgrading etcd from 3.5 to 3.4</div><p>In the general case, downgrading from etcd 3.5 to 3.4 can be a zero-downtime, rolling downgrade:</p><ul><li>one by one, stop the etcd 3.5 processes and replace them with etcd 3.4 processes</li><li>after starting any 3.4 processes, new features in 3.5 are not longer available to the cluster</li></ul><p>Before <a href=#downgrade-procedure>starting a downgrade</a>, read through the rest of this guide to prepare.</p><h3 id=downgrade-checklists>Downgrade checklists</h3><p>content/en/docs/v3.5/op-guide/authentication/rbac.md</p><p><strong>NOTE:</strong> If your cluster enables auth, rolling downgrade from 3.5 isn&rsquo;t supported because 3.5 <a href=https://github.com/etcd-io/etcd/pull/11943 target=_blank rel=noopener>changes a format of WAL entries related to auth</a>. You can follow the <a href=../../op-guide/authentication/rbac/>authentification instructions</a> to disable auth, and delete all users first.</p><p>Highlighted breaking changes from 3.5 to 3.4:</p><h4 id=difference-in-flags>Difference in flags</h4><p>If you are using any of the following flags in your 3.5 configurations, make sure to remove, rename, or change the default value when downgrading to 3.4.</p><p><strong>NOTE</strong> The diff is based on version 3.5.14 and v.3.4.33. The actual diff would be dependent on your patch version, check with <code>diff &lt;(etcd-3.5/bin/etcd -h | grep \\-\\-) &lt;(etcd-3.4/bin/etcd -h | grep \\-\\-)</code> first.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span># flags not available in 3.4
</span></span><span style=display:flex><span><span style=color:#a40000>-etcd --socket-reuse-port
</span></span></span><span style=display:flex><span><span style=color:#a40000>-etcd --socket-reuse-address
</span></span></span><span style=display:flex><span><span style=color:#a40000>-etcd --raft-read-timeout
</span></span></span><span style=display:flex><span><span style=color:#a40000>-etcd --raft-write-timeout
</span></span></span><span style=display:flex><span><span style=color:#a40000>-etcd --v2-deprecation
</span></span></span><span style=display:flex><span><span style=color:#a40000>-etcd --client-cert-file
</span></span></span><span style=display:flex><span><span style=color:#a40000>-etcd --client-key-file
</span></span></span><span style=display:flex><span><span style=color:#a40000>-etcd --peer-client-cert-file
</span></span></span><span style=display:flex><span><span style=color:#a40000>-etcd --peer-client-key-file
</span></span></span><span style=display:flex><span><span style=color:#a40000>-etcd --self-signed-cert-validity
</span></span></span><span style=display:flex><span><span style=color:#a40000>-etcd --enable-log-rotation --log-rotation-config-json=some.json
</span></span></span><span style=display:flex><span><span style=color:#a40000>-etcd --experimental-enable-distributed-tracing --experimental-distributed-tracing-address=&#39;localhost:4317&#39; --experimental-distributed-tracing-service-name=&#39;etcd&#39; --experimental-distributed-tracing-instance-id=&#39;&#39; --experimental-distributed-tracing-sampling-rate=&#39;0&#39;
</span></span></span><span style=display:flex><span><span style=color:#a40000>-etcd --experimental-compact-hash-check-enabled --experimental-compact-hash-check-time=&#39;1m&#39;
</span></span></span><span style=display:flex><span><span style=color:#a40000>-etcd --experimental-downgrade-check-time
</span></span></span><span style=display:flex><span><span style=color:#a40000>-etcd --experimental-memory-mlock
</span></span></span><span style=display:flex><span><span style=color:#a40000>-etcd --experimental-txn-mode-write-with-shared-buffer
</span></span></span><span style=display:flex><span><span style=color:#a40000>-etcd --experimental-bootstrap-defrag-threshold-megabytes
</span></span></span><span style=display:flex><span><span style=color:#a40000>-etcd --experimental-stop-grpc-service-on-defrag
</span></span></span><span style=display:flex><span><span style=color:#a40000></span>
</span></span><span style=display:flex><span># same flag with different names
</span></span><span style=display:flex><span><span style=color:#a40000>-etcd --backend-bbolt-freelist-type=map
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+etcd --experimental-backend-bbolt-freelist-type=array
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>
</span></span><span style=display:flex><span># same flag different defaults
</span></span><span style=display:flex><span><span style=color:#a40000>-etcd --pre-vote=true
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+etcd --pre-vote=false
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>
</span></span><span style=display:flex><span><span style=color:#a40000>-etcd --logger=zap
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+etcd --logger=capnslog
</span></span></span></code></pre></div><h4 id=etcd---logger-zap><code>etcd --logger zap</code></h4><p>3.4 defaults to <code>--logger=capnslog</code> while 3.5 defaults <code>--logger=zap</code>.</p><p>If you want to keep using <code>zap</code>, it needs to be explicitly specified.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#00a000>+etcd --logger=zap --log-outputs=stderr
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>
</span></span><span style=display:flex><span><span style=color:#00a000>+# to write logs to stderr and a.log file at the same time
</span></span></span><span style=display:flex><span><span style=color:#00a000>+etcd --logger=zap --log-outputs=stderr,a.log
</span></span></span></code></pre></div><h4 id=difference-in-prometheus-metrics>Difference in Prometheus metrics</h4><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span># metrics not available in 3.4
</span></span><span style=display:flex><span><span style=color:#a40000>-etcd_debugging_mvcc_db_compaction_last
</span></span></span></code></pre></div><h3 id=server-downgrade-checklists>Server downgrade checklists</h3><h4 id=downgrade-requirements>Downgrade requirements</h4><p>To ensure a smooth rolling downgrade, the running cluster must be healthy. Check the health of the cluster by using the <code>etcdctl endpoint health</code> command before proceeding.</p><p>The 3.4 version to downgrade to must be >= 3.4.32.</p><h4 id=preparation>Preparation</h4><p>Before downgrading etcd, always test the services relying on etcd in a staging environment before deploying the downgrade to the production environment.</p><p>Before beginning, <a href=../../op-guide/maintenance/#snapshot-backup>download the snapshot backup</a>. Should something go wrong with the downgrade, it is possible to use this backup to <a href=#rollback>rollback</a> back to existing etcd version. Please note that the <code>snapshot</code> command only backs up the v3 data. For v2 data, see <a href=/docs/v2.3/admin_guide#backing-up-the-datastore>backing up v2 datastore</a>.</p><p>Before beginning, download the latest release of etcd 3.4, and make sure its version is >= 3.4.32.</p><h4 id=mixed-versions>Mixed versions</h4><p>While downgrading, an etcd cluster supports mixed versions of etcd members, and operates with the protocol of the lowest common version. The cluster is considered downgraded once any of its members is downgraded to version 3.4. Internally, etcd members negotiate with each other to determine the overall cluster version, which controls the reported version and the supported features.</p><h4 id=limitations>Limitations</h4><p>Note: If the cluster only has v3 data and no v2 data, it is not subject to this limitation.</p><p>If the cluster is serving a v2 data set larger than 50MB, each newly downgraded member may take up to two minutes to catch up with the existing cluster. Check the size of a recent snapshot to estimate the total data size. In other words, it is safest to wait for 2 minutes between downgrading each member.</p><p>For a much larger total data size, 100MB or more , this one-time process might take even more time. Administrators of very large etcd clusters of this magnitude can feel free to contact the <a href=https://groups.google.com/g/etcd-dev target=_blank rel=noopener>etcd team</a> before downgrading, and we&rsquo;ll be happy to provide advice on the procedure.</p><h4 id=rollback>Rollback</h4><p>If any member has been downgraded to 3.4, the cluster version will be downgraded to 3.4, and operations will be &ldquo;3.4&rdquo; compatible. You would need to follow the <a href=../../upgrades/upgrade_3_5/>Upgrade etcd from 3.4 to 3.5</a> instructions to rollback.</p><p>Please <a href=../../op-guide/maintenance/#snapshot-backup>download the snapshot backup</a> to make downgrading the cluster possible even after it has been completely downgraded.</p><h3 id=downgrade-procedure>Downgrade procedure</h3><p>This example shows how to downgrade a 3-member 3.5 etcd cluster running on a local machine.</p><h4 id=step-1-check-downgrade-requirements>Step 1: check downgrade requirements</h4><p>Is the cluster healthy and running 3.5.x?</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>etcdctl --endpoints<span style=color:#ce5c00;font-weight:700>=</span>localhost:2379,localhost:22379,localhost:32379 endpoint health
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>localhost:2379 is healthy: successfully committed proposal: took = 2.118638ms
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>localhost:22379 is healthy: successfully committed proposal: took = 3.631388ms
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>localhost:32379 is healthy: successfully committed proposal: took = 2.157051ms
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl http://localhost:2379/version
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{&#34;etcdserver&#34;:&#34;3.5.0&#34;,&#34;etcdcluster&#34;:&#34;3.5.0&#34;}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl http://localhost:22379/version
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{&#34;etcdserver&#34;:&#34;3.5.0&#34;,&#34;etcdcluster&#34;:&#34;3.5.0&#34;}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl http://localhost:32379/version
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{&#34;etcdserver&#34;:&#34;3.5.0&#34;,&#34;etcdcluster&#34;:&#34;3.5.0&#34;}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span></code></pre></div><h4 id=step-2-download-snapshot-backup-from-leader>Step 2: download snapshot backup from leader</h4><p><a href=../../op-guide/maintenance/#snapshot-backup>Download the snapshot backup</a> to provide a downgrade path should any problems occur.</p><h4 id=step-3-stop-one-existing-etcd-server>Step 3: stop one existing etcd server</h4><p>Before stopping the server, check if it is the leader</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>etcdctl --endpoints<span style=color:#ce5c00;font-weight:700>=</span>localhost:2379,localhost:22379,localhost:32379 endpoint status -w<span style=color:#ce5c00;font-weight:700>=</span>table
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>+-----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>|    ENDPOINT     |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>+-----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>|  localhost:2379 | 8211f1d0f64f3269 |  3.5.13 |   20 kB |      true |      false |         2 |          9 |                  9 |        |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>| localhost:22379 | 91bc3c398fb3c146 |  3.5.13 |   20 kB |     false |      false |         2 |          9 |                  9 |        |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>| localhost:32379 | fd422379fda50e48 |  3.5.13 |   20 kB |     false |      false |         2 |          9 |                  9 |        |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>+-----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span></code></pre></div><p>If the server to be stopped is the leader, you can avoid some downtime by <code>move-leader</code> to another server before stopping this server.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>etcdctl --endpoints<span style=color:#ce5c00;font-weight:700>=</span>localhost:2379,localhost:22379,localhost:32379 move-leader 91bc3c398fb3c146
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>etcdctl --endpoints<span style=color:#ce5c00;font-weight:700>=</span>localhost:2379,localhost:22379,localhost:32379 endpoint status -w<span style=color:#ce5c00;font-weight:700>=</span>table
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>+-----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>|    ENDPOINT     |        ID        | VERSION | DB SIZE | IS LEADER | IS LEARNER | RAFT TERM | RAFT INDEX | RAFT APPLIED INDEX | ERRORS |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>+-----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>|  localhost:2379 | 8211f1d0f64f3269 |  3.5.13 |   20 kB |     false |      false |         3 |         11 |                 11 |        |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>| localhost:22379 | 91bc3c398fb3c146 |  3.5.13 |   20 kB |      true |      false |         3 |         11 |                 11 |        |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>| localhost:32379 | fd422379fda50e48 |  3.5.13 |   20 kB |     false |      false |         3 |         11 |                 11 |        |
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>+-----------------+------------------+---------+---------+-----------+------------+-----------+------------+--------------------+--------+
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span></code></pre></div><p>When each etcd process is stopped, expected errors will be logged by other cluster members. This is normal since a cluster member connection has been (temporarily) broken:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;level&#34;</span>:<span style=color:#4e9a06>&#34;info&#34;</span>,<span style=color:#4e9a06>&#34;ts&#34;</span>:<span style=color:#4e9a06>&#34;2024-05-14T20:25:47.051124Z&#34;</span>,<span style=color:#4e9a06>&#34;logger&#34;</span>:<span style=color:#4e9a06>&#34;raft&#34;</span>,<span style=color:#4e9a06>&#34;caller&#34;</span>:<span style=color:#4e9a06>&#34;etcdserver/zap_raft.go:77&#34;</span>,<span style=color:#4e9a06>&#34;msg&#34;</span>:<span style=color:#4e9a06>&#34;91bc3c398fb3c146 became leader at term 3&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;level&#34;</span>:<span style=color:#4e9a06>&#34;info&#34;</span>,<span style=color:#4e9a06>&#34;ts&#34;</span>:<span style=color:#4e9a06>&#34;2024-05-14T20:25:47.051139Z&#34;</span>,<span style=color:#4e9a06>&#34;logger&#34;</span>:<span style=color:#4e9a06>&#34;raft&#34;</span>,<span style=color:#4e9a06>&#34;caller&#34;</span>:<span style=color:#4e9a06>&#34;etcdserver/zap_raft.go:77&#34;</span>,<span style=color:#4e9a06>&#34;msg&#34;</span>:<span style=color:#4e9a06>&#34;raft.node: 91bc3c398fb3c146 elected leader 91bc3c398fb3c146 at term 3&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>^C<span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;level&#34;</span>:<span style=color:#4e9a06>&#34;warn&#34;</span>,<span style=color:#4e9a06>&#34;ts&#34;</span>:<span style=color:#4e9a06>&#34;2024-05-14T20:27:09.094119Z&#34;</span>,<span style=color:#4e9a06>&#34;caller&#34;</span>:<span style=color:#4e9a06>&#34;rafthttp/stream.go:421&#34;</span>,<span style=color:#4e9a06>&#34;msg&#34;</span>:<span style=color:#4e9a06>&#34;lost TCP streaming connection with remote peer&#34;</span>,<span style=color:#4e9a06>&#34;stream-reader-type&#34;</span>:<span style=color:#4e9a06>&#34;stream MsgApp v2&#34;</span>,<span style=color:#4e9a06>&#34;local-member-id&#34;</span>:<span style=color:#4e9a06>&#34;91bc3c398fb3c146&#34;</span>,<span style=color:#4e9a06>&#34;remote-peer-id&#34;</span>:<span style=color:#4e9a06>&#34;8211f1d0f64f3269&#34;</span>,<span style=color:#4e9a06>&#34;error&#34;</span>:<span style=color:#4e9a06>&#34;EOF&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;level&#34;</span>:<span style=color:#4e9a06>&#34;warn&#34;</span>,<span style=color:#4e9a06>&#34;ts&#34;</span>:<span style=color:#4e9a06>&#34;2024-05-14T20:27:09.09427Z&#34;</span>,<span style=color:#4e9a06>&#34;caller&#34;</span>:<span style=color:#4e9a06>&#34;rafthttp/stream.go:421&#34;</span>,<span style=color:#4e9a06>&#34;msg&#34;</span>:<span style=color:#4e9a06>&#34;lost TCP streaming connection with remote peer&#34;</span>,<span style=color:#4e9a06>&#34;stream-reader-type&#34;</span>:<span style=color:#4e9a06>&#34;stream Message&#34;</span>,<span style=color:#4e9a06>&#34;local-member-id&#34;</span>:<span style=color:#4e9a06>&#34;91bc3c398fb3c146&#34;</span>,<span style=color:#4e9a06>&#34;remote-peer-id&#34;</span>:<span style=color:#4e9a06>&#34;8211f1d0f64f3269&#34;</span>,<span style=color:#4e9a06>&#34;error&#34;</span>:<span style=color:#4e9a06>&#34;EOF&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;level&#34;</span>:<span style=color:#4e9a06>&#34;warn&#34;</span>,<span style=color:#4e9a06>&#34;ts&#34;</span>:<span style=color:#4e9a06>&#34;2024-05-14T20:27:09.095535Z&#34;</span>,<span style=color:#4e9a06>&#34;caller&#34;</span>:<span style=color:#4e9a06>&#34;rafthttp/peer_status.go:66&#34;</span>,<span style=color:#4e9a06>&#34;msg&#34;</span>:<span style=color:#4e9a06>&#34;peer became inactive (message send to peer failed)&#34;</span>,<span style=color:#4e9a06>&#34;peer-id&#34;</span>:<span style=color:#4e9a06>&#34;8211f1d0f64f3269&#34;</span>,<span style=color:#4e9a06>&#34;error&#34;</span>:<span style=color:#4e9a06>&#34;failed to dial 8211f1d0f64f3269 on stream MsgApp v2 (peer 8211f1d0f64f3269 failed to find local node 91bc3c398fb3c146)&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;level&#34;</span>:<span style=color:#4e9a06>&#34;warn&#34;</span>,<span style=color:#4e9a06>&#34;ts&#34;</span>:<span style=color:#4e9a06>&#34;2024-05-14T20:27:09.43915Z&#34;</span>,<span style=color:#4e9a06>&#34;caller&#34;</span>:<span style=color:#4e9a06>&#34;rafthttp/stream.go:223&#34;</span>,<span style=color:#4e9a06>&#34;msg&#34;</span>:<span style=color:#4e9a06>&#34;lost TCP streaming connection with remote peer&#34;</span>,<span style=color:#4e9a06>&#34;stream-writer-type&#34;</span>:<span style=color:#4e9a06>&#34;stream Message&#34;</span>,<span style=color:#4e9a06>&#34;local-member-id&#34;</span>:<span style=color:#4e9a06>&#34;91bc3c398fb3c146&#34;</span>,<span style=color:#4e9a06>&#34;remote-peer-id&#34;</span>:<span style=color:#4e9a06>&#34;8211f1d0f64f3269&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;level&#34;</span>:<span style=color:#4e9a06>&#34;warn&#34;</span>,<span style=color:#4e9a06>&#34;ts&#34;</span>:<span style=color:#4e9a06>&#34;2024-05-14T20:27:11.085646Z&#34;</span>,<span style=color:#4e9a06>&#34;caller&#34;</span>:<span style=color:#4e9a06>&#34;etcdserver/cluster_util.go:294&#34;</span>,<span style=color:#4e9a06>&#34;msg&#34;</span>:<span style=color:#4e9a06>&#34;failed to reach the peer URL&#34;</span>,<span style=color:#4e9a06>&#34;address&#34;</span>:<span style=color:#4e9a06>&#34;http://127.0.0.1:12380/version&#34;</span>,<span style=color:#4e9a06>&#34;remote-member-id&#34;</span>:<span style=color:#4e9a06>&#34;8211f1d0f64f3269&#34;</span>,<span style=color:#4e9a06>&#34;error&#34;</span>:<span style=color:#4e9a06>&#34;Get \&#34;http://127.0.0.1:12380/version\&#34;: dial tcp 127.0.0.1:12380: connect: connection refused&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;level&#34;</span>:<span style=color:#4e9a06>&#34;warn&#34;</span>,<span style=color:#4e9a06>&#34;ts&#34;</span>:<span style=color:#4e9a06>&#34;2024-05-14T20:27:11.085718Z&#34;</span>,<span style=color:#4e9a06>&#34;caller&#34;</span>:<span style=color:#4e9a06>&#34;etcdserver/cluster_util.go:158&#34;</span>,<span style=color:#4e9a06>&#34;msg&#34;</span>:<span style=color:#4e9a06>&#34;failed to get version&#34;</span>,<span style=color:#4e9a06>&#34;remote-member-id&#34;</span>:<span style=color:#4e9a06>&#34;8211f1d0f64f3269&#34;</span>,<span style=color:#4e9a06>&#34;error&#34;</span>:<span style=color:#4e9a06>&#34;Get \&#34;http://127.0.0.1:12380/version\&#34;: dial tcp 127.0.0.1:12380: connect: connection refused&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;level&#34;</span>:<span style=color:#4e9a06>&#34;warn&#34;</span>,<span style=color:#4e9a06>&#34;ts&#34;</span>:<span style=color:#4e9a06>&#34;2024-05-14T20:27:13.557385Z&#34;</span>,<span style=color:#4e9a06>&#34;caller&#34;</span>:<span style=color:#4e9a06>&#34;rafthttp/probing_status.go:68&#34;</span>,<span style=color:#4e9a06>&#34;msg&#34;</span>:<span style=color:#4e9a06>&#34;prober detected unhealthy status&#34;</span>,<span style=color:#4e9a06>&#34;round-tripper-name&#34;</span>:<span style=color:#4e9a06>&#34;ROUND_TRIPPER_SNAPSHOT&#34;</span>,<span style=color:#4e9a06>&#34;remote-peer-id&#34;</span>:<span style=color:#4e9a06>&#34;8211f1d0f64f3269&#34;</span>,<span style=color:#4e9a06>&#34;rtt&#34;</span>:<span style=color:#4e9a06>&#34;416.079µs&#34;</span>,<span style=color:#4e9a06>&#34;error&#34;</span>:<span style=color:#4e9a06>&#34;dial tcp 127.0.0.1:12380: connect: connection refused&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=step-4-restart-the-etcd-server-with-same-configuration----next-cluster-version-compatible>Step 4: restart the etcd server with same configuration + <code>--next-cluster-version-compatible</code></h4><p>Restart the etcd server with same configuration but with the new etcd binary and <code>--next-cluster-version-compatible</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a40000>-etcd-3.5/bin --name s1 \
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+etcd-3.4/bin --name s1 \
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>  --data-dir /tmp/etcd/s1 \
</span></span><span style=display:flex><span>  --listen-client-urls http://localhost:2379 \
</span></span><span style=display:flex><span>  --advertise-client-urls http://localhost:2379 \
</span></span><span style=display:flex><span>  --listen-peer-urls http://localhost:2380 \
</span></span><span style=display:flex><span>  --initial-advertise-peer-urls http://localhost:2380 \
</span></span><span style=display:flex><span>  --initial-cluster s1=http://localhost:2380,s2=http://localhost:22380,s3=http://localhost:32380 \
</span></span><span style=display:flex><span>  --initial-cluster-token tkn \
</span></span><span style=display:flex><span>  --initial-cluster-state existing
</span></span><span style=display:flex><span>  --next-cluster-version-compatible
</span></span></code></pre></div><p>The new 3.4 etcd will publish its information to the cluster. At this point, cluster will start to operate as 3.4 protocol, which is the lowest common version.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>&gt; <span style=color:#4e9a06>`</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;level&#34;</span>:<span style=color:#4e9a06>&#34;info&#34;</span>,<span style=color:#4e9a06>&#34;ts&#34;</span>:<span style=color:#4e9a06>&#34;2024-05-13T21:05:43.981445Z&#34;</span>,<span style=color:#4e9a06>&#34;caller&#34;</span>:<span style=color:#4e9a06>&#34;membership/cluster.go:561&#34;</span>,<span style=color:#4e9a06>&#34;msg&#34;</span>:<span style=color:#4e9a06>&#34;set initial cluster version&#34;</span>,<span style=color:#4e9a06>&#34;cluster-id&#34;</span>:<span style=color:#4e9a06>&#34;ef37ad9dc622a7c4&#34;</span>,<span style=color:#4e9a06>&#34;local-member-id&#34;</span>:<span style=color:#4e9a06>&#34;8211f1d0f64f3269&#34;</span>,<span style=color:#4e9a06>&#34;cluster-version&#34;</span>:<span style=color:#4e9a06>&#34;3.0&#34;</span><span style=color:#ce5c00;font-weight:700>}</span><span style=color:#4e9a06>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; <span style=color:#4e9a06>`</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;level&#34;</span>:<span style=color:#4e9a06>&#34;info&#34;</span>,<span style=color:#4e9a06>&#34;ts&#34;</span>:<span style=color:#4e9a06>&#34;2024-05-13T21:05:43.982188Z&#34;</span>,<span style=color:#4e9a06>&#34;caller&#34;</span>:<span style=color:#4e9a06>&#34;api/capability.go:77&#34;</span>,<span style=color:#4e9a06>&#34;msg&#34;</span>:<span style=color:#4e9a06>&#34;enabled capabilities for version&#34;</span>,<span style=color:#4e9a06>&#34;cluster-version&#34;</span>:<span style=color:#4e9a06>&#34;3.0&#34;</span><span style=color:#ce5c00;font-weight:700>}</span><span style=color:#4e9a06>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; <span style=color:#4e9a06>`</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;level&#34;</span>:<span style=color:#4e9a06>&#34;info&#34;</span>,<span style=color:#4e9a06>&#34;ts&#34;</span>:<span style=color:#4e9a06>&#34;2024-05-13T21:05:43.982312Z&#34;</span>,<span style=color:#4e9a06>&#34;caller&#34;</span>:<span style=color:#4e9a06>&#34;membership/cluster.go:549&#34;</span>,<span style=color:#4e9a06>&#34;msg&#34;</span>:<span style=color:#4e9a06>&#34;updated cluster version&#34;</span>,<span style=color:#4e9a06>&#34;cluster-id&#34;</span>:<span style=color:#4e9a06>&#34;ef37ad9dc622a7c4&#34;</span>,<span style=color:#4e9a06>&#34;local-member-id&#34;</span>:<span style=color:#4e9a06>&#34;8211f1d0f64f3269&#34;</span>,<span style=color:#4e9a06>&#34;from&#34;</span>:<span style=color:#4e9a06>&#34;3.0&#34;</span>,<span style=color:#4e9a06>&#34;from&#34;</span>:<span style=color:#4e9a06>&#34;3.5&#34;</span><span style=color:#ce5c00;font-weight:700>}</span><span style=color:#4e9a06>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; <span style=color:#4e9a06>`</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;level&#34;</span>:<span style=color:#4e9a06>&#34;info&#34;</span>,<span style=color:#4e9a06>&#34;ts&#34;</span>:<span style=color:#4e9a06>&#34;2024-05-13T21:05:43.982376Z&#34;</span>,<span style=color:#4e9a06>&#34;caller&#34;</span>:<span style=color:#4e9a06>&#34;api/capability.go:77&#34;</span>,<span style=color:#4e9a06>&#34;msg&#34;</span>:<span style=color:#4e9a06>&#34;enabled capabilities for version&#34;</span>,<span style=color:#4e9a06>&#34;cluster-version&#34;</span>:<span style=color:#4e9a06>&#34;3.5&#34;</span><span style=color:#ce5c00;font-weight:700>}</span><span style=color:#4e9a06>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; <span style=color:#4e9a06>`</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;level&#34;</span>:<span style=color:#4e9a06>&#34;info&#34;</span>,<span style=color:#4e9a06>&#34;ts&#34;</span>:<span style=color:#4e9a06>&#34;2024-05-13T21:05:44.000672Z&#34;</span>,<span style=color:#4e9a06>&#34;caller&#34;</span>:<span style=color:#4e9a06>&#34;etcdserver/server.go:2152&#34;</span>,<span style=color:#4e9a06>&#34;msg&#34;</span>:<span style=color:#4e9a06>&#34;published local member to cluster through raft&#34;</span>,<span style=color:#4e9a06>&#34;local-member-id&#34;</span>:<span style=color:#4e9a06>&#34;8211f1d0f64f3269&#34;</span>,<span style=color:#4e9a06>&#34;local-member-attributes&#34;</span>:<span style=color:#4e9a06>&#34;{Name:infra1 ClientURLs:[http://127.0.0.1:2379]}&#34;</span>,<span style=color:#4e9a06>&#34;request-path&#34;</span>:<span style=color:#4e9a06>&#34;/0/members/8211f1d0f64f3269/attributes&#34;</span>,<span style=color:#4e9a06>&#34;cluster-id&#34;</span>:<span style=color:#4e9a06>&#34;ef37ad9dc622a7c4&#34;</span>,<span style=color:#4e9a06>&#34;publish-timeout&#34;</span>:<span style=color:#4e9a06>&#34;7s&#34;</span><span style=color:#ce5c00;font-weight:700>}</span><span style=color:#4e9a06>`</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>&gt; <span style=color:#4e9a06>`</span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;level&#34;</span>:<span style=color:#4e9a06>&#34;info&#34;</span>,<span style=color:#4e9a06>&#34;ts&#34;</span>:<span style=color:#4e9a06>&#34;2024-05-13T21:05:46.452631Z&#34;</span>,<span style=color:#4e9a06>&#34;caller&#34;</span>:<span style=color:#4e9a06>&#34;membership/cluster.go:549&#34;</span>,<span style=color:#4e9a06>&#34;msg&#34;</span>:<span style=color:#4e9a06>&#34;updated cluster version&#34;</span>,<span style=color:#4e9a06>&#34;cluster-id&#34;</span>:<span style=color:#4e9a06>&#34;ef37ad9dc622a7c4&#34;</span>,<span style=color:#4e9a06>&#34;local-member-id&#34;</span>:<span style=color:#4e9a06>&#34;8211f1d0f64f3269&#34;</span>,<span style=color:#4e9a06>&#34;from&#34;</span>:<span style=color:#4e9a06>&#34;3.5&#34;</span>,<span style=color:#4e9a06>&#34;from&#34;</span>:<span style=color:#4e9a06>&#34;3.4&#34;</span><span style=color:#ce5c00;font-weight:700>}</span><span style=color:#4e9a06>`</span>
</span></span></code></pre></div><p>Verify that each member, and then the entire cluster, becomes healthy with the new 3.4 etcd binary:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>etcdctl endpoint health --endpoints<span style=color:#ce5c00;font-weight:700>=</span>localhost:2379,localhost:22379,localhost:32379
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>localhost:32379 is healthy: successfully committed proposal: took = 2.337471ms
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>localhost:22379 is healthy: successfully committed proposal: took = 1.130717ms
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>localhost:2379 is healthy: successfully committed proposal: took = 2.124843ms
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span></code></pre></div><p>Un-downgraded members will log info like the following</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;level&#34;</span>:<span style=color:#4e9a06>&#34;info&#34;</span>,<span style=color:#4e9a06>&#34;ts&#34;</span>:<span style=color:#4e9a06>&#34;2024-05-13T21:05:46.450764Z&#34;</span>,<span style=color:#4e9a06>&#34;caller&#34;</span>:<span style=color:#4e9a06>&#34;etcdserver/server.go:2633&#34;</span>,<span style=color:#4e9a06>&#34;msg&#34;</span>:<span style=color:#4e9a06>&#34;updating cluster version using v2 API&#34;</span>,<span style=color:#4e9a06>&#34;from&#34;</span>:<span style=color:#4e9a06>&#34;3.5&#34;</span>,<span style=color:#4e9a06>&#34;to&#34;</span>:<span style=color:#4e9a06>&#34;3.4&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;level&#34;</span>:<span style=color:#4e9a06>&#34;info&#34;</span>,<span style=color:#4e9a06>&#34;ts&#34;</span>:<span style=color:#4e9a06>&#34;2024-05-13T21:05:46.452419Z&#34;</span>,<span style=color:#4e9a06>&#34;caller&#34;</span>:<span style=color:#4e9a06>&#34;membership/cluster.go:576&#34;</span>,<span style=color:#4e9a06>&#34;msg&#34;</span>:<span style=color:#4e9a06>&#34;updated cluster version&#34;</span>,<span style=color:#4e9a06>&#34;cluster-id&#34;</span>:<span style=color:#4e9a06>&#34;ef37ad9dc622a7c4&#34;</span>,<span style=color:#4e9a06>&#34;local-member-id&#34;</span>:<span style=color:#4e9a06>&#34;91bc3c398fb3c146&#34;</span>,<span style=color:#4e9a06>&#34;from&#34;</span>:<span style=color:#4e9a06>&#34;3.5&#34;</span>,<span style=color:#4e9a06>&#34;to&#34;</span>:<span style=color:#4e9a06>&#34;3.4&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>{</span><span style=color:#4e9a06>&#34;level&#34;</span>:<span style=color:#4e9a06>&#34;info&#34;</span>,<span style=color:#4e9a06>&#34;ts&#34;</span>:<span style=color:#4e9a06>&#34;2024-05-13T21:05:46.452547Z&#34;</span>,<span style=color:#4e9a06>&#34;caller&#34;</span>:<span style=color:#4e9a06>&#34;etcdserver/server.go:2652&#34;</span>,<span style=color:#4e9a06>&#34;msg&#34;</span>:<span style=color:#4e9a06>&#34;cluster version is updated&#34;</span>,<span style=color:#4e9a06>&#34;cluster-version&#34;</span>:<span style=color:#4e9a06>&#34;3.4&#34;</span><span style=color:#ce5c00;font-weight:700>}</span>
</span></span></code></pre></div><h4 id=step-5-repeat-step-3-and-step-4-for-rest-of-the-members>Step 5: repeat <em>step 3</em> and <em>step 4</em> for rest of the members</h4><p>When all members are downgraded, check the health status and version of the cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>endpoint health --endpoints<span style=color:#ce5c00;font-weight:700>=</span>localhost:2379,localhost:22379,localhost:32379
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>localhost:2379 is healthy: successfully committed proposal: took = 492.834µs
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>localhost:22379 is healthy: successfully committed proposal: took = 1.015025ms
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>localhost:32379 is healthy: successfully committed proposal: took = 1.853077ms
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl http://localhost:2379/version
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{&#34;etcdserver&#34;:&#34;3.4.32&#34;,&#34;etcdcluster&#34;:&#34;3.4.0&#34;}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl http://localhost:22379/version
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{&#34;etcdserver&#34;:&#34;3.4.32&#34;,&#34;etcdcluster&#34;:&#34;3.4.0&#34;}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl http://localhost:32379/version
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{&#34;etcdserver&#34;:&#34;3.4.32&#34;,&#34;etcdcluster&#34;:&#34;3.4.0&#34;}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span></code></pre></div><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p></div><br><div class=td-page-meta__lastmod>Last modified March 6, 2025: <a href=https://github.com/etcd-io/website/commit/a42747861656c25462222ff04d1a2aea3e3c494c>Fix lint error in 3.5 downgrade instructions. (a427478)</a></div></div></main></div></div></div></body></html>