<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>gRPC proxy | etcd</title>
<meta name=description content="A stateless etcd reverse proxy operating at the gRPC layer"><meta property="og:url" content="https://etcd.io/docs/v3.5/op-guide/grpc_proxy/"><meta property="og:site_name" content="etcd"><meta property="og:title" content="gRPC proxy"><meta property="og:description" content="A stateless etcd reverse proxy operating at the gRPC layer"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2022-04-09T22:54:04+08:00"><meta itemprop=name content="gRPC proxy"><meta itemprop=description content="A stateless etcd reverse proxy operating at the gRPC layer"><meta itemprop=dateModified content="2022-04-09T22:54:04+08:00"><meta itemprop=wordCount content="1433"><meta name=twitter:card content="summary"><meta name=twitter:title content="gRPC proxy"><meta name=twitter:description content="A stateless etcd reverse proxy operating at the gRPC layer"></head><body class=td-page><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><h1>gRPC proxy</h1><div class=lead>A stateless etcd reverse proxy operating at the gRPC layer</div><p>The gRPC proxy is a stateless etcd reverse proxy operating at the gRPC layer (L7). The proxy is designed to reduce the total processing load on the core etcd cluster. For horizontal scalability, it coalesces watch and lease API requests. To protect the cluster against abusive clients, it caches key range requests.</p><p>The gRPC proxy supports multiple etcd server endpoints. When the proxy starts, it randomly picks one etcd server endpoint to use. This endpoint serves all requests until the proxy detects an endpoint failure. If the gRPC proxy detects an endpoint failure, it switches to a different endpoint, if available, to hide failures from its clients. Other retry policies, such as weighted round-robin, may be supported in the future.</p><h2 id=scalable-watch-api>Scalable watch API</h2><p>The gRPC proxy coalesces multiple client watchers (<code>c-watchers</code>) on the same key or range into a single watcher (<code>s-watcher</code>) connected to an etcd server. The proxy broadcasts all events from the <code>s-watcher</code> to its <code>c-watchers</code>.</p><p>Assuming N clients watch the same key, one gRPC proxy can reduce the watch load on the etcd server from N to 1. Users can deploy multiple gRPC proxies to further distribute server load.</p><p>In the following example, three clients watch on key A. The gRPC proxy coalesces the three watchers, creating a single watcher attached to the etcd server.</p><pre tabindex=0><code>            +-------------+
            | etcd server |
            +------+------+
                   ^ watch key A (s-watcher)
                   |
           +-------+-----+
           | gRPC proxy  | &lt;-------+
           |             |         |
           ++-----+------+         |watch key A (c-watcher)
watch key A ^     ^ watch key A    |
(c-watcher) |     | (c-watcher)    |
    +-------+-+  ++--------+  +----+----+
    |  client |  |  client |  |  client |
    |         |  |         |  |         |
    +---------+  +---------+  +---------+
</code></pre><h3 id=limitations>Limitations</h3><p>To effectively coalesce multiple client watchers into a single watcher, the gRPC proxy coalesces new <code>c-watchers</code> into an existing <code>s-watcher</code> when possible. This coalesced <code>s-watcher</code> may be out of sync with the etcd server due to network delays or buffered undelivered events. When the watch revision is unspecified, the gRPC proxy will not guarantee the <code>c-watcher</code> will start watching from the most recent store revision. For example, if a client watches from an etcd server with revision 1000, that watcher will begin at revision 1000. If a client watches from the gRPC proxy, may begin watching from revision 990.</p><p>Similar limitations apply to cancellation. When the watcher is cancelled, the etcd serverâ€™s revision may be greater than the cancellation response revision.</p><p>These two limitations should not cause problems for most use cases. In the future, there may be additional options to force the watcher to bypass the gRPC proxy for more accurate revision responses.</p><h2 id=scalable-lease-api>Scalable lease API</h2><p>To keep its leases alive, a client must establish at least one gRPC stream to an etcd server for sending periodic heartbeats. If an etcd workload involves heavy lease activity spread over many clients, these streams may contribute to excessive CPU utilization. To reduce the total number of streams on the core cluster, the proxy supports lease stream coalescing.</p><p>Assuming N clients are updating leases, a single gRPC proxy reduces the stream load on the etcd server from N to 1. Deployments may have additional gRPC proxies to further distribute streams across multiple proxies.</p><p>In the following example, three clients update three independent leases (<code>L1</code>, <code>L2</code>, and <code>L3</code>). The gRPC proxy coalesces the three client lease streams (<code>c-streams</code>) into a single lease keep alive stream (<code>s-stream</code>) attached to an etcd server. The proxy forwards client-side lease heartbeats from the c-streams to the s-stream, then returns the responses to the corresponding c-streams.</p><pre tabindex=0><code>          +-------------+
          | etcd server |
          +------+------+
                 ^
                 | heartbeat L1, L2, L3
                 | (s-stream)
                 v
         +-------+-----+
         | gRPC proxy  +&lt;-----------+
         +---+------+--+            | heartbeat L3
             ^      ^               | (c-stream)
heartbeat L1 |      | heartbeat L2  |
(c-stream)   v      v (c-stream)    v
      +------+-+  +-+------+  +-----+--+
      | client |  | client |  | client |
      +--------+  +--------+  +--------+
</code></pre><h2 id=abusive-clients-protection>Abusive clients protection</h2><p>The gRPC proxy caches responses for requests when it does not break consistency requirements. This can protect the etcd server from abusive clients in tight for loops.</p><h2 id=start-etcd-grpc-proxy>Start etcd gRPC proxy</h2><p>Consider an etcd cluster with the following static endpoints:</p><table><thead><tr><th>Name</th><th>Address</th><th>Hostname</th></tr></thead><tbody><tr><td>infra0</td><td>10.0.1.10</td><td>infra0.example.com</td></tr><tr><td>infra1</td><td>10.0.1.11</td><td>infra1.example.com</td></tr><tr><td>infra2</td><td>10.0.1.12</td><td>infra2.example.com</td></tr></tbody></table><p>Start the etcd gRPC proxy to use these static endpoints with the command:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ etcd grpc-proxy start --endpoints<span style=color:#ce5c00;font-weight:700>=</span>infra0.example.com,infra1.example.com,infra2.example.com --listen-addr<span style=color:#ce5c00;font-weight:700>=</span>127.0.0.1:2379
</span></span></code></pre></div><p>The etcd gRPC proxy starts and listens on port 2379. It forwards client requests to one of the three endpoints provided above.</p><p>Sending requests through the proxy:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#000>ETCDCTL_API</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span> etcdctl --endpoints<span style=color:#ce5c00;font-weight:700>=</span>127.0.0.1:2379 put foo bar
</span></span><span style=display:flex><span>OK
</span></span><span style=display:flex><span>$ <span style=color:#000>ETCDCTL_API</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span> etcdctl --endpoints<span style=color:#ce5c00;font-weight:700>=</span>127.0.0.1:2379 get foo
</span></span><span style=display:flex><span>foo
</span></span><span style=display:flex><span>bar
</span></span></code></pre></div><h2 id=client-endpoint-synchronization-and-name-resolution>Client endpoint synchronization and name resolution</h2><p>The proxy supports registering its endpoints for discovery by writing to a user-defined endpoint. This serves two purposes. First, it allows clients to synchronize their endpoints against a set of proxy endpoints for high availability. Second, it is an endpoint provider for etcd <a href=../../dev-guide/grpc_naming/>gRPC naming</a>.</p><p>Register proxy(s) by providing a user-defined prefix:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ etcd grpc-proxy start --endpoints<span style=color:#ce5c00;font-weight:700>=</span>localhost:2379 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --listen-addr<span style=color:#ce5c00;font-weight:700>=</span>127.0.0.1:23790 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --advertise-client-url<span style=color:#ce5c00;font-weight:700>=</span>127.0.0.1:23790 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --resolver-prefix<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;___grpc_proxy_endpoint&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --resolver-ttl<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>60</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>$ etcd grpc-proxy start --endpoints<span style=color:#ce5c00;font-weight:700>=</span>localhost:2379 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --listen-addr<span style=color:#ce5c00;font-weight:700>=</span>127.0.0.1:23791 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --advertise-client-url<span style=color:#ce5c00;font-weight:700>=</span>127.0.0.1:23791 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --resolver-prefix<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;___grpc_proxy_endpoint&#34;</span> <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --resolver-ttl<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>60</span>
</span></span></code></pre></div><p>The proxy will list all its members for member list:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>ETCDCTL_API</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span> etcdctl --endpoints<span style=color:#ce5c00;font-weight:700>=</span>http://localhost:23790 member list --write-out table
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>+----+---------+--------------------------------+------------+-----------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> ID <span style=color:#000;font-weight:700>|</span> STATUS  <span style=color:#000;font-weight:700>|</span>              NAME              <span style=color:#000;font-weight:700>|</span> PEER ADDRS <span style=color:#000;font-weight:700>|</span>  CLIENT ADDRS   <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+----+---------+--------------------------------+------------+-----------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> started <span style=color:#000;font-weight:700>|</span> Gyu-Hos-MBP.sfo.coreos.systems <span style=color:#000;font-weight:700>|</span>            <span style=color:#000;font-weight:700>|</span> 127.0.0.1:23791 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> started <span style=color:#000;font-weight:700>|</span> Gyu-Hos-MBP.sfo.coreos.systems <span style=color:#000;font-weight:700>|</span>            <span style=color:#000;font-weight:700>|</span> 127.0.0.1:23790 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+----+---------+--------------------------------+------------+-----------------+
</span></span></code></pre></div><p>This lets clients automatically discover proxy endpoints through Sync:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000>cli</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>clientv3</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>New</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>clientv3</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Config</span><span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>Endpoints</span><span style=color:#000;font-weight:700>:</span> <span style=color:#000;font-weight:700>[]</span><span style=color:#204a87;font-weight:700>string</span><span style=color:#000;font-weight:700>{</span><span style=color:#4e9a06>&#34;http://localhost:23790&#34;</span><span style=color:#000;font-weight:700>},</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>})</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Fatal</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>defer</span> <span style=color:#000>cli</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Close</span><span style=color:#000;font-weight:700>()</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic>// fetch registered grpc-proxy endpoints</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>cli</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Sync</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Background</span><span style=color:#000;font-weight:700>());</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#000>log</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Fatal</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>err</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span></code></pre></div><p>Note that if a proxy is configured without a resolver prefix,</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ etcd grpc-proxy start --endpoints<span style=color:#ce5c00;font-weight:700>=</span>localhost:2379 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --listen-addr<span style=color:#ce5c00;font-weight:700>=</span>127.0.0.1:23792 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --advertise-client-url<span style=color:#ce5c00;font-weight:700>=</span>127.0.0.1:23792
</span></span></code></pre></div><p>The member list API to the grpc-proxy returns its own <code>advertise-client-url</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#000>ETCDCTL_API</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span> etcdctl --endpoints<span style=color:#ce5c00;font-weight:700>=</span>http://localhost:23792 member list --write-out table
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>+----+---------+--------------------------------+------------+-----------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span> ID <span style=color:#000;font-weight:700>|</span> STATUS  <span style=color:#000;font-weight:700>|</span>              NAME              <span style=color:#000;font-weight:700>|</span> PEER ADDRS <span style=color:#000;font-weight:700>|</span>  CLIENT ADDRS   <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+----+---------+--------------------------------+------------+-----------------+
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>|</span>  <span style=color:#0000cf;font-weight:700>0</span> <span style=color:#000;font-weight:700>|</span> started <span style=color:#000;font-weight:700>|</span> Gyu-Hos-MBP.sfo.coreos.systems <span style=color:#000;font-weight:700>|</span>            <span style=color:#000;font-weight:700>|</span> 127.0.0.1:23792 <span style=color:#000;font-weight:700>|</span>
</span></span><span style=display:flex><span>+----+---------+--------------------------------+------------+-----------------+
</span></span></code></pre></div><h2 id=namespacing>Namespacing</h2><p>Suppose an application expects full control over the entire key space, but the etcd cluster is shared with other applications. To let all applications run without interfering with each other, the proxy can partition the etcd keyspace so clients appear to have access to the complete keyspace. When the proxy is given the flag <code>--namespace</code>, all client requests going into the proxy are translated to have a user-defined prefix on the keys. Accesses to the etcd cluster will be under the prefix and responses from the proxy will strip away the prefix; to the client, it appears as if there is no prefix at all.</p><p>To namespace a proxy, start it with <code>--namespace</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ etcd grpc-proxy start --endpoints<span style=color:#ce5c00;font-weight:700>=</span>localhost:2379 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --listen-addr<span style=color:#ce5c00;font-weight:700>=</span>127.0.0.1:23790 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --namespace<span style=color:#ce5c00;font-weight:700>=</span>my-prefix/
</span></span></code></pre></div><p>Accesses to the proxy are now transparently prefixed on the etcd cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ <span style=color:#000>ETCDCTL_API</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span> etcdctl --endpoints<span style=color:#ce5c00;font-weight:700>=</span>localhost:23790 put my-key abc
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># OK</span>
</span></span><span style=display:flex><span>$ <span style=color:#000>ETCDCTL_API</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span> etcdctl --endpoints<span style=color:#ce5c00;font-weight:700>=</span>localhost:23790 get my-key
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># my-key</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># abc</span>
</span></span><span style=display:flex><span>$ <span style=color:#000>ETCDCTL_API</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span> etcdctl --endpoints<span style=color:#ce5c00;font-weight:700>=</span>localhost:2379 get my-prefix/my-key
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># my-prefix/my-key</span>
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># abc</span>
</span></span></code></pre></div><h2 id=tls-termination>TLS termination</h2><p>Terminate TLS from a secure etcd cluster with the gRPC proxy by serving an unencrypted local endpoint.</p><p>To try it out, start a single member etcd cluster with client https:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ etcd --listen-client-urls https://localhost:2379 --advertise-client-urls https://localhost:2379 --cert-file<span style=color:#ce5c00;font-weight:700>=</span>peer.crt --key-file<span style=color:#ce5c00;font-weight:700>=</span>peer.key --trusted-ca-file<span style=color:#ce5c00;font-weight:700>=</span>ca.crt --client-cert-auth
</span></span></code></pre></div><p>Confirm the client port is serving https:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#8f5902;font-style:italic># fails</span>
</span></span><span style=display:flex><span>$ <span style=color:#000>ETCDCTL_API</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span> etcdctl --endpoints<span style=color:#ce5c00;font-weight:700>=</span>http://localhost:2379 endpoint status
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># works</span>
</span></span><span style=display:flex><span>$ <span style=color:#000>ETCDCTL_API</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span> etcdctl --endpoints<span style=color:#ce5c00;font-weight:700>=</span>https://localhost:2379 --cert<span style=color:#ce5c00;font-weight:700>=</span>client.crt --key<span style=color:#ce5c00;font-weight:700>=</span>client.key --cacert<span style=color:#ce5c00;font-weight:700>=</span>ca.crt endpoint status
</span></span></code></pre></div><p>Next, start a gRPC proxy on <code>localhost:12379</code> by connecting to the etcd endpoint <code>https://localhost:2379</code> using the client certificates:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ etcd grpc-proxy start --endpoints<span style=color:#ce5c00;font-weight:700>=</span>https://localhost:2379 --listen-addr localhost:12379 --cert client.crt --key client.key --cacert<span style=color:#ce5c00;font-weight:700>=</span>ca.crt --insecure-skip-tls-verify <span style=color:#000;font-weight:700>&amp;</span>
</span></span></code></pre></div><p>Finally, test the TLS termination by putting a key into the proxy over http:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ <span style=color:#000>ETCDCTL_API</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span> etcdctl --endpoints<span style=color:#ce5c00;font-weight:700>=</span>http://localhost:12379 put abc def
</span></span><span style=display:flex><span><span style=color:#8f5902;font-style:italic># OK</span>
</span></span></code></pre></div><h2 id=metrics-and-health>Metrics and Health</h2><p>The gRPC proxy exposes <code>/health</code> and Prometheus <code>/metrics</code> endpoints for the etcd members defined by <code>--endpoints</code>. An alternative define an additional URL that will respond to both the <code>/metrics</code> and <code>/health</code> endpoints with the <code>--metrics-addr</code> flag.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ etcd grpc-proxy start <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --endpoints https://localhost:2379 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --metrics-addr https://0.0.0.0:4443 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --listen-addr 127.0.0.1:23790 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --key client.key <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --key-file proxy-server.key <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --cert client.crt <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --cert-file proxy-server.crt <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --cacert ca.pem <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --trusted-ca-file proxy-ca.pem
</span></span></code></pre></div><h3 id=known-issue>Known issue</h3><p>The main interface of the proxy serves both HTTP2 and HTTP/1.1. If proxy is setup with TLS as show in the above example, when using a client such as cURL against the listening interface will require explicitly setting the protocol to HTTP/1.1 on the request to return <code>/metrics</code> or <code>/health</code>. By using the <code>--metrics-addr</code> flag the secondary interface will not have this requirement.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span> $ curl --cacert proxy-ca.pem --key proxy-client.key --cert proxy-client.crt https://127.0.0.1:23790/metrics --http1.1
</span></span></code></pre></div><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p></div><br><div class=td-page-meta__lastmod>Last modified April 9, 2022: <a href=https://github.com/etcd-io/website/commit/a2da31e79a3db4d5c40bc46c32f9c952b67ffdd4>Fix typos (a2da31e)</a></div></div></main></div></div></div></body></html>