<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Runtime reconfiguration | etcd</title>
<meta name=description content="etcd incremental runtime reconfiguration support"><meta property="og:url" content="https://etcd.io/docs/v3.5/op-guide/runtime-configuration/"><meta property="og:site_name" content="etcd"><meta property="og:title" content="Runtime reconfiguration"><meta property="og:description" content="etcd incremental runtime reconfiguration support"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2021-10-26T19:14:25-04:00"><meta itemprop=name content="Runtime reconfiguration"><meta itemprop=description content="etcd incremental runtime reconfiguration support"><meta itemprop=dateModified content="2021-10-26T19:14:25-04:00"><meta itemprop=wordCount content="1839"><meta name=twitter:card content="summary"><meta name=twitter:title content="Runtime reconfiguration"><meta name=twitter:description content="etcd incremental runtime reconfiguration support"></head><body class=td-page><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><h1>Runtime reconfiguration</h1><div class=lead>etcd incremental runtime reconfiguration support</div><p>etcd comes with support for incremental runtime reconfiguration, which allows users to update the membership of the cluster at run time.</p><p>Reconfiguration requests can only be processed when a majority of cluster members are functioning. It is <strong>highly recommended</strong> to always have a cluster size greater than two in production. It is unsafe to remove a member from a two member cluster. The majority of a two member cluster is also two. If there is a failure during the removal process, the cluster might not be able to make progress and need to <a href=#restart-cluster-from-majority-failure>restart from majority failure</a>.</p><p>To better understand the design behind runtime reconfiguration, please read <a href=../runtime-reconf-design/>the runtime reconfiguration document</a>.</p><h2 id=reconfiguration-use-cases>Reconfiguration use cases</h2><p>This section will walk through some common reasons for reconfiguring a cluster. Most of these reasons just involve combinations of adding or removing a member, which are explained below under <a href=#cluster-reconfiguration-operations>Cluster Reconfiguration Operations</a>.</p><h3 id=cycle-or-upgrade-multiple-machines>Cycle or upgrade multiple machines</h3><p>If multiple cluster members need to move due to planned maintenance (hardware upgrades, network downtime, etc.), it is recommended to modify members one at a time.</p><p>It is safe to remove the leader, however there is a brief period of downtime while the election process takes place. If the cluster holds more than 50MB of v2 data, it is recommended to <a href=/docs/v2.3/admin_guide/#member-migration>migrate the member&rsquo;s data directory</a>.</p><h3 id=change-the-cluster-size>Change the cluster size</h3><p>Increasing the cluster size can enhance <a href=/docs/v2.3/admin_guide/#fault-tolerance-table>failure tolerance</a> and provide better read performance. Since clients can read from any member, increasing the number of members increases the overall serialized read throughput.</p><p>Decreasing the cluster size can improve the write performance of a cluster, with a trade-off of decreased resilience. Writes into the cluster are replicated to a majority of members of the cluster before considered committed. Decreasing the cluster size lowers the majority, and each write is committed more quickly.</p><h3 id=replace-a-failed-machine>Replace a failed machine</h3><p>If a machine fails due to hardware failure, data directory corruption, or some other fatal situation, it should be replaced as soon as possible. Machines that have failed but haven&rsquo;t been removed adversely affect the quorum and reduce the tolerance for an additional failure.</p><p>To replace the machine, follow the instructions for <a href=#remove-a-member>removing the member</a> from the cluster, and then <a href=#add-a-new-member>add a new member</a> in its place. If the cluster holds more than 50MB, it is recommended to <a href=/docs/v2.3/admin_guide/#member-migration>migrate the failed member&rsquo;s data directory</a> if it is still accessible.</p><h3 id=restart-cluster-from-majority-failure>Restart cluster from majority failure</h3><p>If the majority of the cluster is lost or all of the nodes have changed IP addresses, then manual action is necessary to recover safely. The basic steps in the recovery process include <a href=../recovery>creating a new cluster using the old data</a>, forcing a single member to act as the leader, and finally using runtime configuration to <a href=#add-a-new-member>add new members</a> to this new cluster one at a time.</p><h3 id=recover-cluster-from-minority-failure>Recover cluster from minority failure</h3><p>If a specific member is lost, then it is equivalent to replacing a failed machine. The steps are mentioned in <a href=../runtime-configuration/#replace-a-failed-machine>Replace a failed machine</a>.</p><h2 id=cluster-reconfiguration-operations>Cluster reconfiguration operations</h2><p>With these use cases in mind, the involved operations can be described for each.</p><p>Before making any change, a simple majority (quorum) of etcd members must be available. This is essentially the same requirement for any kind of write to etcd.</p><p>All changes to the cluster must be done sequentially:</p><ul><li>To update a single member peerURLs, issue an update operation</li><li>To replace a healthy single member, remove the old member then add a new member</li><li>To increase from 3 to 5 members, issue two add operations</li><li>To decrease from 5 to 3, issue two remove operations</li></ul><p>All of these examples use the <code>etcdctl</code> command line tool that ships with etcd. To change membership without <code>etcdctl</code>, use the <a href=/docs/v2.3/members_api/>v2 HTTP members API</a> or the <a href=../../dev-guide/api_reference_v3/>v3 gRPC members API</a>.</p><h3 id=update-a-member>Update a member</h3><h4 id=update-advertise-client-urls>Update advertise client URLs</h4><p>To update the advertise client URLs of a member, simply restart that member with updated client urls flag (<code>--advertise-client-urls</code>) or environment variable (<code>ETCD_ADVERTISE_CLIENT_URLS</code>). The restarted member will self publish the updated URLs. A wrongly updated client URL will not affect the health of the etcd cluster.</p><h4 id=update-advertise-peer-urls>Update advertise peer URLs</h4><p>To update the advertise peer URLs of a member, first update it explicitly via member command and then restart the member. The additional action is required since updating peer URLs changes the cluster wide configuration and can affect the health of the etcd cluster.</p><p>To update the advertise peer URLs, first find the target member&rsquo;s ID. To list all members with <code>etcdctl</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ etcdctl member list
</span></span><span style=display:flex><span>6e3bd23ae5f1eae0: <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span>node2 <span style=color:#000>peerURLs</span><span style=color:#ce5c00;font-weight:700>=</span>http://localhost:23802 <span style=color:#000>clientURLs</span><span style=color:#ce5c00;font-weight:700>=</span>http://127.0.0.1:23792
</span></span><span style=display:flex><span>924e2e83e93f2560: <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span>node3 <span style=color:#000>peerURLs</span><span style=color:#ce5c00;font-weight:700>=</span>http://localhost:23803 <span style=color:#000>clientURLs</span><span style=color:#ce5c00;font-weight:700>=</span>http://127.0.0.1:23793
</span></span><span style=display:flex><span>a8266ecf031671f3: <span style=color:#000>name</span><span style=color:#ce5c00;font-weight:700>=</span>node1 <span style=color:#000>peerURLs</span><span style=color:#ce5c00;font-weight:700>=</span>http://localhost:23801 <span style=color:#000>clientURLs</span><span style=color:#ce5c00;font-weight:700>=</span>http://127.0.0.1:23791
</span></span></code></pre></div><p>This example will <code>update</code> a8266ecf031671f3 member ID and change its peerURLs value to <code>http://10.0.1.10:2380</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ etcdctl member update a8266ecf031671f3 --peer-urls<span style=color:#ce5c00;font-weight:700>=</span>http://10.0.1.10:2380
</span></span><span style=display:flex><span>Updated member with ID a8266ecf031671f3 in cluster
</span></span></code></pre></div><h3 id=remove-a-member>Remove a member</h3><p>Suppose the member ID to remove is a8266ecf031671f3. Use the <code>remove</code> command to perform the removal:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ etcdctl member remove a8266ecf031671f3
</span></span><span style=display:flex><span>Removed member a8266ecf031671f3 from cluster
</span></span></code></pre></div><p>The target member will stop itself at this point and print out the removal in the log:</p><pre tabindex=0><code>etcd: this member has been permanently removed from the cluster. Exiting.
</code></pre><p>It is safe to remove the leader, however the cluster will be inactive while a new leader is elected. This duration is normally the period of election timeout plus the voting process.</p><h3 id=add-a-new-member>Add a new member</h3><p>Adding a member is a two step process:</p><ul><li>Add the new member to the cluster via the <a href=/docs/v2.3/members_api/>HTTP members API</a>, the <a href=../../dev-guide/api_reference_v3/>gRPC members API</a>, or the <code>etcdctl member add</code> command.</li><li>Start the new member with the new cluster configuration, including a list of the updated members (existing members + the new member).</li></ul><p><code>etcdctl</code> adds a new member to the cluster by specifying the member&rsquo;s <a href=../configuration#member>name</a> and <a href=../configuration#clustering>advertised peer URLs</a>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ etcdctl member add infra3 --peer-urls<span style=color:#ce5c00;font-weight:700>=</span>http://10.0.1.13:2380
</span></span><span style=display:flex><span>added member 9bf1b35fc7761a23 to cluster
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>ETCD_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;infra3&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>ETCD_INITIAL_CLUSTER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;infra0=http://10.0.1.10:2380,infra1=http://10.0.1.11:2380,infra2=http://10.0.1.12:2380,infra3=http://10.0.1.13:2380&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>ETCD_INITIAL_CLUSTER_STATE</span><span style=color:#ce5c00;font-weight:700>=</span>existing
</span></span></code></pre></div><p><code>etcdctl</code> has informed the cluster about the new member and printed out the environment variables needed to successfully start it. Now start the new etcd process with the relevant flags for the new member:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ <span style=color:#204a87>export</span> <span style=color:#000>ETCD_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;infra3&#34;</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>export</span> <span style=color:#000>ETCD_INITIAL_CLUSTER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;infra0=http://10.0.1.10:2380,infra1=http://10.0.1.11:2380,infra2=http://10.0.1.12:2380,infra3=http://10.0.1.13:2380&#34;</span>
</span></span><span style=display:flex><span>$ <span style=color:#204a87>export</span> <span style=color:#000>ETCD_INITIAL_CLUSTER_STATE</span><span style=color:#ce5c00;font-weight:700>=</span>existing
</span></span><span style=display:flex><span>$ etcd --listen-client-urls http://10.0.1.13:2379 --advertise-client-urls http://10.0.1.13:2379 --listen-peer-urls http://10.0.1.13:2380 --initial-advertise-peer-urls http://10.0.1.13:2380 --data-dir %data_dir%
</span></span></code></pre></div><p>The new member will run as a part of the cluster and immediately begin catching up with the rest of the cluster.</p><p>If adding multiple members the best practice is to configure a single member at a time and verify it starts correctly before adding more new members. If adding a new member to a 1-node cluster, the cluster cannot make progress before the new member starts because it needs two members as majority to agree on the consensus. This behavior only happens between the time <code>etcdctl member add</code> informs the cluster about the new member and the new member successfully establishing a connection to the existing one.</p><h4 id=add-a-new-member-as-learner>Add a new member as learner</h4><p>Starting from v3.4, etcd supports adding a new member as learner / non-voting member.
The motivation and design can be found in <a href=../../learning/design-learner>design doc</a>.
In order to make the process of adding a new member safer,
and to reduce cluster downtime when the new member is added, it is recommended that the new member is added to cluster
as a learner until it catches up. This can be described as a three step process:</p><ul><li><p>Add the new member as learner via <a href=../../dev-guide/api_reference_v3/>gRPC members API</a> or the <code>etcdctl member add --learner</code> command.</p></li><li><p>Start the new member with the new cluster configuration, including a list of the updated members (existing members + the new member).
This step is exactly the same as before.</p></li><li><p>Promote the newly added learner to voting member via <a href=../../dev-guide/api_reference_v3/>gRPC members API</a> or the <code>etcdctl member promote</code> command.
etcd server validates promote request to ensure its operational safety.
Only after its raft log has caught up to leader’s can learner be promoted to a voting member.
If a learner member has not caught up to leader&rsquo;s raft log, member promote request will fail
(see <a href=#error-cases-when-promoting-a-learner-member>error cases when promoting a member</a> section for more details).
In this case, user should wait and retry later.</p></li></ul><p>In v3.4, etcd server limits the number of learners that cluster can have to one. The main consideration is to limit the
extra workload on leader due to propagating data from leader to learner.</p><p>Use <code>etcdctl member add</code> with flag <code>--learner</code> to add new member to cluster as learner.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ etcdctl member add infra3 --peer-urls<span style=color:#ce5c00;font-weight:700>=</span>http://10.0.1.13:2380 --learner
</span></span><span style=display:flex><span>Member 9bf1b35fc7761a23 added to cluster a7ef944b95711739
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>ETCD_NAME</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;infra3&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>ETCD_INITIAL_CLUSTER</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>&#34;infra0=http://10.0.1.10:2380,infra1=http://10.0.1.11:2380,infra2=http://10.0.1.12:2380,infra3=http://10.0.1.13:2380&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000>ETCD_INITIAL_CLUSTER_STATE</span><span style=color:#ce5c00;font-weight:700>=</span>existing
</span></span></code></pre></div><p>After new etcd process is started for the newly added learner member, use <code>etcdctl member promote</code> to promote learner to voting member.</p><pre tabindex=0><code>$ etcdctl member promote 9bf1b35fc7761a23
Member 9e29bbaa45d74461 promoted in cluster a7ef944b95711739
</code></pre><h4 id=error-cases-when-adding-members>Error cases when adding members</h4><p>In the following case a new host is not included in the list of enumerated nodes. If this is a new cluster, the node must be added to the list of initial cluster members.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ etcd --name infra3 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --initial-cluster <span style=color:#000>infra0</span><span style=color:#ce5c00;font-weight:700>=</span>http://10.0.1.10:2380,infra1<span style=color:#ce5c00;font-weight:700>=</span>http://10.0.1.11:2380,infra2<span style=color:#ce5c00;font-weight:700>=</span>http://10.0.1.12:2380 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --initial-cluster-state existing
</span></span><span style=display:flex><span>etcdserver: assign ids error: the member count is unequal
</span></span><span style=display:flex><span><span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span></code></pre></div><p>In this case, give a different address (10.0.1.14:2380) from the one used to join the cluster (10.0.1.13:2380):</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ etcd --name infra4 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --initial-cluster <span style=color:#000>infra0</span><span style=color:#ce5c00;font-weight:700>=</span>http://10.0.1.10:2380,infra1<span style=color:#ce5c00;font-weight:700>=</span>http://10.0.1.11:2380,infra2<span style=color:#ce5c00;font-weight:700>=</span>http://10.0.1.12:2380,infra4<span style=color:#ce5c00;font-weight:700>=</span>http://10.0.1.14:2380 <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  --initial-cluster-state existing
</span></span><span style=display:flex><span>etcdserver: assign ids error: unmatched member <span style=color:#204a87;font-weight:700>while</span> checking PeerURLs
</span></span><span style=display:flex><span><span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span></code></pre></div><p>If etcd starts using the data directory of a removed member, etcd automatically exits if it connects to any active member in the cluster:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>$ etcd
</span></span><span style=display:flex><span>etcd: this member has been permanently removed from the cluster. Exiting.
</span></span><span style=display:flex><span><span style=color:#204a87>exit</span> <span style=color:#0000cf;font-weight:700>1</span>
</span></span></code></pre></div><h4 id=error-cases-when-adding-a-learner-member>Error cases when adding a learner member</h4><p>Cannot add learner to cluster if the cluster already has 1 learner (v3.4).</p><pre tabindex=0><code>$ etcdctl member add infra4 --peer-urls=http://10.0.1.14:2380 --learner
Error: etcdserver: too many learner members in cluster
</code></pre><h4 id=error-cases-when-promoting-a-learner-member>Error cases when promoting a learner member</h4><p>Learner can only be promoted to voting member if it is in sync with leader.</p><pre tabindex=0><code>$ etcdctl member promote 9bf1b35fc7761a23
Error: etcdserver: can only promote a learner member which is in sync with leader
</code></pre><p>Promoting a member that is not a learner will fail.</p><pre tabindex=0><code>$ etcdctl member promote 9bf1b35fc7761a23
Error: etcdserver: can only promote a learner member
</code></pre><p>Promoting a member that does not exist in cluster will fail.</p><pre tabindex=0><code>$ etcdctl member promote 12345abcde
Error: etcdserver: member not found
</code></pre><h3 id=strict-reconfiguration-check-mode--strict-reconfig-check>Strict reconfiguration check mode (<code>-strict-reconfig-check</code>)</h3><p>As described in the above, the best practice of adding new members is to configure a single member at a time and verify it starts correctly before adding more new members. This step by step approach is very important because if newly added members is not configured correctly (for example the peer URLs are incorrect), the cluster can lose quorum. The quorum loss happens since the newly added member are counted in the quorum even if that member is not reachable from other existing members. Also quorum loss might happen if there is a connectivity issue or there are operational issues.</p><p>For avoiding this problem, etcd provides an option <code>-strict-reconfig-check</code>. If this option is passed to etcd, etcd rejects reconfiguration requests if the number of started members will be less than a quorum of the reconfigured cluster.</p><p>It is enabled by default.</p><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p></div><br><div class=td-page-meta__lastmod>Last modified October 26, 2021: <a href=https://github.com/etcd-io/website/commit/29c07319e2f7b01f9b6b4ed9b8c389d534bb2e8b>Configuration page rework: remove duplication, make easier to maintain, add missing flag (#491) (29c0731)</a></div></div></main></div></div></div></body></html>