<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Storage Memory Usage Benchmark | etcd</title>
<meta name=description content="Performance measures for etcd storage (in-memory index & page cache)"><meta property="og:url" content="https://etcd.io/docs/v3.5/benchmarks/etcd-storage-memory-benchmark/"><meta property="og:site_name" content="etcd"><meta property="og:title" content="Storage Memory Usage Benchmark"><meta property="og:description" content="Performance measures for etcd storage (in-memory index & page cache)"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2021-06-14T17:16:50+00:00"><meta itemprop=name content="Storage Memory Usage Benchmark"><meta itemprop=description content="Performance measures for etcd storage (in-memory index & page cache)"><meta itemprop=dateModified content="2021-06-14T17:16:50+00:00"><meta itemprop=wordCount content="572"><meta name=twitter:card content="summary"><meta name=twitter:title content="Storage Memory Usage Benchmark"><meta name=twitter:description content="Performance measures for etcd storage (in-memory index & page cache)"></head><body class=td-page><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><h1>Storage Memory Usage Benchmark</h1><div class=lead>Performance measures for etcd storage (in-memory index & page cache)</div><p>Two components of etcd storage consume physical memory. The etcd process allocates an <em>in-memory index</em> to speed key lookup. The process&rsquo;s <em>page cache</em>, managed by the operating system, stores recently-accessed data from disk for quick re-use.</p><p>The in-memory index holds all the keys in a <a href=https://en.wikipedia.org/wiki/B-tree target=_blank rel=noopener>B-tree</a> data structure, along with pointers to the on-disk data (the values). Each key in the B-tree may contain multiple pointers, pointing to different versions of its values. The theoretical memory consumption of the in-memory index can hence be approximated with the formula:</p><p><code>N * (c1 + avg_key_size) + N * (avg_versions_of_key) * (c2 + size_of_pointer)</code></p><p>where <code>c1</code> is the key metadata overhead and <code>c2</code> is the version metadata overhead.</p><p>The graph shows the detailed structure of the in-memory index B-tree.</p><pre tabindex=0><code>

                                In mem index

                               +------------+
                               | key || ... |
  +--------------+             |     ||     |
  |              |             +------------+
  |              |             | v1  || ... |
  |   disk    &lt;----------------|     ||     | Tree Node
  |              |             +------------+
  |              |             | v2  || ... |
  |           &lt;----------------+     ||     |
  |              |             +------------+
  +--------------+       +-----+    |   |   |
                         |     |    |   |   |
                         |     +------------+
                         |
                         |
                         ^
                      ------+
                      | ... |
                      |     |
                      +-----+
                      | ... | Tree Node
                      |     |
                      +-----+
                      | ... |
                      |     |
                      ------+
</code></pre><p><a href=https://en.wikipedia.org/wiki/Page_cache target=_blank rel=noopener>Page cache memory</a> is managed by the operating system and is not covered in detail in this document.</p><h2 id=testing-environment>Testing Environment</h2><p>etcd version</p><ul><li>git head <a href=https://github.com/etcd-io/etcd/commit/776e9fb7be7eee5e6b58ab977c8887b4fe4d48db target=_blank rel=noopener>https://github.com/etcd-io/etcd/commit/776e9fb7be7eee5e6b58ab977c8887b4fe4d48db</a></li></ul><p>GCE n1-standard-2 machine type</p><ul><li>7.5 GB memory</li><li>2x CPUs</li></ul><h2 id=in-memory-index-memory-usage>In-memory index memory usage</h2><p>In this test, we only benchmark the memory usage of the in-memory index. The goal is to find <code>c1</code> and <code>c2</code> mentioned above and to understand the hard limit of memory consumption of the storage.</p><p>We calculate the memory usage consumption via the Go runtime.ReadMemStats. We calculate the total allocated bytes difference before creating the index and after creating the index. It cannot perfectly reflect the memory usage of the in-memory index itself but can show the rough consumption pattern.</p><table><thead><tr><th>N</th><th>versions</th><th>key size</th><th>memory usage</th></tr></thead><tbody><tr><td>100K</td><td>1</td><td>64bytes</td><td>22MB</td></tr><tr><td>100K</td><td>5</td><td>64bytes</td><td>39MB</td></tr><tr><td>1M</td><td>1</td><td>64bytes</td><td>218MB</td></tr><tr><td>1M</td><td>5</td><td>64bytes</td><td>432MB</td></tr><tr><td>100K</td><td>1</td><td>256bytes</td><td>41MB</td></tr><tr><td>100K</td><td>5</td><td>256bytes</td><td>65MB</td></tr><tr><td>1M</td><td>1</td><td>256bytes</td><td>409MB</td></tr><tr><td>1M</td><td>5</td><td>256bytes</td><td>506MB</td></tr></tbody></table><p>Based on the result, we can calculate <code>c1=120bytes</code>, <code>c2=30bytes</code>. We only need two sets of data to calculate <code>c1</code> and <code>c2</code>, since they are the only unknown variable in the formula. The <code>c1=120bytes</code> and <code>c2=30bytes</code> are the average value of the 4 sets of <code>c1</code> and <code>c2</code> we calculated. The key metadata overhead is still relatively nontrivial (50%) for small key-value pairs. However, this is a significant improvement over the old store, which had at least 1000% overhead.</p><h2 id=overall-memory-usage>Overall memory usage</h2><p>The overall memory usage captures how much RSS etcd consumes with the storage. The value size should have very little impact on the overall memory usage of etcd, since we keep values on disk and only retain hot values in memory, managed by the OS page cache.</p><table><thead><tr><th>N</th><th>versions</th><th>key size</th><th>value size</th><th>memory usage</th></tr></thead><tbody><tr><td>100K</td><td>1</td><td>64bytes</td><td>256bytes</td><td>40MB</td></tr><tr><td>100K</td><td>5</td><td>64bytes</td><td>256bytes</td><td>89MB</td></tr><tr><td>1M</td><td>1</td><td>64bytes</td><td>256bytes</td><td>470MB</td></tr><tr><td>1M</td><td>5</td><td>64bytes</td><td>256bytes</td><td>880MB</td></tr><tr><td>100K</td><td>1</td><td>64bytes</td><td>1KB</td><td>102MB</td></tr><tr><td>100K</td><td>5</td><td>64bytes</td><td>1KB</td><td>164MB</td></tr><tr><td>1M</td><td>1</td><td>64bytes</td><td>1KB</td><td>587MB</td></tr><tr><td>1M</td><td>5</td><td>64bytes</td><td>1KB</td><td>836MB</td></tr></tbody></table><p>Based on the result, we know the value size does not significantly impact the memory consumption. There is some minor increase due to more data held in the OS page cache.</p><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p></div><br><div class=td-page-meta__lastmod>Last modified June 14, 2021: <a href=https://github.com/etcd-io/website/commit/138926b5de44b5116fdbe63830eeaf73596e4c2c>Renaming content/en/next folder to content/en/v3.5. Updating redirects, links, and config as needed. (#363) (138926b)</a></div></div></main></div></div></div></body></html>