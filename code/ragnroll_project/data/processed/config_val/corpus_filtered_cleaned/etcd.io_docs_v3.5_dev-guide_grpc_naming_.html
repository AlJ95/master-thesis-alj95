<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>gRPC naming and discovery | etcd</title>
<meta name=description content="go-grpc: for resolving gRPC endpoints with an etcd backend"><meta property="og:url" content="https://etcd.io/docs/v3.5/dev-guide/grpc_naming/"><meta property="og:site_name" content="etcd"><meta property="og:title" content="gRPC naming and discovery"><meta property="og:description" content="go-grpc: for resolving gRPC endpoints with an etcd backend"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2024-07-30T22:45:07+08:00"><meta itemprop=name content="gRPC naming and discovery"><meta itemprop=description content="go-grpc: for resolving gRPC endpoints with an etcd backend"><meta itemprop=dateModified content="2024-07-30T22:45:07+08:00"><meta itemprop=wordCount content="361"><meta name=twitter:card content="summary"><meta name=twitter:title content="gRPC naming and discovery"><meta name=twitter:description content="go-grpc: for resolving gRPC endpoints with an etcd backend"></head><body class=td-page><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><h1>gRPC naming and discovery</h1><div class=lead>go-grpc: for resolving gRPC endpoints with an etcd backend</div><p>etcd provides a gRPC resolver to support an alternative name system that fetches endpoints from etcd for discovering gRPC services. The underlying mechanism is based on watching updates to keys prefixed with the service name.</p><h2 id=using-etcd-discovery-with-go-grpc>Using etcd discovery with go-grpc</h2><p>The etcd client provides a gRPC resolver for resolving gRPC endpoints with an etcd backend. The resolver is initialized with an etcd client:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#204a87;font-weight:700>import</span> <span style=color:#000;font-weight:700>(</span>
</span></span><span style=display:flex><span>	<span style=color:#000>clientv3</span> <span style=color:#4e9a06>&#34;go.etcd.io/etcd/client/v3&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#000>etcdnaming</span> <span style=color:#4e9a06>&#34;go.etcd.io/etcd/client/v3/naming/resolver&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#4e9a06>&#34;google.golang.org/grpc&#34;</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#ce5c00;font-weight:700>...</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>cli</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>clientv3</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewFromURL</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;http://localhost:2379&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000>r</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>etcdnaming</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewBuilder</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>cli</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#204a87;font-weight:700>if</span> <span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>!=</span> <span style=color:#204a87;font-weight:700>nil</span> <span style=color:#000;font-weight:700>{</span>
</span></span><span style=display:flex><span>    <span style=color:#8f5902;font-style:italic>// ...</span>
</span></span><span style=display:flex><span><span style=color:#000;font-weight:700>}</span>
</span></span><span style=display:flex><span><span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>gerr</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>grpc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Dial</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;my-service&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>grpc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithResolvers</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>r</span><span style=color:#000;font-weight:700>),</span> <span style=color:#000>grpc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithBlock</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#ce5c00;font-weight:700>...</span><span style=color:#000;font-weight:700>)</span>
</span></span></code></pre></div><h2 id=managing-service-endpoints>Managing service endpoints</h2><p>The etcd resolver treats all keys under the prefix of the resolution target following a &ldquo;/&rdquo; (e.g., &ldquo;foo/bar/my-service/&rdquo;)
with JSON-encoded (historically go-grpc <code>naming.Update</code>) values as potential service endpoints.
Endpoints are added to the service by creating new keys and removed from the service by deleting keys.</p><h3 id=adding-an-endpoint>Adding an endpoint</h3><p>New endpoints can be added to the service through <code>etcdctl</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#000>ETCDCTL_API</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span> etcdctl put foo/bar/my-service/1.2.3.4 <span style=color:#4e9a06>&#39;{&#34;Addr&#34;:&#34;1.2.3.4&#34;,&#34;Metadata&#34;:&#34;...&#34;}&#39;</span>
</span></span></code></pre></div><p>The etcd client&rsquo;s <code>endpoints.Manager</code> method can also register new endpoints with a key matching the <code>Addr</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#000>em</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>endpoints</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewManager</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>client</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;foo/bar/my-service&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>em</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>AddEndpoint</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TODO</span><span style=color:#000;font-weight:700>(),</span><span style=color:#4e9a06>&#34;foo/bar/my-service/e1&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>endpoints</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Endpoint</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>Addr</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;1.2.3.4&#34;</span><span style=color:#000;font-weight:700>});</span>
</span></span></code></pre></div><p>To enable round-robin load balancing when dialing service with multiple endpoints, you can set up you connection with grpc
internal round-robin load balancer:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#000>conn</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>gerr</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>grpc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Dial</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>&#34;etcd:///foo&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>grpc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithResolvers</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>etcdResolver</span><span style=color:#000;font-weight:700>),</span>
</span></span><span style=display:flex><span>		<span style=color:#000>grpc</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithDefaultServiceConfig</span><span style=color:#000;font-weight:700>(</span><span style=color:#4e9a06>`{&#34;loadBalancingPolicy&#34;:&#34;round_robin&#34;}`</span><span style=color:#000;font-weight:700>))</span>
</span></span></code></pre></div><h3 id=deleting-an-endpoint>Deleting an endpoint</h3><p>Hosts can be deleted from the service through <code>etcdctl</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#000>ETCDCTL_API</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span> etcdctl del foo/bar/my-service/1.2.3.4
</span></span></code></pre></div><p>The etcd client&rsquo;s <code>endpoints.Manager</code> method also supports deleting endpoints:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000>em</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>endpoints</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewManager</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>client</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;foo/bar/my-service&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>em</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>DeleteEndpoint</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TODO</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#4e9a06>&#34;foo/bar/my-service/e1&#34;</span><span style=color:#000;font-weight:700>);</span>
</span></span></code></pre></div><h3 id=registering-an-endpoint-with-a-lease>Registering an endpoint with a lease</h3><p>Registering an endpoint with a lease ensures that if the host can&rsquo;t maintain a keepalive heartbeat (e.g., its machine fails), it will be removed from the service:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span><span style=color:#000>lease</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#4e9a06>`</span><span style=color:#000>ETCDCTL_API</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span> etcdctl lease grant <span style=color:#0000cf;font-weight:700>5</span> <span style=color:#000;font-weight:700>|</span> cut -f2 -d<span style=color:#4e9a06>&#39; &#39;</span><span style=color:#4e9a06>`</span>
</span></span><span style=display:flex><span><span style=color:#000>ETCDCTL_API</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span> etcdctl put --lease<span style=color:#ce5c00;font-weight:700>=</span><span style=color:#000>$lease</span> my-service/1.2.3.4 <span style=color:#4e9a06>&#39;{&#34;Addr&#34;:&#34;1.2.3.4&#34;,&#34;Metadata&#34;:&#34;...&#34;}&#39;</span>
</span></span><span style=display:flex><span><span style=color:#000>ETCDCTL_API</span><span style=color:#ce5c00;font-weight:700>=</span><span style=color:#0000cf;font-weight:700>3</span> etcdctl lease keep-alive <span style=color:#000>$lease</span>
</span></span></code></pre></div><p>In the golang:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#000>lease</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>_</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>client</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Grant</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TODO</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#000>ttl</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>em</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>endpoints</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>NewManager</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>client</span><span style=color:#000;font-weight:700>,</span> <span style=color:#4e9a06>&#34;foo/bar/my-service&#34;</span><span style=color:#000;font-weight:700>)</span>
</span></span><span style=display:flex><span><span style=color:#000>err</span> <span style=color:#ce5c00;font-weight:700>:=</span> <span style=color:#000>em</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>AddEndpoint</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>context</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>TODO</span><span style=color:#000;font-weight:700>(),</span> <span style=color:#4e9a06>&#34;foo/bar/my-service/e1&#34;</span><span style=color:#000;font-weight:700>,</span> <span style=color:#000>endpoints</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>Endpoint</span><span style=color:#000;font-weight:700>{</span><span style=color:#000>Addr</span><span style=color:#000;font-weight:700>:</span><span style=color:#4e9a06>&#34;1.2.3.4&#34;</span><span style=color:#000;font-weight:700>},</span> <span style=color:#000>clientv3</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>WithLease</span><span style=color:#000;font-weight:700>(</span><span style=color:#000>lease</span><span style=color:#000;font-weight:700>.</span><span style=color:#000>ID</span><span style=color:#000;font-weight:700>));</span>
</span></span></code></pre></div><h3 id=atomically-updating-endpoints>Atomically updating endpoints</h3><p>If it&rsquo;s desired to modify multiple endpoints in a single transaction, <code>endpoints.Manager</code> can be used directly:</p><pre tabindex=0><code>em := endpoints.NewManager(c, &#34;foo&#34;)

err := em.Update(context.TODO(), []*endpoints.UpdateWithOpts{
    endpoints.NewDeleteUpdateOpts(&#34;foo/bar/my-service/e1&#34;, endpoints.Endpoint{Addr: &#34;1.2.3.4&#34;}),
	endpoints.NewAddUpdateOpts(&#34;foo/bar/my-service/e1&#34;, endpoints.Endpoint{Addr: &#34;1.2.3.14&#34;})})
</code></pre><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p></div><br><div class=td-page-meta__lastmod>Last modified July 30, 2024: <a href=https://github.com/etcd-io/website/commit/468f4a10818d5c49d94553c3c8f43b2380c73afe>fix: update grpc_naming.md for using etcd discovery with go-grpc code example (468f4a1)</a></div></div></main></div></div></div></body></html>