<!doctype html><html itemscope itemtype=http://schema.org/WebPage lang=en class=no-js><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Upgrade etcd from 3.3 to 3.4 | etcd</title>
<meta name=description content="Processes, checklists, and notes on upgrading etcd from 3.3 to 3.4"><meta property="og:url" content="https://etcd.io/docs/v3.5/upgrades/upgrade_3_4/"><meta property="og:site_name" content="etcd"><meta property="og:title" content="Upgrade etcd from 3.3 to 3.4"><meta property="og:description" content="Processes, checklists, and notes on upgrading etcd from 3.3 to 3.4"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="article:section" content="docs"><meta property="article:modified_time" content="2023-09-29T15:10:20+13:00"><meta itemprop=name content="Upgrade etcd from 3.3 to 3.4"><meta itemprop=description content="Processes, checklists, and notes on upgrading etcd from 3.3 to 3.4"><meta itemprop=dateModified content="2023-09-29T15:10:20+13:00"><meta itemprop=wordCount content="2645"><meta name=twitter:card content="summary"><meta name=twitter:title content="Upgrade etcd from 3.3 to 3.4"><meta name=twitter:description content="Processes, checklists, and notes on upgrading etcd from 3.3 to 3.4"></head><body class=td-page><div class="container-fluid td-outer"><div class=td-main><div class="row flex-xl-nowrap"><main class="col-12 col-md-9 col-xl-8 ps-md-5" role=main><div class=td-content><h1>Upgrade etcd from 3.3 to 3.4</h1><div class=lead>Processes, checklists, and notes on upgrading etcd from 3.3 to 3.4</div><p>In the general case, upgrading from etcd 3.3 to 3.4 can be a zero-downtime, rolling upgrade:</p><ul><li>one by one, stop the etcd v3.3 processes and replace them with etcd v3.4 processes</li><li>after running all v3.4 processes, new features in v3.4 are available to the cluster</li></ul><p>Before <a href=#upgrade-procedure>starting an upgrade</a>, read through the rest of this guide to prepare.</p><h3 id=upgrade-checklists>Upgrade checklists</h3><p><strong>NOTE:</strong> When <a href=https://github.com/etcd-io/etcd/issues/9480 target=_blank rel=noopener>migrating from v2 with no v3 data</a>, etcd server v3.2+ panics when etcd restores from existing snapshots but no v3 <code>ETCD_DATA_DIR/member/snap/db</code> file. This happens when the server had migrated from v2 with no previous v3 data. This also prevents accidental v3 data loss (e.g. <code>db</code> file might have been moved). etcd requires that post v3 migration can only happen with v3 data. Do not upgrade to newer v3 versions until v3.0 server contains v3 data.</p><p>Highlighted breaking changes in 3.4.</p><h4 id=make-etcdctl_api3-etcdctl-default>Make <code>ETCDCTL_API=3 etcdctl</code> default</h4><p><code>ETCDCTL_API=3</code> is now the default.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>etcdctl set foo bar
</span></span><span style=display:flex><span>Error: unknown command &#34;set&#34; for &#34;etcdctl&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a40000>-etcdctl set foo bar
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+ETCDCTL_API=2 etcdctl set foo bar
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>bar
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ETCDCTL_API=3 etcdctl put foo bar
</span></span><span style=display:flex><span>OK
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a40000>-ETCDCTL_API=3 etcdctl put foo bar
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+etcdctl put foo bar
</span></span></span></code></pre></div><h4 id=make-etcd---enable-v2false-default>Make <code>etcd --enable-v2=false</code> default</h4><p><a href=https://github.com/etcd-io/etcd/pull/10935 target=_blank rel=noopener><code>etcd --enable-v2=false</code></a> is now the default.</p><p>This means, unless <code>etcd --enable-v2=true</code> is specified, etcd v3.4 server would not serve v2 API requests.</p><p>If v2 API were used, make sure to enable v2 API in v3.4:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a40000>-etcd
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+etcd --enable-v2=true
</span></span></span></code></pre></div><p>Other HTTP APIs will still work (e.g. <code>[CLIENT-URL]/metrics</code>, <code>[CLIENT-URL]/health</code>, v3 gRPC gateway).</p><h4 id=deprecated-etcd---ca-file-and-etcd---peer-ca-file-flags>Deprecated <code>etcd --ca-file</code> and <code>etcd --peer-ca-file</code> flags</h4><p><code>--ca-file</code> and <code>--peer-ca-file</code> flags are deprecated; they have been deprecated since v2.1.</p><p>Note setting this parameter will also automatically enable client cert authentication no matter what value is set for <code>--client-cert-auth</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a40000>-etcd --ca-file ca-client.crt
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+etcd --trusted-ca-file ca-client.crt
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a40000>-etcd --peer-ca-file ca-peer.crt
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+etcd --peer-trusted-ca-file ca-peer.crt
</span></span></span></code></pre></div><h4 id=deprecated-grpcerrclientconnclosing-error>Deprecated <code>grpc.ErrClientConnClosing</code> error</h4><p><code>grpc.ErrClientConnClosing</code> has been <a href=https://github.com/grpc/grpc-go/pull/1854 target=_blank rel=noopener>deprecated in gRPC >= 1.10</a>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>import (
</span></span><span style=display:flex><span><span style=color:#00a000>+	&#34;go.etcd.io/etcd/clientv3&#34;
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>
</span></span><span style=display:flex><span>	&#34;google.golang.org/grpc&#34;
</span></span><span style=display:flex><span><span style=color:#00a000>+	&#34;google.golang.org/grpc/codes&#34;
</span></span></span><span style=display:flex><span><span style=color:#00a000>+	&#34;google.golang.org/grpc/status&#34;
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>_, err := kvc.Get(ctx, &#34;a&#34;)
</span></span><span style=display:flex><span><span style=color:#a40000>-if err == grpc.ErrClientConnClosing {
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+if clientv3.IsConnCanceled(err) {
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>
</span></span><span style=display:flex><span>// or
</span></span><span style=display:flex><span><span style=color:#00a000>+s, ok := status.FromError(err)
</span></span></span><span style=display:flex><span><span style=color:#00a000>+if ok {
</span></span></span><span style=display:flex><span><span style=color:#00a000>+  if s.Code() == codes.Canceled
</span></span></span></code></pre></div><h4 id=require-grpcwithblock-for-client-dial>Require <code>grpc.WithBlock</code> for client dial</h4><p><a href=/docs/v3.5/learning/design-client/>The new client balancer</a> uses an asynchronous resolver to pass endpoints to the gRPC dial function. As a result, v3.4 client requires <code>grpc.WithBlock</code> dial option to wait until the underlying connection is up.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>import (
</span></span><span style=display:flex><span>	&#34;time&#34;
</span></span><span style=display:flex><span>	&#34;go.etcd.io/etcd/clientv3&#34;
</span></span><span style=display:flex><span><span style=color:#00a000>+	&#34;google.golang.org/grpc&#34;
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#00a000>+// &#34;grpc.WithBlock()&#34; to block until the underlying connection is up
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>ccfg := clientv3.Config{
</span></span><span style=display:flex><span>  Endpoints:            []string{&#34;localhost:2379&#34;},
</span></span><span style=display:flex><span>  DialTimeout:          time.Second,
</span></span><span style=display:flex><span><span style=color:#00a000>+ DialOptions:          []grpc.DialOption{grpc.WithBlock()},
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>  DialKeepAliveTime:    time.Second,
</span></span><span style=display:flex><span>  DialKeepAliveTimeout: 500 * time.Millisecond,
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=deprecating-etcd_debugging_mvcc_db_total_size_in_bytes-prometheus-metrics>Deprecating <code>etcd_debugging_mvcc_db_total_size_in_bytes</code> Prometheus metrics</h4><p>v3.4 promotes <code>etcd_debugging_mvcc_db_total_size_in_bytes</code> Prometheus metrics to <code>etcd_mvcc_db_total_size_in_bytes</code>, in order to encourage etcd storage monitoring.</p><p><code>etcd_debugging_mvcc_db_total_size_in_bytes</code> is still served in v3.4 for backward compatibilities. It will be completely deprecated in v3.5.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a40000>-etcd_debugging_mvcc_db_total_size_in_bytes
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+etcd_mvcc_db_total_size_in_bytes
</span></span></span></code></pre></div><p>Note that <code>etcd_debugging_*</code> namespace metrics have been marked as experimental. As we improve monitoring guide, we may promote more metrics.</p><h4 id=deprecating-etcd_debugging_mvcc_put_total-prometheus-metrics>Deprecating <code>etcd_debugging_mvcc_put_total</code> Prometheus metrics</h4><p>v3.4 promotes <code>etcd_debugging_mvcc_put_total</code> Prometheus metrics to <code>etcd_mvcc_put_total</code>, in order to encourage etcd storage monitoring.</p><p><code>etcd_debugging_mvcc_put_total</code> is still served in v3.4 for backward compatibilities. It will be completely deprecated in v3.5.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a40000>-etcd_debugging_mvcc_put_total
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+etcd_mvcc_put_total
</span></span></span></code></pre></div><p>Note that <code>etcd_debugging_*</code> namespace metrics have been marked as experimental. As we improve monitoring guide, we may promote more metrics.</p><h4 id=deprecating-etcd_debugging_mvcc_delete_total-prometheus-metrics>Deprecating <code>etcd_debugging_mvcc_delete_total</code> Prometheus metrics</h4><p>v3.4 promotes <code>etcd_debugging_mvcc_delete_total</code> Prometheus metrics to <code>etcd_mvcc_delete_total</code>, in order to encourage etcd storage monitoring.</p><p><code>etcd_debugging_mvcc_delete_total</code> is still served in v3.4 for backward compatibilities. It will be completely deprecated in v3.5.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a40000>-etcd_debugging_mvcc_delete_total
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+etcd_mvcc_delete_total
</span></span></span></code></pre></div><p>Note that <code>etcd_debugging_*</code> namespace metrics have been marked as experimental. As we improve monitoring guide, we may promote more metrics.</p><h4 id=deprecating-etcd_debugging_mvcc_txn_total-prometheus-metrics>Deprecating <code>etcd_debugging_mvcc_txn_total</code> Prometheus metrics</h4><p>v3.4 promotes <code>etcd_debugging_mvcc_txn_total</code> Prometheus metrics to <code>etcd_mvcc_txn_total</code>, in order to encourage etcd storage monitoring.</p><p><code>etcd_debugging_mvcc_txn_total</code> is still served in v3.4 for backward compatibilities. It will be completely deprecated in v3.5.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a40000>-etcd_debugging_mvcc_txn_total
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+etcd_mvcc_txn_total
</span></span></span></code></pre></div><p>Note that <code>etcd_debugging_*</code> namespace metrics have been marked as experimental. As we improve monitoring guide, we may promote more metrics.</p><h4 id=deprecating-etcd_debugging_mvcc_range_total-prometheus-metrics>Deprecating <code>etcd_debugging_mvcc_range_total</code> Prometheus metrics</h4><p>v3.4 promotes <code>etcd_debugging_mvcc_range_total</code> Prometheus metrics to <code>etcd_mvcc_range_total</code>, in order to encourage etcd storage monitoring.</p><p><code>etcd_debugging_mvcc_range_total</code> is still served in v3.4 for backward compatibilities. It will be completely deprecated in v3.5.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a40000>-etcd_debugging_mvcc_range_total
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+etcd_mvcc_range_total
</span></span></span></code></pre></div><p>Note that <code>etcd_debugging_*</code> namespace metrics have been marked as experimental. As we improve monitoring guide, we may promote more metrics.</p><h4 id=deprecating-etcd---log-output-flag-now---log-outputs>Deprecating <code>etcd --log-output</code> flag (now <code>--log-outputs</code>)</h4><p>Rename <a href=https://github.com/etcd-io/etcd/pull/9624 target=_blank rel=noopener><code>etcd --log-output</code> to <code>--log-outputs</code></a> to support multiple log outputs. <strong><code>etcd --logger=capnslog</code> does not support multiple log outputs.</strong></p><p><strong><code>etcd --log-output</code></strong> will be deprecated in v3.5. <strong><code>etcd --logger=capnslog</code> will be deprecated in v3.5</strong>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a40000>-etcd --log-output=stderr
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+etcd --log-outputs=stderr
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>
</span></span><span style=display:flex><span><span style=color:#00a000>+# to write logs to stderr and a.log file at the same time
</span></span></span><span style=display:flex><span><span style=color:#00a000>+# only &#34;--logger=zap&#34; supports multiple writers
</span></span></span><span style=display:flex><span><span style=color:#00a000>+etcd --logger=zap --log-outputs=stderr,a.log
</span></span></span></code></pre></div><p>v3.4 adds <code>etcd --logger=zap --log-outputs=stderr</code> support for structured logging and multiple log outputs. Main motivation is to promote automated etcd monitoring, rather than looking back server logs when it starts breaking. Future development will make etcd log as few as possible, and make etcd easier to monitor with metrics and alerts. <strong><code>etcd --logger=capnslog</code> will be deprecated in v3.5</strong>.</p><h4 id=changed-log-outputs-field-type-in-etcd---config-file-to-string>Changed <code>log-outputs</code> field type in <code>etcd --config-file</code> to <code>[]string</code></h4><p>Now that <code>log-outputs</code> (old field name <code>log-output</code>) accepts multiple writers, etcd configuration YAML file <code>log-outputs</code> field must be changed to <code>[]string</code> type as below:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span> # Specify &#39;stdout&#39; or &#39;stderr&#39; to skip journald logging even when running under systemd.
</span></span><span style=display:flex><span><span style=color:#a40000>-log-output: default
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+log-outputs: [default]
</span></span></span></code></pre></div><h4 id=renamed-embedconfiglogoutput-to-embedconfiglogoutputs>Renamed <code>embed.Config.LogOutput</code> to <code>embed.Config.LogOutputs</code></h4><p>Renamed <a href=https://github.com/etcd-io/etcd/pull/9624 target=_blank rel=noopener><strong><code>embed.Config.LogOutput</code></strong> to <strong><code>embed.Config.LogOutputs</code></strong></a> to support multiple log outputs. And changed <a href=https://github.com/etcd-io/etcd/pull/9579 target=_blank rel=noopener><code>embed.Config.LogOutput</code> type from <code>string</code> to <code>[]string</code></a> to support multiple log outputs.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>import &#34;github.com/coreos/etcd/embed&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cfg := &amp;embed.Config{Debug: false}
</span></span><span style=display:flex><span><span style=color:#a40000>-cfg.LogOutput = &#34;stderr&#34;
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+cfg.LogOutputs = []string{&#34;stderr&#34;}
</span></span></span></code></pre></div><h4 id=v35-deprecates-capnslog>v3.5 deprecates <code>capnslog</code></h4><p><strong>v3.5 will deprecate <code>etcd --log-package-levels</code> flag for <code>capnslog</code></strong>; <code>etcd --logger=zap --log-outputs=stderr</code> will the default. <strong>v3.5 will deprecate <code>[CLIENT-URL]/config/local/log</code> endpoint.</strong></p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a40000>-etcd
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+etcd --logger zap
</span></span></span></code></pre></div><h4 id=deprecating-etcd---debug-flag-now---log-leveldebug>Deprecating <code>etcd --debug</code> flag (now <code>--log-level=debug</code>)</h4><p>v3.4 deprecates <a href=https://github.com/etcd-io/etcd/pull/10947 target=_blank rel=noopener><code>etcd --debug</code></a> flag. Instead, use <code>etcd --log-level=debug</code> flag.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a40000>-etcd --debug
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+etcd --logger zap --log-level debug
</span></span></span></code></pre></div><h4 id=deprecated-pkgtransporttlsinfocafile-field>Deprecated <code>pkg/transport.TLSInfo.CAFile</code> field</h4><p>Deprecated <code>pkg/transport.TLSInfo.CAFile</code> field.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>import &#34;github.com/coreos/etcd/pkg/transport&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>tlsInfo := transport.TLSInfo{
</span></span><span style=display:flex><span>    CertFile: &#34;/tmp/test-certs/test.pem&#34;,
</span></span><span style=display:flex><span>    KeyFile: &#34;/tmp/test-certs/test-key.pem&#34;,
</span></span><span style=display:flex><span><span style=color:#a40000>-   CAFile: &#34;/tmp/test-certs/trusted-ca.pem&#34;,
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+   TrustedCAFile: &#34;/tmp/test-certs/trusted-ca.pem&#34;,
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>}
</span></span><span style=display:flex><span>tlsConfig, err := tlsInfo.ClientConfig()
</span></span><span style=display:flex><span>if err != nil {
</span></span><span style=display:flex><span>    panic(err)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h4 id=changed-embedconfigsnapcount-to-embedconfigsnapshotcount>Changed <code>embed.Config.SnapCount</code> to <code>embed.Config.SnapshotCount</code></h4><p>To be consistent with the flag name <code>etcd --snapshot-count</code>, <code>embed.Config.SnapCount</code> field has been renamed to <code>embed.Config.SnapshotCount</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>import &#34;github.com/coreos/etcd/embed&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cfg := embed.NewConfig()
</span></span><span style=display:flex><span><span style=color:#a40000>-cfg.SnapCount = 100000
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+cfg.SnapshotCount = 100000
</span></span></span></code></pre></div><h4 id=changed-etcdserverserverconfigsnapcount-to-etcdserverserverconfigsnapshotcount>Changed <code>etcdserver.ServerConfig.SnapCount</code> to <code>etcdserver.ServerConfig.SnapshotCount</code></h4><p>To be consistent with the flag name <code>etcd --snapshot-count</code>, <code>etcdserver.ServerConfig.SnapCount</code> field has been renamed to <code>etcdserver.ServerConfig.SnapshotCount</code>:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>import &#34;github.com/coreos/etcd/etcdserver&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>srvcfg := etcdserver.ServerConfig{
</span></span><span style=display:flex><span><span style=color:#a40000>-  SnapCount: 100000,
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+  SnapshotCount: 100000,
</span></span></span></code></pre></div><h4 id=changed-function-signature-in-package-wal>Changed function signature in package <code>wal</code></h4><p>Changed <code>wal</code> function signatures to support structured logger.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>import &#34;github.com/coreos/etcd/wal&#34;
</span></span><span style=display:flex><span><span style=color:#00a000>+import &#34;go.uber.org/zap&#34;
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>
</span></span><span style=display:flex><span><span style=color:#00a000>+lg, _ = zap.NewProduction()
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>
</span></span><span style=display:flex><span><span style=color:#a40000>-wal.Open(dirpath, snap)
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+wal.Open(lg, dirpath, snap)
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>
</span></span><span style=display:flex><span><span style=color:#a40000>-wal.OpenForRead(dirpath, snap)
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+wal.OpenForRead(lg, dirpath, snap)
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>
</span></span><span style=display:flex><span><span style=color:#a40000>-wal.Repair(dirpath)
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+wal.Repair(lg, dirpath)
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>
</span></span><span style=display:flex><span><span style=color:#a40000>-wal.Create(dirpath, metadata)
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+wal.Create(lg, dirpath, metadata)
</span></span></span></code></pre></div><h4 id=changed-intervaltree-type-in-package-pkgadt>Changed <code>IntervalTree</code> type in package <code>pkg/adt</code></h4><p><code>pkg/adt.IntervalTree</code> is now defined as an <code>interface</code>.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>import (
</span></span><span style=display:flex><span>    &#34;fmt&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    &#34;go.etcd.io/etcd/pkg/adt&#34;
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>func main() {
</span></span><span style=display:flex><span><span style=color:#a40000>-    ivt := &amp;adt.IntervalTree{}
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+    ivt := adt.NewIntervalTree()
</span></span></span></code></pre></div><h4 id=deprecated-embedconfigsetuplogging>Deprecated <code>embed.Config.SetupLogging</code></h4><p><code>embed.Config.SetupLogging</code> has been removed in order to prevent wrong logging configuration, and now set up automatically.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span>import &#34;github.com/coreos/etcd/embed&#34;
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>cfg := &amp;embed.Config{Debug: false}
</span></span><span style=display:flex><span><span style=color:#a40000>-cfg.SetupLogging()
</span></span></span></code></pre></div><h4 id=changed-grpc-gateway-http-endpoints-replaced-v3beta-with-v3>Changed gRPC gateway HTTP endpoints (replaced <code>/v3beta</code> with <code>/v3</code>)</h4><p>Before</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -L http://localhost:2379/v3beta/kv/put <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -X POST -d <span style=color:#4e9a06>&#39;{&#34;key&#34;: &#34;Zm9v&#34;, &#34;value&#34;: &#34;YmFy&#34;}&#39;</span>
</span></span></code></pre></div><p>After</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -L http://localhost:2379/v3/kv/put <span style=color:#4e9a06>\
</span></span></span><span style=display:flex><span><span style=color:#4e9a06></span>  -X POST -d <span style=color:#4e9a06>&#39;{&#34;key&#34;: &#34;Zm9v&#34;, &#34;value&#34;: &#34;YmFy&#34;}&#39;</span>
</span></span></code></pre></div><p>Requests to <code>/v3beta</code> endpoints will redirect to <code>/v3</code>, and <code>/v3beta</code> will be removed in 3.5 release.</p><h4 id=deprecated-container-image-tags>Deprecated container image tags</h4><p><code>latest</code> and minor version images tags are deprecated:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a40000>-docker pull gcr.io/etcd-development/etcd:latest
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+docker pull gcr.io/etcd-development/etcd:v3.4.0
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>
</span></span><span style=display:flex><span><span style=color:#a40000>-docker pull gcr.io/etcd-development/etcd:v3.4
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+docker pull gcr.io/etcd-development/etcd:v3.4.0
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>
</span></span><span style=display:flex><span><span style=color:#a40000>-docker pull gcr.io/etcd-development/etcd:v3.4
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+docker pull gcr.io/etcd-development/etcd:v3.4.1
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>
</span></span><span style=display:flex><span><span style=color:#a40000>-docker pull gcr.io/etcd-development/etcd:v3.4
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+docker pull gcr.io/etcd-development/etcd:v3.4.2
</span></span></span></code></pre></div><h3 id=server-upgrade-checklists>Server upgrade checklists</h3><h4 id=upgrade-requirements>Upgrade requirements</h4><p>To upgrade an existing etcd deployment to 3.4, the running cluster must be 3.3 or greater. If it&rsquo;s before 3.3, please <a href=../upgrade_3_3/>upgrade to 3.3</a> before upgrading to 3.4.</p><p>Also, to ensure a smooth rolling upgrade, the running cluster must be healthy. Check the health of the cluster by using the <code>etcdctl endpoint health</code> command before proceeding.</p><h4 id=preparation>Preparation</h4><p>Before upgrading etcd, always test the services relying on etcd in a staging environment before deploying the upgrade to the production environment.</p><p>Before beginning, <a href=../../op-guide/maintenance/#snapshot-backup>download the snapshot backup</a>. Should something go wrong with the upgrade, it is possible to use this backup to <a href=#downgrade>downgrade</a> back to existing etcd version. Please note that the <code>snapshot</code> command only backs up the v3 data. For v2 data, see <a href=/docs/v2.3/admin_guide/#backing-up-the-datastore>backing up v2 datastore</a>.</p><h4 id=mixed-versions>Mixed versions</h4><p>While upgrading, an etcd cluster supports mixed versions of etcd members, and operates with the protocol of the lowest common version. The cluster is only considered upgraded once all of its members are upgraded to version 3.4. Internally, etcd members negotiate with each other to determine the overall cluster version, which controls the reported version and the supported features.</p><h4 id=limitations>Limitations</h4><p>Note: If the cluster only has v3 data and no v2 data, it is not subject to this limitation.</p><p>If the cluster is serving a v2 data set larger than 50MB, each newly upgraded member may take up to two minutes to catch up with the existing cluster. Check the size of a recent snapshot to estimate the total data size. In other words, it is safest to wait for 2 minutes between upgrading each member.</p><p>For a much larger total data size, 100MB or more , this one-time process might take even more time. Administrators of very large etcd clusters of this magnitude can feel free to contact the <a href=https://groups.google.com/g/etcd-dev target=_blank rel=noopener>etcd team</a> before upgrading, and we&rsquo;ll be happy to provide advice on the procedure.</p><h4 id=downgrade>Downgrade</h4><p>If all members have been upgraded to v3.4, the cluster will be upgraded to v3.4, and downgrade from this completed state is <strong>not possible</strong>. If any single member is still v3.3, however, the cluster and its operations remains &ldquo;v3.3&rdquo;, and it is possible from this mixed cluster state to return to using a v3.3 etcd binary on all members.</p><p>Please <a href=../../op-guide/maintenance/#snapshot-backup>download the snapshot backup</a> to make downgrading the cluster possible even after it has been completely upgraded.</p><h3 id=upgrade-procedure>Upgrade procedure</h3><p>This example shows how to upgrade a 3-member v3.3 etcd cluster running on a local machine.</p><h4 id=step-1-check-upgrade-requirements>Step 1: check upgrade requirements</h4><p>Is the cluster healthy and running v3.3.x?</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>etcdctl --endpoints<span style=color:#ce5c00;font-weight:700>=</span>localhost:2379,localhost:22379,localhost:32379 endpoint health
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>localhost:2379 is healthy: successfully committed proposal: took = 2.118638ms
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>localhost:22379 is healthy: successfully committed proposal: took = 3.631388ms
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>localhost:32379 is healthy: successfully committed proposal: took = 2.157051ms
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl http://localhost:2379/version
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{&#34;etcdserver&#34;:&#34;3.3.5&#34;,&#34;etcdcluster&#34;:&#34;3.3.0&#34;}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl http://localhost:22379/version
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{&#34;etcdserver&#34;:&#34;3.3.5&#34;,&#34;etcdcluster&#34;:&#34;3.3.0&#34;}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl http://localhost:32379/version
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{&#34;etcdserver&#34;:&#34;3.3.5&#34;,&#34;etcdcluster&#34;:&#34;3.3.0&#34;}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span></code></pre></div><h4 id=step-2-download-snapshot-backup-from-leader>Step 2: download snapshot backup from leader</h4><p><a href=../../op-guide/maintenance/#snapshot-backup>Download the snapshot backup</a> to provide a downgrade path should any problems occur.</p><p>etcd leader is guaranteed to have the latest application data, thus fetch snapshot from leader:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>curl -sL http://localhost:2379/metrics <span style=color:#000;font-weight:700>|</span> grep etcd_server_is_leader
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06># HELP etcd_server_is_leader Whether or not this member is a leader. 1 if is, 0 otherwise.
</span></span></span><span style=display:flex><span><span style=color:#4e9a06># TYPE etcd_server_is_leader gauge
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>etcd_server_is_leader 1
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -sL http://localhost:22379/metrics <span style=color:#000;font-weight:700>|</span> grep etcd_server_is_leader
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>etcd_server_is_leader 0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl -sL http://localhost:32379/metrics <span style=color:#000;font-weight:700>|</span> grep etcd_server_is_leader
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>etcd_server_is_leader 0
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>etcdctl --endpoints<span style=color:#ce5c00;font-weight:700>=</span>localhost:2379 snapshot save backup.db
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{&#34;level&#34;:&#34;info&#34;,&#34;ts&#34;:1526585787.148433,&#34;caller&#34;:&#34;snapshot/v3_snapshot.go:109&#34;,&#34;msg&#34;:&#34;created temporary db file&#34;,&#34;path&#34;:&#34;backup.db.part&#34;}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{&#34;level&#34;:&#34;info&#34;,&#34;ts&#34;:1526585787.1485257,&#34;caller&#34;:&#34;snapshot/v3_snapshot.go:120&#34;,&#34;msg&#34;:&#34;fetching snapshot&#34;,&#34;endpoint&#34;:&#34;localhost:2379&#34;}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{&#34;level&#34;:&#34;info&#34;,&#34;ts&#34;:1526585787.1519694,&#34;caller&#34;:&#34;snapshot/v3_snapshot.go:133&#34;,&#34;msg&#34;:&#34;fetched snapshot&#34;,&#34;endpoint&#34;:&#34;localhost:2379&#34;,&#34;took&#34;:0.003502721}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{&#34;level&#34;:&#34;info&#34;,&#34;ts&#34;:1526585787.1520295,&#34;caller&#34;:&#34;snapshot/v3_snapshot.go:142&#34;,&#34;msg&#34;:&#34;saved&#34;,&#34;path&#34;:&#34;backup.db&#34;}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>Snapshot saved at backup.db
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span></code></pre></div><h4 id=step-3-stop-one-existing-etcd-server>Step 3: stop one existing etcd server</h4><p>When each etcd process is stopped, expected errors will be logged by other cluster members. This is normal since a cluster member connection has been (temporarily) broken:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>10.237579 I <span style=color:#000;font-weight:700>|</span> etcdserver: updating the cluster version from 3.0 to 3.3
</span></span><span style=display:flex><span>10.238315 N <span style=color:#000;font-weight:700>|</span> etcdserver/membership: updated the cluster version from 3.0 to 3.3
</span></span><span style=display:flex><span>10.238451 I <span style=color:#000;font-weight:700>|</span> etcdserver/api: enabled capabilities <span style=color:#204a87;font-weight:700>for</span> version 3.3
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>^C21.192174 N <span style=color:#000;font-weight:700>|</span> pkg/osutil: received interrupt signal, shutting down...
</span></span><span style=display:flex><span>21.192459 I <span style=color:#000;font-weight:700>|</span> etcdserver: 7339c4e5e833c029 starts leadership transfer from 7339c4e5e833c029 to 729934363faa4a24
</span></span><span style=display:flex><span>21.192569 I <span style=color:#000;font-weight:700>|</span> raft: 7339c4e5e833c029 <span style=color:#ce5c00;font-weight:700>[</span>term 8<span style=color:#ce5c00;font-weight:700>]</span> starts to transfer leadership to 729934363faa4a24
</span></span><span style=display:flex><span>21.192619 I <span style=color:#000;font-weight:700>|</span> raft: 7339c4e5e833c029 sends MsgTimeoutNow to 729934363faa4a24 immediately as 729934363faa4a24 already has up-to-date log
</span></span><span style=display:flex><span>WARNING: 2018/05/17 12:45:21 grpc: addrConn.resetTransport failed to create client transport: connection error: <span style=color:#000>desc</span> <span style=color:#ce5c00;font-weight:700>=</span> <span style=color:#4e9a06>&#34;transport: Error while dialing dial tcp: operation was canceled&#34;</span><span style=color:#000;font-weight:700>;</span> Reconnecting to <span style=color:#ce5c00;font-weight:700>{</span>localhost:2379 <span style=color:#0000cf;font-weight:700>0</span>  &lt;nil&gt;<span style=color:#ce5c00;font-weight:700>}</span>
</span></span><span style=display:flex><span>WARNING: 2018/05/17 12:45:21 grpc: addrConn.transportMonitor exits due to: grpc: the connection is closing
</span></span><span style=display:flex><span>21.193589 I <span style=color:#000;font-weight:700>|</span> raft: 7339c4e5e833c029 <span style=color:#ce5c00;font-weight:700>[</span>term: 8<span style=color:#ce5c00;font-weight:700>]</span> received a MsgVote message with higher term from 729934363faa4a24 <span style=color:#ce5c00;font-weight:700>[</span>term: 9<span style=color:#ce5c00;font-weight:700>]</span>
</span></span><span style=display:flex><span>21.193626 I <span style=color:#000;font-weight:700>|</span> raft: 7339c4e5e833c029 became follower at term <span style=color:#0000cf;font-weight:700>9</span>
</span></span><span style=display:flex><span>21.193651 I <span style=color:#000;font-weight:700>|</span> raft: 7339c4e5e833c029 <span style=color:#ce5c00;font-weight:700>[</span>logterm: 8, index: 9, vote: 0<span style=color:#ce5c00;font-weight:700>]</span> cast MsgVote <span style=color:#204a87;font-weight:700>for</span> 729934363faa4a24 <span style=color:#ce5c00;font-weight:700>[</span>logterm: 8, index: 9<span style=color:#ce5c00;font-weight:700>]</span> at term <span style=color:#0000cf;font-weight:700>9</span>
</span></span><span style=display:flex><span>21.193675 I <span style=color:#000;font-weight:700>|</span> raft: raft.node: 7339c4e5e833c029 lost leader 7339c4e5e833c029 at term <span style=color:#0000cf;font-weight:700>9</span>
</span></span><span style=display:flex><span>21.194424 I <span style=color:#000;font-weight:700>|</span> raft: raft.node: 7339c4e5e833c029 elected leader 729934363faa4a24 at term <span style=color:#0000cf;font-weight:700>9</span>
</span></span><span style=display:flex><span>21.292898 I <span style=color:#000;font-weight:700>|</span> etcdserver: 7339c4e5e833c029 finished leadership transfer from 7339c4e5e833c029 to 729934363faa4a24 <span style=color:#ce5c00;font-weight:700>(</span>took 100.436391ms<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>21.292975 I <span style=color:#000;font-weight:700>|</span> rafthttp: stopping peer 729934363faa4a24...
</span></span><span style=display:flex><span>21.293206 I <span style=color:#000;font-weight:700>|</span> rafthttp: closed the TCP streaming connection with peer 729934363faa4a24 <span style=color:#ce5c00;font-weight:700>(</span>stream MsgApp v2 writer<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>21.293225 I <span style=color:#000;font-weight:700>|</span> rafthttp: stopped streaming with peer 729934363faa4a24 <span style=color:#ce5c00;font-weight:700>(</span>writer<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>21.293437 I <span style=color:#000;font-weight:700>|</span> rafthttp: closed the TCP streaming connection with peer 729934363faa4a24 <span style=color:#ce5c00;font-weight:700>(</span>stream Message writer<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>21.293459 I <span style=color:#000;font-weight:700>|</span> rafthttp: stopped streaming with peer 729934363faa4a24 <span style=color:#ce5c00;font-weight:700>(</span>writer<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>21.293514 I <span style=color:#000;font-weight:700>|</span> rafthttp: stopped HTTP pipelining with peer 729934363faa4a24
</span></span><span style=display:flex><span>21.293590 W <span style=color:#000;font-weight:700>|</span> rafthttp: lost the TCP streaming connection with peer 729934363faa4a24 <span style=color:#ce5c00;font-weight:700>(</span>stream MsgApp v2 reader<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>21.293610 I <span style=color:#000;font-weight:700>|</span> rafthttp: stopped streaming with peer 729934363faa4a24 <span style=color:#ce5c00;font-weight:700>(</span>stream MsgApp v2 reader<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>21.293680 W <span style=color:#000;font-weight:700>|</span> rafthttp: lost the TCP streaming connection with peer 729934363faa4a24 <span style=color:#ce5c00;font-weight:700>(</span>stream Message reader<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>21.293700 I <span style=color:#000;font-weight:700>|</span> rafthttp: stopped streaming with peer 729934363faa4a24 <span style=color:#ce5c00;font-weight:700>(</span>stream Message reader<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>21.293711 I <span style=color:#000;font-weight:700>|</span> rafthttp: stopped peer 729934363faa4a24
</span></span><span style=display:flex><span>21.293720 I <span style=color:#000;font-weight:700>|</span> rafthttp: stopping peer b548c2511513015...
</span></span><span style=display:flex><span>21.293987 I <span style=color:#000;font-weight:700>|</span> rafthttp: closed the TCP streaming connection with peer b548c2511513015 <span style=color:#ce5c00;font-weight:700>(</span>stream MsgApp v2 writer<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>21.294063 I <span style=color:#000;font-weight:700>|</span> rafthttp: stopped streaming with peer b548c2511513015 <span style=color:#ce5c00;font-weight:700>(</span>writer<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>21.294467 I <span style=color:#000;font-weight:700>|</span> rafthttp: closed the TCP streaming connection with peer b548c2511513015 <span style=color:#ce5c00;font-weight:700>(</span>stream Message writer<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>21.294561 I <span style=color:#000;font-weight:700>|</span> rafthttp: stopped streaming with peer b548c2511513015 <span style=color:#ce5c00;font-weight:700>(</span>writer<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>21.294742 I <span style=color:#000;font-weight:700>|</span> rafthttp: stopped HTTP pipelining with peer b548c2511513015
</span></span><span style=display:flex><span>21.294867 W <span style=color:#000;font-weight:700>|</span> rafthttp: lost the TCP streaming connection with peer b548c2511513015 <span style=color:#ce5c00;font-weight:700>(</span>stream MsgApp v2 reader<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>21.294892 I <span style=color:#000;font-weight:700>|</span> rafthttp: stopped streaming with peer b548c2511513015 <span style=color:#ce5c00;font-weight:700>(</span>stream MsgApp v2 reader<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>21.294990 W <span style=color:#000;font-weight:700>|</span> rafthttp: lost the TCP streaming connection with peer b548c2511513015 <span style=color:#ce5c00;font-weight:700>(</span>stream Message reader<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>21.295004 E <span style=color:#000;font-weight:700>|</span> rafthttp: failed to <span style=color:#204a87>read</span> b548c2511513015 on stream Message <span style=color:#ce5c00;font-weight:700>(</span>context canceled<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>21.295013 I <span style=color:#000;font-weight:700>|</span> rafthttp: peer b548c2511513015 became inactive
</span></span><span style=display:flex><span>21.295024 I <span style=color:#000;font-weight:700>|</span> rafthttp: stopped streaming with peer b548c2511513015 <span style=color:#ce5c00;font-weight:700>(</span>stream Message reader<span style=color:#ce5c00;font-weight:700>)</span>
</span></span><span style=display:flex><span>21.295035 I <span style=color:#000;font-weight:700>|</span> rafthttp: stopped peer b548c2511513015
</span></span></code></pre></div><h4 id=step-4-restart-the-etcd-server-with-same-configuration>Step 4: restart the etcd server with same configuration</h4><p>Restart the etcd server with same configuration but with the new etcd binary.</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-diff data-lang=diff><span style=display:flex><span><span style=color:#a40000>-etcd-old --name s1 \
</span></span></span><span style=display:flex><span><span style=color:#a40000></span><span style=color:#00a000>+etcd-new --name s1 \
</span></span></span><span style=display:flex><span><span style=color:#00a000></span>  --data-dir /tmp/etcd/s1 \
</span></span><span style=display:flex><span>  --listen-client-urls http://localhost:2379 \
</span></span><span style=display:flex><span>  --advertise-client-urls http://localhost:2379 \
</span></span><span style=display:flex><span>  --listen-peer-urls http://localhost:2380 \
</span></span><span style=display:flex><span>  --initial-advertise-peer-urls http://localhost:2380 \
</span></span><span style=display:flex><span>  --initial-cluster s1=http://localhost:2380,s2=http://localhost:22380,s3=http://localhost:32380 \
</span></span><span style=display:flex><span>  --initial-cluster-token tkn \
</span></span><span style=display:flex><span><span style=color:#00a000>+ --initial-cluster-state new \
</span></span></span><span style=display:flex><span><span style=color:#00a000>+ --logger zap \
</span></span></span><span style=display:flex><span><span style=color:#00a000>+ --log-outputs stderr
</span></span></span></code></pre></div><p>The new v3.4 etcd will publish its information to the cluster. At this point, cluster still operates as v3.3 protocol, which is the lowest common version.</p><blockquote><p><code>{"level":"info","ts":1526586617.1647713,"caller":"membership/cluster.go:485","msg":"set initial cluster version","cluster-id":"7dee9ba76d59ed53","local-member-id":"7339c4e5e833c029","cluster-version":"3.0"}</code></p></blockquote><blockquote><p><code>{"level":"info","ts":1526586617.1648536,"caller":"api/capability.go:76","msg":"enabled capabilities for version","cluster-version":"3.0"}</code></p></blockquote><blockquote><p><code>{"level":"info","ts":1526586617.1649303,"caller":"membership/cluster.go:473","msg":"updated cluster version","cluster-id":"7dee9ba76d59ed53","local-member-id":"7339c4e5e833c029","from":"3.0","from":"3.3"}</code></p></blockquote><blockquote><p><code>{"level":"info","ts":1526586617.1649797,"caller":"api/capability.go:76","msg":"enabled capabilities for version","cluster-version":"3.3"}</code></p></blockquote><blockquote><p><code>{"level":"info","ts":1526586617.2107732,"caller":"etcdserver/server.go:1770","msg":"published local member to cluster through raft","local-member-id":"7339c4e5e833c029","local-member-attributes":"{Name:s1 ClientURLs:[http://localhost:2379]}","request-path":"/0/members/7339c4e5e833c029/attributes","cluster-id":"7dee9ba76d59ed53","publish-timeout":7}</code></p></blockquote><p>Verify that each member, and then the entire cluster, becomes healthy with the new v3.4 etcd binary:</p><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>etcdctl endpoint health --endpoints<span style=color:#ce5c00;font-weight:700>=</span>localhost:2379,localhost:22379,localhost:32379
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>localhost:32379 is healthy: successfully committed proposal: took = 2.337471ms
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>localhost:22379 is healthy: successfully committed proposal: took = 1.130717ms
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>localhost:2379 is healthy: successfully committed proposal: took = 2.124843ms
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span></code></pre></div><p>Un-upgraded members will log warnings like the following until the entire cluster is upgraded.</p><p>This is expected and will cease after all etcd cluster members are upgraded to v3.4:</p><pre tabindex=0><code>:41.942121 W | etcdserver: member 7339c4e5e833c029 has a higher version 3.4.0
:45.945154 W | etcdserver: the local etcd version 3.3.5 is not up-to-date
</code></pre><h4 id=step-5-repeat-step-3-and-step-4-for-rest-of-the-members>Step 5: repeat <em>step 3</em> and <em>step 4</em> for rest of the members</h4><p>When all members are upgraded, the cluster will report upgrading to 3.4 successfully:</p><p>Member 1:</p><blockquote><p><code>{"level":"info","ts":1526586949.0920913,"caller":"api/capability.go:76","msg":"enabled capabilities for version","cluster-version":"3.4"}</code>
<code>{"level":"info","ts":1526586949.0921566,"caller":"etcdserver/server.go:2272","msg":"cluster version is updated","cluster-version":"3.4"}</code></p></blockquote><p>Member 2:</p><blockquote><p><code>{"level":"info","ts":1526586949.092117,"caller":"membership/cluster.go:473","msg":"updated cluster version","cluster-id":"7dee9ba76d59ed53","local-member-id":"729934363faa4a24","from":"3.3","from":"3.4"}</code>
<code>{"level":"info","ts":1526586949.0923078,"caller":"api/capability.go:76","msg":"enabled capabilities for version","cluster-version":"3.4"}</code></p></blockquote><p>Member 3:</p><blockquote><p><code>{"level":"info","ts":1526586949.0921423,"caller":"membership/cluster.go:473","msg":"updated cluster version","cluster-id":"7dee9ba76d59ed53","local-member-id":"b548c2511513015","from":"3.3","from":"3.4"}</code>
<code>{"level":"info","ts":1526586949.0922918,"caller":"api/capability.go:76","msg":"enabled capabilities for version","cluster-version":"3.4"}</code></p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>endpoint health --endpoints<span style=color:#ce5c00;font-weight:700>=</span>localhost:2379,localhost:22379,localhost:32379
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>localhost:2379 is healthy: successfully committed proposal: took = 492.834s
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>localhost:22379 is healthy: successfully committed proposal: took = 1.015025ms
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>localhost:32379 is healthy: successfully committed proposal: took = 1.853077ms
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl http://localhost:2379/version
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{&#34;etcdserver&#34;:&#34;3.4.0&#34;,&#34;etcdcluster&#34;:&#34;3.4.0&#34;}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl http://localhost:22379/version
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{&#34;etcdserver&#34;:&#34;3.4.0&#34;,&#34;etcdcluster&#34;:&#34;3.4.0&#34;}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>curl http://localhost:32379/version
</span></span><span style=display:flex><span><span style=color:#4e9a06>&lt;&lt;COMMENT
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>{&#34;etcdserver&#34;:&#34;3.4.0&#34;,&#34;etcdcluster&#34;:&#34;3.4.0&#34;}
</span></span></span><span style=display:flex><span><span style=color:#4e9a06>COMMENT</span>
</span></span></code></pre></div><div class=d-print-none><h2 class=feedback--title>Feedback</h2><p class=feedback--question>Was this page helpful?</p><button class="btn btn-primary mb-4 feedback--answer feedback--answer-yes">Yes</button>
<button class="btn btn-primary mb-4 feedback--answer feedback--answer-no">No</button><p class="feedback--response feedback--response-yes">Glad to hear it! Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p><p class="feedback--response feedback--response-no">Sorry to hear that. Please <a href=https://github.com/etcd-io/website/issues/new>tell us how we can improve</a>.</p></div><br><div class=td-page-meta__lastmod>Last modified September 29, 2023: <a href=https://github.com/etcd-io/website/commit/a412dd6efc552aa382fb584c7d625122ad8a91fe>Added note that --trusted-ca-file also enables client cert authentication Co-authored-by: James Blair &lt;mail@jamesblair.net> (a412dd6)</a></div></div></main></div></div></div></body></html>